{
  "name": "ESVA_Tool_Obtener_Ubicacion",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "id": "workflow-trigger",
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [0, 300]
    },
    {
      "parameters": {
        "jsCode": "// ===========================================\n// ESVA Tool: Obtener Ubicacion\n// Version: 2.0 - Actualizado con datos reales\n// Fecha: Diciembre 2024\n// ===========================================\n\nconst sucursal = ($input.item.json.sucursal || '').toLowerCase().trim();\nconst leadPhone = $input.item.json.lead_phone || null;\n\n// ============================================\n// BASE DE DATOS DE SUCURSALES - DATOS REALES\n// ============================================\nconst sucursales = {\n  'nogales': {\n    id: 'b0000000-0000-0000-0000-000000000001',\n    nombre: 'ESVA Nogales',\n    nombre_corto: 'Nogales',\n    ciudad: 'Heroica Nogales, Sonora',\n    pais: 'Mexico',\n    // DIRECCION REAL\n    direccion: 'Av. Alvaro Obregon 1228',\n    colonia: 'Bolivar',\n    codigo_postal: '84060',\n    direccion_completa: 'Av. Alvaro Obregon 1228, Bolivar, 84060 Heroica Nogales, Sonora',\n    // TELEFONO REAL (USA)\n    telefono: '+1 520-619-9380',\n    telefono_display: '+1 (520) 619-9380',\n    es_usa: true,\n    // COORDENADAS EXACTAS\n    coordenadas: {\n      latitude: 31.310517734650443,\n      longitude: -110.94434054576938\n    },\n    // URLs de mapas\n    googleMapsUrl: 'https://maps.google.com/?q=31.310517734650443,-110.94434054576938',\n    appleMapsUrl: 'https://maps.apple.com/?ll=31.310517734650443,-110.94434054576938',\n    wazeUrl: 'https://waze.com/ul?ll=31.310517734650443,-110.94434054576938&navigate=yes',\n    // Horarios\n    horarios: {\n      lunes_viernes: '9:30 AM - 6:00 PM',\n      sabado: '10:00 AM - 2:00 PM',\n      domingo: 'Cerrado'\n    },\n    // Caracteristicas\n    caracteristicas: [\n      'Sucursal principal',\n      'A 5 minutos de la frontera con Arizona',\n      'Ideal para pacientes de USA',\n      'Estacionamiento gratuito',\n      'Aceptamos dolares'\n    ],\n    es_headquarters: true,\n    timezone: 'America/Hermosillo'\n  },\n  'hermosillo': {\n    id: 'b0000000-0000-0000-0000-000000000003',\n    nombre: 'ESVA Hermosillo',\n    nombre_corto: 'Hermosillo',\n    ciudad: 'Hermosillo, Sonora',\n    pais: 'Mexico',\n    // DIRECCION REAL\n    direccion: 'C. Gral. Juan Garcia Cabral 139',\n    colonia: 'Periodista',\n    codigo_postal: '83156',\n    direccion_completa: 'C. Gral. Juan Garcia Cabral 139, Periodista, 83156 Hermosillo, Sonora',\n    // TELEFONO REAL (Mexico)\n    telefono: '+52 662-464-9887',\n    telefono_display: '+52 (662) 464-9887',\n    es_usa: false,\n    // COORDENADAS EXACTAS\n    coordenadas: {\n      latitude: 29.108756608148557,\n      longitude: -110.94797149188004\n    },\n    // URLs de mapas\n    googleMapsUrl: 'https://maps.google.com/?q=29.108756608148557,-110.94797149188004',\n    appleMapsUrl: 'https://maps.apple.com/?ll=29.108756608148557,-110.94797149188004',\n    wazeUrl: 'https://waze.com/ul?ll=29.108756608148557,-110.94797149188004&navigate=yes',\n    // Horarios\n    horarios: {\n      lunes_viernes: '9:30 AM - 6:00 PM',\n      sabado: '10:00 AM - 2:00 PM',\n      domingo: 'Cerrado'\n    },\n    // Caracteristicas\n    caracteristicas: [\n      'Ubicacion centrica',\n      'Facil acceso',\n      'Estacionamiento disponible'\n    ],\n    es_headquarters: false,\n    timezone: 'America/Hermosillo'\n  }\n  // NOTA: Tijuana se agregara cuando tengan la direccion\n};\n\n// ============================================\n// FUNCION: Construir mensaje de texto\n// ============================================\nfunction buildTextMessage(data, tipo) {\n  if (tipo === 'todas') {\n    return `Nuestras sucursales ESVA:\n\nESVA NOGALES (Principal)\n${data.nogales.direccion_completa}\nTel: ${data.nogales.telefono_display}\nA 5 minutos de la frontera con Arizona - ideal para pacientes de USA\n\nESVA HERMOSILLO\n${data.hermosillo.direccion_completa}\nTel: ${data.hermosillo.telefono_display}\n\nHorarios (todas las sucursales):\nLun-Vie: 9:30 AM - 6:00 PM\nSabado: 10:00 AM - 2:00 PM\nDomingo: Cerrado\n\nQue sucursal le queda mejor para su cita de valoracion?`;\n  }\n  \n  // Mensaje para sucursal especifica\n  let msg = `${data.nombre}\\n\\n`;\n  msg += `Direccion:\\n${data.direccion_completa}\\n\\n`;\n  msg += `Telefono: ${data.telefono_display}\\n\\n`;\n  msg += `Horarios:\\n`;\n  msg += `Lun-Vie: ${data.horarios.lunes_viernes}\\n`;\n  msg += `Sabado: ${data.horarios.sabado}\\n`;\n  msg += `Domingo: ${data.horarios.domingo}\\n\\n`;\n  \n  if (data.caracteristicas && data.caracteristicas.length > 0) {\n    msg += data.caracteristicas.join(' | ');\n  }\n  \n  msg += `\\n\\nLe enviare la ubicacion exacta en seguida para que pueda llegar facilmente.`;\n  \n  return msg;\n}\n\n// ============================================\n// LOGICA PRINCIPAL\n// ============================================\n\n// Aliases para busqueda flexible\nconst aliases = {\n  'nogales': 'nogales',\n  'noga': 'nogales',\n  'frontera': 'nogales',\n  'arizona': 'nogales',\n  'usa': 'nogales',\n  'hermosillo': 'hermosillo',\n  'hillo': 'hermosillo',\n  'hmo': 'hermosillo'\n};\n\n// Resolver alias\nconst sucursalKey = aliases[sucursal] || sucursal;\n\n// Caso 1: Todas las sucursales\nif (!sucursal || sucursal === 'todas' || sucursal === 'all' || sucursal === 'ambas') {\n  const mensaje = buildTextMessage(sucursales, 'todas');\n  \n  return {\n    json: {\n      success: true,\n      tipo: 'todas',\n      message: mensaje,\n      sucursales: Object.values(sucursales).map(s => ({\n        id: s.id,\n        nombre: s.nombre,\n        nombre_corto: s.nombre_corto,\n        direccion_completa: s.direccion_completa,\n        telefono: s.telefono,\n        coordenadas: s.coordenadas,\n        googleMapsUrl: s.googleMapsUrl\n      })),\n      // Para WhatsApp: enviar ambas ubicaciones\n      locations_to_send: [\n        {\n          latitude: sucursales.nogales.coordenadas.latitude,\n          longitude: sucursales.nogales.coordenadas.longitude,\n          name: sucursales.nogales.nombre,\n          address: sucursales.nogales.direccion_completa\n        },\n        {\n          latitude: sucursales.hermosillo.coordenadas.latitude,\n          longitude: sucursales.hermosillo.coordenadas.longitude,\n          name: sucursales.hermosillo.nombre,\n          address: sucursales.hermosillo.direccion_completa\n        }\n      ]\n    }\n  };\n}\n\n// Caso 2: Sucursal especifica\nconst sucursalData = sucursales[sucursalKey];\n\nif (!sucursalData) {\n  return {\n    json: {\n      success: false,\n      error: 'sucursal_no_encontrada',\n      message: `No encontre la sucursal \"${sucursal}\". Actualmente tenemos sucursales en Nogales y Hermosillo. Cual le queda mejor?`,\n      available: ['Nogales', 'Hermosillo'],\n      send_location: false\n    }\n  };\n}\n\n// Construir respuesta con datos completos\nconst mensaje = buildTextMessage(sucursalData, 'especifica');\n\nreturn {\n  json: {\n    success: true,\n    tipo: 'especifica',\n    message: mensaje,\n    sucursal: {\n      id: sucursalData.id,\n      nombre: sucursalData.nombre,\n      nombre_corto: sucursalData.nombre_corto,\n      direccion: sucursalData.direccion,\n      direccion_completa: sucursalData.direccion_completa,\n      colonia: sucursalData.colonia,\n      codigo_postal: sucursalData.codigo_postal,\n      ciudad: sucursalData.ciudad,\n      telefono: sucursalData.telefono,\n      telefono_display: sucursalData.telefono_display,\n      es_usa: sucursalData.es_usa,\n      horarios: sucursalData.horarios,\n      caracteristicas: sucursalData.caracteristicas,\n      es_headquarters: sucursalData.es_headquarters\n    },\n    // DATOS PARA ENVIAR WHATSAPP LOCATION\n    // El Handler principal usara estos datos para enviar Location nativo\n    location_to_send: {\n      latitude: sucursalData.coordenadas.latitude,\n      longitude: sucursalData.coordenadas.longitude,\n      name: sucursalData.nombre,\n      address: sucursalData.direccion_completa\n    },\n    // URLs alternativas\n    map_urls: {\n      google: sucursalData.googleMapsUrl,\n      apple: sucursalData.appleMapsUrl,\n      waze: sucursalData.wazeUrl\n    },\n    // Flag para indicar que se debe enviar location\n    send_location: true\n  }\n};"
      },
      "id": "get-location",
      "name": "Get Location",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 300]
    },
    {
      "parameters": {
        "content": "## ESVA Tool: Obtener Ubicacion v2.0\n\n**ACTUALIZADO** con datos reales de ESVA\n\n**Funcion:** Retorna ubicacion de sucursales con soporte para WhatsApp Location nativo\n\n**Inputs:**\n- sucursal: 'nogales', 'hermosillo', 'todas' o vacio\n- lead_phone: (opcional) para logging\n\n**Output incluye:**\n- message: Texto formateado para chat\n- location_to_send: Coordenadas para WhatsApp Location\n- map_urls: Links a Google/Apple/Waze Maps\n- send_location: Flag para enviar ubicacion\n\n**Sucursales activas:**\n1. ESVA Nogales\n   Av. Alvaro Obregon 1228, Bolivar, 84060\n   +1 520-619-9380\n   Coords: 31.310517, -110.944340\n\n2. ESVA Hermosillo\n   C. Gral. Juan Garcia Cabral 139, Periodista, 83156\n   +52 662-464-9887\n   Coords: 29.108756, -110.947971\n\n**IMPORTANTE:** El Handler principal debe usar 'location_to_send' para enviar WhatsApp Location (mejor UX en iPhones)",
        "height": 520,
        "width": 380,
        "color": 2
      },
      "id": "sticky-note",
      "name": "Documentation",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-420, 80]
    }
  ],
  "connections": {
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Get Location",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateId": "esva-tool-obtener-ubicacion-v2"
  },
  "tags": [
    {"name": "ESVA"},
    {"name": "Tool"},
    {"name": "Location"}
  ]
}
