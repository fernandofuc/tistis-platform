# 3.4 Dashboard - Drift Monitoring

## DescripciÃ³n General

El dashboard de Drift Monitoring proporciona visualizaciÃ³n en tiempo real del estado del sistema de AI Learning, mostrando mÃ©tricas de drift, alertas activas, tendencias histÃ³ricas y recomendaciones de acciÃ³n.

## DiseÃ±o de UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Learning Drift Monitor                                    [Settings] ğŸ”” â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Overall      â”‚ â”‚ Active       â”‚ â”‚ Last         â”‚ â”‚ Trend        â”‚       â”‚
â”‚  â”‚ Health       â”‚ â”‚ Alerts       â”‚ â”‚ Analysis     â”‚ â”‚ (7 days)     â”‚       â”‚
â”‚  â”‚   ğŸŸ¢ 95%     â”‚ â”‚    3 ğŸ”´      â”‚ â”‚ 2h ago       â”‚ â”‚   â†˜ -15%     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    DRIFT TIMELINE                                       â”‚ â”‚
â”‚  â”‚  â–²                                                                      â”‚ â”‚
â”‚  â”‚  â”‚    â•­â”€â”€â•®                   â•­â”€â•®                                       â”‚ â”‚
â”‚  â”‚  â”‚   â•±    â•²    â•­â•®           â•±   â•²      â•­â”€â”€â•®                            â”‚ â”‚
â”‚  â”‚  â”‚â”€â”€â•±â”€â”€â”€â”€â”€â”€â•²â”€â”€â•±â”€â”€â•²â”€â”€â”€â”€â”€â”€â”€â”€â”€â•±â”€â”€â”€â”€â”€â•²â”€â”€â”€â”€â•±â”€â”€â”€â”€â•²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â–¶            â”‚ â”‚
â”‚  â”‚    Mon  Tue  Wed  Thu  Fri  Sat  Sun  Mon  Tue  Wed  Thu              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚     INPUT DRIFT                  â”‚ â”‚     OUTPUT DRIFT                   â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚â”‚
â”‚  â”‚  â”‚ Message Length    ğŸŸ¢ OK   â”‚  â”‚ â”‚  â”‚ Confidence       ğŸŸ¡ LOW   â”‚     â”‚â”‚
â”‚  â”‚  â”‚ Intent Dist.      ğŸŸ¡ LOW  â”‚  â”‚ â”‚  â”‚ Action Dist.     ğŸŸ¢ OK    â”‚     â”‚â”‚
â”‚  â”‚  â”‚ Vocabulary        ğŸŸ¢ OK   â”‚  â”‚ â”‚  â”‚ Escalation Rate  ğŸŸ¢ OK    â”‚     â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ACTIVE ALERTS                                            [View All â†’] â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ ğŸ”´ CRITICAL  intent_distribution  PSI: 0.34  2h ago  [Ack] [â†’] â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ ğŸŸ  HIGH      confidence_score     KS: 0.18   5h ago  [Ack] [â†’] â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ ğŸŸ¡ MEDIUM    p95_latency          +15ms      1d ago  [Ack] [â†’] â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Componentes React

### Dashboard Principal

```typescript
// components/ai-learning/drift/drift-dashboard.tsx

'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { HealthIndicator } from './health-indicator';
import { DriftTimeline } from './drift-timeline';
import { MetricCard } from './metric-card';
import { AlertsList } from './alerts-list';
import { DriftDetails } from './drift-details';
import { useDriftData } from '@/hooks/use-drift-data';
import {
  Activity,
  AlertTriangle,
  Clock,
  TrendingDown,
  TrendingUp,
  Settings,
  Bell,
  RefreshCw,
} from 'lucide-react';

export function DriftDashboard() {
  const {
    summary,
    alerts,
    inputMetrics,
    outputMetrics,
    performanceMetrics,
    timeline,
    isLoading,
    refresh,
    lastUpdated,
  } = useDriftData();

  const [selectedMetric, setSelectedMetric] = useState<string | null>(null);
  const [autoRefresh, setAutoRefresh] = useState(true);

  // Auto-refresh cada 5 minutos
  useEffect(() => {
    if (!autoRefresh) return;

    const interval = setInterval(refresh, 5 * 60 * 1000);
    return () => clearInterval(interval);
  }, [autoRefresh, refresh]);

  const getTrendIcon = (trend: string) => {
    switch (trend) {
      case 'increasing':
        return <TrendingUp className="h-4 w-4 text-red-500" />;
      case 'decreasing':
        return <TrendingDown className="h-4 w-4 text-green-500" />;
      default:
        return <Activity className="h-4 w-4 text-gray-500" />;
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">AI Learning Drift Monitor</h1>
          <p className="text-sm text-muted-foreground">
            Last updated: {lastUpdated?.toLocaleString() || 'Never'}
          </p>
        </div>
        <div className="flex items-center gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={refresh}
            disabled={isLoading}
          >
            <RefreshCw className={`h-4 w-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />
            Refresh
          </Button>
          <Button variant="outline" size="icon">
            <Settings className="h-4 w-4" />
          </Button>
          <Button variant="outline" size="icon" className="relative">
            <Bell className="h-4 w-4" />
            {summary?.open > 0 && (
              <span className="absolute -top-1 -right-1 h-4 w-4 bg-red-500 rounded-full text-[10px] text-white flex items-center justify-center">
                {summary.open}
              </span>
            )}
          </Button>
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid gap-4 md:grid-cols-4">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Overall Health</CardTitle>
            <Activity className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <HealthIndicator
              score={calculateHealthScore(summary)}
              size="lg"
            />
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Active Alerts</CardTitle>
            <AlertTriangle className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{summary?.open || 0}</div>
            <div className="flex gap-2 mt-1">
              {summary?.bySeverity.critical > 0 && (
                <Badge variant="destructive" className="text-xs">
                  {summary.bySeverity.critical} critical
                </Badge>
              )}
              {summary?.bySeverity.high > 0 && (
                <Badge variant="destructive" className="text-xs opacity-75">
                  {summary.bySeverity.high} high
                </Badge>
              )}
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Last Analysis</CardTitle>
            <Clock className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {formatTimeAgo(lastUpdated)}
            </div>
            <p className="text-xs text-muted-foreground">
              Next: {formatNextRun(lastUpdated)}
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">7-Day Trend</CardTitle>
            {getTrendIcon(summary?.recentTrend || 'stable')}
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold flex items-center gap-2">
              {summary?.recentTrend === 'increasing' ? '+' : summary?.recentTrend === 'decreasing' ? '-' : ''}
              {calculateTrendPercentage(timeline)}%
            </div>
            <p className="text-xs text-muted-foreground">
              vs previous week
            </p>
          </CardContent>
        </Card>
      </div>

      {/* Timeline */}
      <Card>
        <CardHeader>
          <CardTitle>Drift Timeline</CardTitle>
        </CardHeader>
        <CardContent>
          <DriftTimeline data={timeline} onSelectPoint={setSelectedMetric} />
        </CardContent>
      </Card>

      {/* Metrics Tabs */}
      <Tabs defaultValue="input" className="space-y-4">
        <TabsList>
          <TabsTrigger value="input">Input Drift</TabsTrigger>
          <TabsTrigger value="output">Output Drift</TabsTrigger>
          <TabsTrigger value="performance">Performance Drift</TabsTrigger>
        </TabsList>

        <TabsContent value="input" className="space-y-4">
          <div className="grid gap-4 md:grid-cols-3">
            {inputMetrics?.map((metric) => (
              <MetricCard
                key={metric.name}
                metric={metric}
                onClick={() => setSelectedMetric(metric.name)}
              />
            ))}
          </div>
        </TabsContent>

        <TabsContent value="output" className="space-y-4">
          <div className="grid gap-4 md:grid-cols-3">
            {outputMetrics?.map((metric) => (
              <MetricCard
                key={metric.name}
                metric={metric}
                onClick={() => setSelectedMetric(metric.name)}
              />
            ))}
          </div>
        </TabsContent>

        <TabsContent value="performance" className="space-y-4">
          <div className="grid gap-4 md:grid-cols-3">
            {performanceMetrics?.map((metric) => (
              <MetricCard
                key={metric.name}
                metric={metric}
                onClick={() => setSelectedMetric(metric.name)}
              />
            ))}
          </div>
        </TabsContent>
      </Tabs>

      {/* Active Alerts */}
      <Card>
        <CardHeader className="flex flex-row items-center justify-between">
          <CardTitle>Active Alerts</CardTitle>
          <Button variant="ghost" size="sm" asChild>
            <a href="/admin/ai-learning/drift/alerts">View All â†’</a>
          </Button>
        </CardHeader>
        <CardContent>
          <AlertsList alerts={alerts?.slice(0, 5) || []} />
        </CardContent>
      </Card>

      {/* Metric Details Modal */}
      {selectedMetric && (
        <DriftDetails
          metricName={selectedMetric}
          onClose={() => setSelectedMetric(null)}
        />
      )}
    </div>
  );
}

// Helper functions
function calculateHealthScore(summary: any): number {
  if (!summary) return 100;

  let score = 100;

  // Penalizar por alertas abiertas
  score -= summary.bySeverity?.critical * 20 || 0;
  score -= summary.bySeverity?.high * 10 || 0;
  score -= summary.bySeverity?.medium * 5 || 0;
  score -= summary.bySeverity?.low * 2 || 0;

  return Math.max(0, Math.min(100, score));
}

function calculateTrendPercentage(timeline: any[]): number {
  if (!timeline || timeline.length < 2) return 0;

  const recent = timeline.slice(-7);
  const previous = timeline.slice(-14, -7);

  if (previous.length === 0) return 0;

  const recentAvg = recent.reduce((a, b) => a + (b.driftScore || 0), 0) / recent.length;
  const previousAvg = previous.reduce((a, b) => a + (b.driftScore || 0), 0) / previous.length;

  if (previousAvg === 0) return 0;

  return Math.round(((recentAvg - previousAvg) / previousAvg) * 100);
}

function formatTimeAgo(date: Date | null): string {
  if (!date) return 'Never';

  const seconds = Math.floor((Date.now() - date.getTime()) / 1000);

  if (seconds < 60) return 'Just now';
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  return `${Math.floor(seconds / 86400)}d ago`;
}

function formatNextRun(lastRun: Date | null): string {
  if (!lastRun) return 'Unknown';

  const nextRun = new Date(lastRun.getTime() + 60 * 60 * 1000); // +1 hour
  return nextRun.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
```

### Health Indicator

```typescript
// components/ai-learning/drift/health-indicator.tsx

'use client';

import { cn } from '@/lib/utils';

interface HealthIndicatorProps {
  score: number;
  size?: 'sm' | 'md' | 'lg';
  showLabel?: boolean;
}

export function HealthIndicator({
  score,
  size = 'md',
  showLabel = true,
}: HealthIndicatorProps) {
  const getColor = (score: number) => {
    if (score >= 90) return 'text-green-500';
    if (score >= 70) return 'text-yellow-500';
    if (score >= 50) return 'text-orange-500';
    return 'text-red-500';
  };

  const getBgColor = (score: number) => {
    if (score >= 90) return 'bg-green-500/10';
    if (score >= 70) return 'bg-yellow-500/10';
    if (score >= 50) return 'bg-orange-500/10';
    return 'bg-red-500/10';
  };

  const getLabel = (score: number) => {
    if (score >= 90) return 'Healthy';
    if (score >= 70) return 'Warning';
    if (score >= 50) return 'Degraded';
    return 'Critical';
  };

  const getEmoji = (score: number) => {
    if (score >= 90) return 'ğŸŸ¢';
    if (score >= 70) return 'ğŸŸ¡';
    if (score >= 50) return 'ğŸŸ ';
    return 'ğŸ”´';
  };

  const sizeClasses = {
    sm: 'text-lg',
    md: 'text-2xl',
    lg: 'text-4xl',
  };

  return (
    <div className="flex items-center gap-2">
      <span className={sizeClasses[size]}>{getEmoji(score)}</span>
      <div>
        <div className={cn('font-bold', sizeClasses[size], getColor(score))}>
          {score}%
        </div>
        {showLabel && (
          <span className={cn('text-xs px-2 py-0.5 rounded', getBgColor(score), getColor(score))}>
            {getLabel(score)}
          </span>
        )}
      </div>
    </div>
  );
}
```

### Drift Timeline Chart

```typescript
// components/ai-learning/drift/drift-timeline.tsx

'use client';

import { useMemo } from 'react';
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  ReferenceLine,
  Area,
  ComposedChart,
} from 'recharts';
import { format } from 'date-fns';

interface TimelinePoint {
  date: Date;
  driftScore: number;
  inputDrift: number;
  outputDrift: number;
  performanceDrift: number;
  alertCount: number;
}

interface DriftTimelineProps {
  data: TimelinePoint[];
  onSelectPoint?: (date: Date) => void;
}

export function DriftTimeline({ data, onSelectPoint }: DriftTimelineProps) {
  const chartData = useMemo(() => {
    return data.map((point) => ({
      ...point,
      date: format(new Date(point.date), 'MMM dd'),
      timestamp: new Date(point.date).getTime(),
    }));
  }, [data]);

  const CustomTooltip = ({ active, payload, label }: any) => {
    if (!active || !payload || !payload.length) return null;

    return (
      <div className="bg-popover border rounded-lg shadow-lg p-3 text-sm">
        <p className="font-medium mb-2">{label}</p>
        <div className="space-y-1">
          <div className="flex justify-between gap-4">
            <span className="text-muted-foreground">Overall:</span>
            <span className="font-medium">{payload[0]?.value?.toFixed(2)}</span>
          </div>
          <div className="flex justify-between gap-4">
            <span className="text-blue-500">Input:</span>
            <span>{payload[1]?.value?.toFixed(2)}</span>
          </div>
          <div className="flex justify-between gap-4">
            <span className="text-green-500">Output:</span>
            <span>{payload[2]?.value?.toFixed(2)}</span>
          </div>
          <div className="flex justify-between gap-4">
            <span className="text-orange-500">Performance:</span>
            <span>{payload[3]?.value?.toFixed(2)}</span>
          </div>
          {payload[0]?.payload?.alertCount > 0 && (
            <div className="flex justify-between gap-4 pt-1 border-t">
              <span className="text-red-500">Alerts:</span>
              <span>{payload[0].payload.alertCount}</span>
            </div>
          )}
        </div>
      </div>
    );
  };

  return (
    <div className="h-[300px] w-full">
      <ResponsiveContainer width="100%" height="100%">
        <ComposedChart
          data={chartData}
          margin={{ top: 10, right: 30, left: 0, bottom: 0 }}
          onClick={(e) => {
            if (e?.activePayload?.[0]?.payload?.timestamp && onSelectPoint) {
              onSelectPoint(new Date(e.activePayload[0].payload.timestamp));
            }
          }}
        >
          <defs>
            <linearGradient id="colorDrift" x1="0" y1="0" x2="0" y2="1">
              <stop offset="5%" stopColor="#8884d8" stopOpacity={0.3} />
              <stop offset="95%" stopColor="#8884d8" stopOpacity={0} />
            </linearGradient>
          </defs>

          <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />

          <XAxis
            dataKey="date"
            tick={{ fontSize: 12 }}
            tickLine={false}
            axisLine={false}
          />

          <YAxis
            tick={{ fontSize: 12 }}
            tickLine={false}
            axisLine={false}
            domain={[0, 1]}
            tickFormatter={(value) => value.toFixed(1)}
          />

          <Tooltip content={<CustomTooltip />} />

          {/* Threshold lines */}
          <ReferenceLine
            y={0.1}
            stroke="#22c55e"
            strokeDasharray="3 3"
            label={{ value: 'Low', position: 'right', fontSize: 10 }}
          />
          <ReferenceLine
            y={0.2}
            stroke="#f59e0b"
            strokeDasharray="3 3"
            label={{ value: 'Medium', position: 'right', fontSize: 10 }}
          />
          <ReferenceLine
            y={0.3}
            stroke="#ef4444"
            strokeDasharray="3 3"
            label={{ value: 'High', position: 'right', fontSize: 10 }}
          />

          {/* Area for overall drift */}
          <Area
            type="monotone"
            dataKey="driftScore"
            stroke="#8884d8"
            fillOpacity={1}
            fill="url(#colorDrift)"
          />

          {/* Lines for each drift type */}
          <Line
            type="monotone"
            dataKey="inputDrift"
            stroke="#3b82f6"
            strokeWidth={2}
            dot={false}
            name="Input"
          />
          <Line
            type="monotone"
            dataKey="outputDrift"
            stroke="#22c55e"
            strokeWidth={2}
            dot={false}
            name="Output"
          />
          <Line
            type="monotone"
            dataKey="performanceDrift"
            stroke="#f97316"
            strokeWidth={2}
            dot={false}
            name="Performance"
          />
        </ComposedChart>
      </ResponsiveContainer>
    </div>
  );
}
```

### Metric Card

```typescript
// components/ai-learning/drift/metric-card.tsx

'use client';

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { cn } from '@/lib/utils';
import { ChevronRight, TrendingUp, TrendingDown, Minus } from 'lucide-react';

interface MetricData {
  name: string;
  displayName: string;
  status: 'ok' | 'low' | 'medium' | 'high' | 'critical';
  currentValue: number;
  baselineValue: number;
  psi?: number;
  pValue?: number;
  trend: 'up' | 'down' | 'stable';
  lastChecked: Date;
}

interface MetricCardProps {
  metric: MetricData;
  onClick?: () => void;
}

export function MetricCard({ metric, onClick }: MetricCardProps) {
  const statusConfig = {
    ok: { color: 'text-green-500', bg: 'bg-green-500/10', label: 'OK', emoji: 'ğŸŸ¢' },
    low: { color: 'text-yellow-500', bg: 'bg-yellow-500/10', label: 'Low', emoji: 'ğŸŸ¡' },
    medium: { color: 'text-orange-500', bg: 'bg-orange-500/10', label: 'Medium', emoji: 'ğŸŸ ' },
    high: { color: 'text-red-500', bg: 'bg-red-500/10', label: 'High', emoji: 'ğŸ”´' },
    critical: { color: 'text-red-600', bg: 'bg-red-600/10', label: 'Critical', emoji: 'ğŸš¨' },
  };

  const config = statusConfig[metric.status];

  const getTrendIcon = () => {
    switch (metric.trend) {
      case 'up':
        return <TrendingUp className="h-4 w-4 text-red-500" />;
      case 'down':
        return <TrendingDown className="h-4 w-4 text-green-500" />;
      default:
        return <Minus className="h-4 w-4 text-gray-500" />;
    }
  };

  const changePercent = metric.baselineValue !== 0
    ? ((metric.currentValue - metric.baselineValue) / metric.baselineValue * 100).toFixed(1)
    : '0';

  return (
    <Card
      className={cn(
        'cursor-pointer transition-all hover:shadow-md',
        metric.status !== 'ok' && 'border-l-4',
        metric.status === 'low' && 'border-l-yellow-500',
        metric.status === 'medium' && 'border-l-orange-500',
        metric.status === 'high' && 'border-l-red-500',
        metric.status === 'critical' && 'border-l-red-600'
      )}
      onClick={onClick}
    >
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium">
          {metric.displayName}
        </CardTitle>
        <Badge className={cn('text-xs', config.bg, config.color)} variant="outline">
          {config.emoji} {config.label}
        </Badge>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          {/* Current vs Baseline */}
          <div className="flex items-end justify-between">
            <div>
              <div className="text-2xl font-bold">
                {metric.currentValue.toFixed(3)}
              </div>
              <div className="text-xs text-muted-foreground">
                Baseline: {metric.baselineValue.toFixed(3)}
              </div>
            </div>
            <div className="flex items-center gap-1 text-sm">
              {getTrendIcon()}
              <span className={cn(
                parseFloat(changePercent) > 0 ? 'text-red-500' : 'text-green-500'
              )}>
                {parseFloat(changePercent) > 0 ? '+' : ''}{changePercent}%
              </span>
            </div>
          </div>

          {/* PSI/P-Value indicators */}
          {metric.psi !== undefined && (
            <div className="space-y-1">
              <div className="flex justify-between text-xs">
                <span className="text-muted-foreground">PSI</span>
                <span className={cn(
                  metric.psi < 0.1 ? 'text-green-500' :
                  metric.psi < 0.2 ? 'text-yellow-500' :
                  'text-red-500'
                )}>
                  {metric.psi.toFixed(3)}
                </span>
              </div>
              <Progress
                value={Math.min(100, metric.psi * 333)} // 0.3 = 100%
                className={cn(
                  'h-1',
                  metric.psi < 0.1 ? '[&>div]:bg-green-500' :
                  metric.psi < 0.2 ? '[&>div]:bg-yellow-500' :
                  '[&>div]:bg-red-500'
                )}
              />
            </div>
          )}

          {metric.pValue !== undefined && (
            <div className="flex justify-between text-xs">
              <span className="text-muted-foreground">P-Value</span>
              <span className={cn(
                metric.pValue > 0.05 ? 'text-green-500' :
                metric.pValue > 0.01 ? 'text-yellow-500' :
                'text-red-500'
              )}>
                {metric.pValue < 0.001 ? '<0.001' : metric.pValue.toFixed(3)}
              </span>
            </div>
          )}

          {/* View details link */}
          <div className="flex items-center justify-end text-xs text-muted-foreground hover:text-foreground">
            View details <ChevronRight className="h-3 w-3 ml-1" />
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

### Alerts List

```typescript
// components/ai-learning/drift/alerts-list.tsx

'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { formatDistanceToNow } from 'date-fns';
import { MoreHorizontal, Check, X, Eye } from 'lucide-react';
import type { Alert } from '@/lib/ai-learning/drift/alerts/types';

interface AlertsListProps {
  alerts: Alert[];
  onAcknowledge?: (alertId: string) => void;
  onResolve?: (alertId: string) => void;
  onDismiss?: (alertId: string) => void;
  onViewDetails?: (alertId: string) => void;
}

export function AlertsList({
  alerts,
  onAcknowledge,
  onResolve,
  onDismiss,
  onViewDetails,
}: AlertsListProps) {
  const severityConfig = {
    low: { color: 'bg-yellow-500', text: 'text-yellow-700' },
    medium: { color: 'bg-orange-500', text: 'text-orange-700' },
    high: { color: 'bg-red-500', text: 'text-red-700' },
    critical: { color: 'bg-red-600', text: 'text-red-800' },
  };

  const statusConfig = {
    open: { variant: 'destructive' as const, label: 'Open' },
    acknowledged: { variant: 'secondary' as const, label: 'Ack' },
    resolved: { variant: 'outline' as const, label: 'Resolved' },
    dismissed: { variant: 'outline' as const, label: 'Dismissed' },
  };

  if (alerts.length === 0) {
    return (
      <div className="text-center py-8 text-muted-foreground">
        <p>No active alerts</p>
        <p className="text-sm">Your AI system is operating normally</p>
      </div>
    );
  }

  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead className="w-[100px]">Severity</TableHead>
          <TableHead>Metric</TableHead>
          <TableHead>Details</TableHead>
          <TableHead>Time</TableHead>
          <TableHead>Status</TableHead>
          <TableHead className="w-[100px]">Actions</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {alerts.map((alert) => {
          const severity = severityConfig[alert.severity];
          const status = statusConfig[alert.status];

          return (
            <TableRow key={alert.id}>
              <TableCell>
                <div className="flex items-center gap-2">
                  <div className={`w-2 h-2 rounded-full ${severity.color}`} />
                  <span className={`text-sm font-medium ${severity.text}`}>
                    {alert.severity.toUpperCase()}
                  </span>
                </div>
              </TableCell>
              <TableCell className="font-medium">{alert.metricName}</TableCell>
              <TableCell>
                <div className="text-sm">
                  <span className="text-muted-foreground">
                    {alert.details?.testName || 'Test'}:
                  </span>{' '}
                  {alert.statistic.toFixed(4)}
                  {alert.pValue && (
                    <span className="text-muted-foreground ml-2">
                      (p={alert.pValue.toFixed(4)})
                    </span>
                  )}
                </div>
              </TableCell>
              <TableCell className="text-sm text-muted-foreground">
                {formatDistanceToNow(new Date(alert.createdAt), { addSuffix: true })}
              </TableCell>
              <TableCell>
                <Badge variant={status.variant}>{status.label}</Badge>
              </TableCell>
              <TableCell>
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" size="icon">
                      <MoreHorizontal className="h-4 w-4" />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem onClick={() => onViewDetails?.(alert.id)}>
                      <Eye className="h-4 w-4 mr-2" />
                      View Details
                    </DropdownMenuItem>
                    {alert.status === 'open' && (
                      <DropdownMenuItem onClick={() => onAcknowledge?.(alert.id)}>
                        <Check className="h-4 w-4 mr-2" />
                        Acknowledge
                      </DropdownMenuItem>
                    )}
                    {(alert.status === 'open' || alert.status === 'acknowledged') && (
                      <>
                        <DropdownMenuItem onClick={() => onResolve?.(alert.id)}>
                          <Check className="h-4 w-4 mr-2" />
                          Mark Resolved
                        </DropdownMenuItem>
                        <DropdownMenuItem onClick={() => onDismiss?.(alert.id)}>
                          <X className="h-4 w-4 mr-2" />
                          Dismiss
                        </DropdownMenuItem>
                      </>
                    )}
                  </DropdownMenuContent>
                </DropdownMenu>
              </TableCell>
            </TableRow>
          );
        })}
      </TableBody>
    </Table>
  );
}
```

### Drift Details Modal

```typescript
// components/ai-learning/drift/drift-details.tsx

'use client';

import { useEffect, useState } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  BarChart,
  Bar,
} from 'recharts';

interface DriftDetailsProps {
  metricName: string;
  onClose: () => void;
}

export function DriftDetails({ metricName, onClose }: DriftDetailsProps) {
  const [data, setData] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    async function fetchDetails() {
      setIsLoading(true);
      try {
        const res = await fetch(`/api/drift/metrics/${metricName}/details`);
        const json = await res.json();
        setData(json);
      } catch (error) {
        console.error('Failed to fetch metric details:', error);
      } finally {
        setIsLoading(false);
      }
    }

    fetchDetails();
  }, [metricName]);

  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle>Drift Analysis: {metricName}</DialogTitle>
        </DialogHeader>

        {isLoading ? (
          <div className="flex items-center justify-center py-12">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary" />
          </div>
        ) : (
          <Tabs defaultValue="overview" className="space-y-4">
            <TabsList>
              <TabsTrigger value="overview">Overview</TabsTrigger>
              <TabsTrigger value="distribution">Distribution</TabsTrigger>
              <TabsTrigger value="history">History</TabsTrigger>
              <TabsTrigger value="recommendations">Recommendations</TabsTrigger>
            </TabsList>

            <TabsContent value="overview" className="space-y-4">
              <div className="grid gap-4 md:grid-cols-3">
                <Card>
                  <CardHeader className="pb-2">
                    <CardTitle className="text-sm">Current Value</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="text-2xl font-bold">
                      {data?.currentValue?.toFixed(4) || 'N/A'}
                    </div>
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader className="pb-2">
                    <CardTitle className="text-sm">Baseline Value</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="text-2xl font-bold">
                      {data?.baselineValue?.toFixed(4) || 'N/A'}
                    </div>
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader className="pb-2">
                    <CardTitle className="text-sm">Drift Score (PSI)</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="text-2xl font-bold">
                      {data?.psi?.toFixed(4) || 'N/A'}
                    </div>
                  </CardContent>
                </Card>
              </div>

              <Card>
                <CardHeader>
                  <CardTitle>Statistical Test Results</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-2">
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">Test Name:</span>
                      <span className="font-medium">{data?.testName}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">Statistic:</span>
                      <span className="font-medium">{data?.statistic?.toFixed(4)}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">P-Value:</span>
                      <span className="font-medium">{data?.pValue?.toFixed(4)}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">Threshold:</span>
                      <span className="font-medium">{data?.threshold}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-muted-foreground">Confidence:</span>
                      <span className="font-medium">{(data?.confidence * 100)?.toFixed(1)}%</span>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="distribution">
              <Card>
                <CardHeader>
                  <CardTitle>Distribution Comparison</CardTitle>
                </CardHeader>
                <CardContent className="h-[400px]">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={data?.distributionComparison || []}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="bucket" />
                      <YAxis />
                      <Tooltip />
                      <Bar dataKey="baseline" fill="#8884d8" name="Baseline" />
                      <Bar dataKey="current" fill="#82ca9d" name="Current" />
                    </BarChart>
                  </ResponsiveContainer>
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="history">
              <Card>
                <CardHeader>
                  <CardTitle>Historical Drift Scores</CardTitle>
                </CardHeader>
                <CardContent className="h-[400px]">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={data?.history || []}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="date" />
                      <YAxis domain={[0, 'auto']} />
                      <Tooltip />
                      <Line
                        type="monotone"
                        dataKey="score"
                        stroke="#8884d8"
                        strokeWidth={2}
                      />
                    </LineChart>
                  </ResponsiveContainer>
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="recommendations">
              <Card>
                <CardHeader>
                  <CardTitle>Recommendations</CardTitle>
                </CardHeader>
                <CardContent>
                  <ul className="space-y-3">
                    {data?.recommendations?.map((rec: string, i: number) => (
                      <li key={i} className="flex items-start gap-2">
                        <span className="text-primary">â€¢</span>
                        <span>{rec}</span>
                      </li>
                    ))}
                  </ul>
                </CardContent>
              </Card>
            </TabsContent>
          </Tabs>
        )}
      </DialogContent>
    </Dialog>
  );
}
```

## Custom Hook para Data

```typescript
// hooks/use-drift-data.ts

'use client';

import { useState, useEffect, useCallback } from 'react';
import type { Alert, AlertSummary } from '@/lib/ai-learning/drift/alerts/types';

interface MetricData {
  name: string;
  displayName: string;
  status: 'ok' | 'low' | 'medium' | 'high' | 'critical';
  currentValue: number;
  baselineValue: number;
  psi?: number;
  pValue?: number;
  trend: 'up' | 'down' | 'stable';
  lastChecked: Date;
}

interface TimelinePoint {
  date: Date;
  driftScore: number;
  inputDrift: number;
  outputDrift: number;
  performanceDrift: number;
  alertCount: number;
}

interface DriftDataHook {
  summary: AlertSummary | null;
  alerts: Alert[];
  inputMetrics: MetricData[];
  outputMetrics: MetricData[];
  performanceMetrics: MetricData[];
  timeline: TimelinePoint[];
  isLoading: boolean;
  error: Error | null;
  refresh: () => Promise<void>;
  lastUpdated: Date | null;
}

export function useDriftData(): DriftDataHook {
  const [summary, setSummary] = useState<AlertSummary | null>(null);
  const [alerts, setAlerts] = useState<Alert[]>([]);
  const [inputMetrics, setInputMetrics] = useState<MetricData[]>([]);
  const [outputMetrics, setOutputMetrics] = useState<MetricData[]>([]);
  const [performanceMetrics, setPerformanceMetrics] = useState<MetricData[]>([]);
  const [timeline, setTimeline] = useState<TimelinePoint[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);
  const [lastUpdated, setLastUpdated] = useState<Date | null>(null);

  const refresh = useCallback(async () => {
    setIsLoading(true);
    setError(null);

    try {
      const [
        summaryRes,
        alertsRes,
        metricsRes,
        timelineRes,
      ] = await Promise.all([
        fetch('/api/drift/alerts/summary'),
        fetch('/api/drift/alerts?status=open&limit=10'),
        fetch('/api/drift/metrics'),
        fetch('/api/drift/timeline?days=14'),
      ]);

      const [
        summaryData,
        alertsData,
        metricsData,
        timelineData,
      ] = await Promise.all([
        summaryRes.json(),
        alertsRes.json(),
        metricsRes.json(),
        timelineRes.json(),
      ]);

      setSummary(summaryData.summary);
      setAlerts(alertsData.alerts);
      setInputMetrics(metricsData.input || []);
      setOutputMetrics(metricsData.output || []);
      setPerformanceMetrics(metricsData.performance || []);
      setTimeline(timelineData.timeline || []);
      setLastUpdated(new Date());
    } catch (err) {
      setError(err instanceof Error ? err : new Error('Failed to fetch drift data'));
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    refresh();
  }, [refresh]);

  return {
    summary,
    alerts,
    inputMetrics,
    outputMetrics,
    performanceMetrics,
    timeline,
    isLoading,
    error,
    refresh,
    lastUpdated,
  };
}
```

## API Endpoints para Dashboard

```typescript
// app/api/drift/metrics/route.ts

import { NextResponse } from 'next/server';
import { getServerSession } from '@/lib/auth';
import { getTenantId } from '@/lib/tenant';
import { DriftDetector } from '@/lib/ai-learning/drift/drift-detector';

export async function GET() {
  const session = await getServerSession();
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const tenantId = await getTenantId();
  const detector = new DriftDetector();

  // Get latest analysis results
  const now = new Date();
  const dayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);

  const report = await detector.analyzeForTenant(tenantId, {
    start: dayAgo,
    end: now,
  });

  // Transform results into metric cards
  const metrics = {
    input: report.results
      .filter(r => ['message_length', 'intent_distribution', 'vocabulary_distribution'].includes(r.metric))
      .map(mapToMetricData),
    output: report.results
      .filter(r => ['confidence_score', 'action_distribution', 'escalation_rate'].includes(r.metric))
      .map(mapToMetricData),
    performance: report.results
      .filter(r => ['positive_feedback_rate', 'p95_latency', 'error_rate', 'resolution_rate'].includes(r.metric))
      .map(mapToMetricData),
  };

  return NextResponse.json(metrics);
}

function mapToMetricData(result: any) {
  return {
    name: result.metric,
    displayName: formatMetricName(result.metric),
    status: result.severity,
    currentValue: result.statistic,
    baselineValue: result.details?.baselineMean || 0,
    psi: result.details?.psi,
    pValue: result.pValue,
    trend: determineTrend(result),
    lastChecked: new Date(),
  };
}

function formatMetricName(name: string): string {
  return name
    .split('_')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

function determineTrend(result: any): 'up' | 'down' | 'stable' {
  const change = result.details?.meanShift || 0;
  if (Math.abs(change) < 0.01) return 'stable';
  return change > 0 ? 'up' : 'down';
}

// app/api/drift/timeline/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { getServerSession } from '@/lib/auth';
import { getTenantId } from '@/lib/tenant';

export async function GET(request: NextRequest) {
  const session = await getServerSession();
  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const tenantId = await getTenantId();
  const days = parseInt(request.nextUrl.searchParams.get('days') || '14');

  const supabase = await createClient();
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);

  const { data: reports } = await supabase
    .from('ai_drift_reports')
    .select('*')
    .eq('tenant_id', tenantId)
    .gte('created_at', startDate.toISOString())
    .order('created_at', { ascending: true });

  // Aggregate by day
  const timeline = aggregateByDay(reports || []);

  return NextResponse.json({ timeline });
}

function aggregateByDay(reports: any[]): any[] {
  const byDay = new Map<string, any[]>();

  for (const report of reports) {
    const day = new Date(report.created_at).toISOString().split('T')[0];
    if (!byDay.has(day)) {
      byDay.set(day, []);
    }
    byDay.get(day)!.push(report);
  }

  return Array.from(byDay.entries()).map(([day, dayReports]) => {
    // Calculate average drift scores for the day
    const inputDrifts = dayReports.flatMap(r =>
      r.results.filter((res: any) =>
        ['message_length', 'intent_distribution'].includes(res.metric)
      ).map((res: any) => res.statistic)
    );

    const outputDrifts = dayReports.flatMap(r =>
      r.results.filter((res: any) =>
        ['confidence_score', 'action_distribution'].includes(res.metric)
      ).map((res: any) => res.statistic)
    );

    const perfDrifts = dayReports.flatMap(r =>
      r.results.filter((res: any) =>
        ['positive_feedback_rate', 'error_rate'].includes(res.metric)
      ).map((res: any) => res.statistic)
    );

    return {
      date: new Date(day),
      driftScore: average([...inputDrifts, ...outputDrifts, ...perfDrifts]),
      inputDrift: average(inputDrifts),
      outputDrift: average(outputDrifts),
      performanceDrift: average(perfDrifts),
      alertCount: dayReports.filter(r => r.overall_drift).length,
    };
  });
}

function average(arr: number[]): number {
  if (arr.length === 0) return 0;
  return arr.reduce((a, b) => a + b, 0) / arr.length;
}
```

## PÃ¡gina del Dashboard

```typescript
// app/(dashboard)/admin/ai-learning/drift/page.tsx

import { Metadata } from 'next';
import { DriftDashboard } from '@/components/ai-learning/drift/drift-dashboard';

export const metadata: Metadata = {
  title: 'Drift Monitor | AI Learning',
  description: 'Monitor and manage AI drift detection',
};

export default function DriftMonitorPage() {
  return <DriftDashboard />;
}
```

## Fin de FASE-3

Con este documento se completa la documentaciÃ³n de FASE-3 Drift Detection. ContinÃºa con [FASE-4-FEATURE-STORE](../FASE-4-FEATURE-STORE/4.0-OVERVIEW.md) para la implementaciÃ³n del Feature Store.
