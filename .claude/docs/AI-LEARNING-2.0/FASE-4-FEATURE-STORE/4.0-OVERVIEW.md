# ğŸ“Š FASE 4: Feature Store

## Sistema de Almacenamiento y Serving de Features

**Documento:** 4.0-OVERVIEW.md
**Fase:** 4 - Feature Store
**DuraciÃ³n estimada:** 5-6 semanas
**Costo adicional:** ~$0/mes (usa infraestructura existente)

---

## ğŸ“‹ Ãndice

1. [Objetivo](#objetivo)
2. [Â¿QuÃ© es un Feature Store?](#quÃ©-es-un-feature-store)
3. [Arquitectura](#arquitectura)
4. [Microfases](#microfases)
5. [Features para TIS TIS](#features-para-tis-tis)
6. [ImplementaciÃ³n de Alto Nivel](#implementaciÃ³n-de-alto-nivel)
7. [Checklist General](#checklist-general)

---

## ğŸ¯ Objetivo

Implementar un Feature Store para centralizar, versionar y servir features computadas que alimentan los modelos de AI, garantizando consistencia entre training y serving.

### Â¿Por quÃ© es necesario?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TRAINING-SERVING SKEW PROBLEM                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  WITHOUT FEATURE STORE:                                         â”‚
â”‚                                                                  â”‚
â”‚  Training Pipeline                  Serving Pipeline            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ compute_featuresâ”‚              â”‚ compute_featuresâ”‚          â”‚
â”‚  â”‚ (Python script) â”‚              â”‚ (TypeScript)    â”‚          â”‚
â”‚  â”‚                 â”‚              â”‚                 â”‚          â”‚
â”‚  â”‚ avg = sum/count â”‚              â”‚ avg = sum/len   â”‚          â”‚
â”‚  â”‚ (float division)â”‚              â”‚ (int division!) â”‚ âŒ       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â”‚  Result: Model performs differently in production!               â”‚
â”‚                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                  â”‚
â”‚  WITH FEATURE STORE:                                            â”‚
â”‚                                                                  â”‚
â”‚  Training Pipeline      Feature Store      Serving Pipeline     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Get featuresâ”‚ â”€â”€â”€â”€â–ºâ”‚ Single      â”‚â—„â”€â”€â”€â”‚ Get featuresâ”‚       â”‚
â”‚  â”‚             â”‚      â”‚ source of   â”‚    â”‚             â”‚       â”‚
â”‚  â”‚             â”‚      â”‚ truth       â”‚    â”‚             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                  â”‚
â”‚  Result: Consistent features everywhere! âœ…                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š Â¿QuÃ© es un Feature Store?

### Componentes Clave

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       FEATURE STORE COMPONENTS                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. FEATURE REGISTRY                                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚  Metadata catalog of all features                        â”‚   â”‚
â”‚     â”‚  - Name, description, owner                              â”‚   â”‚
â”‚     â”‚  - Data type, schema                                     â”‚   â”‚
â”‚     â”‚  - Computation logic reference                           â”‚   â”‚
â”‚     â”‚  - Version history                                       â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  2. OFFLINE STORE                                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚  Historical feature values for training                  â”‚   â”‚
â”‚     â”‚  - Point-in-time correctness                             â”‚   â”‚
â”‚     â”‚  - Batch retrieval                                       â”‚   â”‚
â”‚     â”‚  - Data lake / warehouse storage                         â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  3. ONLINE STORE                                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚  Low-latency feature serving for inference              â”‚   â”‚
â”‚     â”‚  - Key-value lookups                                     â”‚   â”‚
â”‚     â”‚  - Sub-10ms retrieval                                    â”‚   â”‚
â”‚     â”‚  - Redis / in-memory cache                               â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  4. FEATURE COMPUTATION                                            â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚  Pipelines that compute features                         â”‚   â”‚
â”‚     â”‚  - Batch computation (scheduled)                         â”‚   â”‚
â”‚     â”‚  - Streaming computation (real-time)                     â”‚   â”‚
â”‚     â”‚  - On-demand computation                                 â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Beneficios

| Beneficio | DescripciÃ³n |
|-----------|-------------|
| **Consistencia** | Mismas features en training y serving |
| **ReutilizaciÃ³n** | Features compartidas entre modelos |
| **Versionado** | Track de cambios en features |
| **Time Travel** | Point-in-time queries para training |
| **Monitoreo** | Data quality y drift detection |

---

## ğŸ—ï¸ Arquitectura

### Arquitectura para TIS TIS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TIS TIS FEATURE STORE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Data Sources                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚Messages  â”‚ â”‚RLHF      â”‚ â”‚Bookings  â”‚ â”‚Analytics â”‚             â”‚
â”‚  â”‚          â”‚ â”‚Feedback  â”‚ â”‚          â”‚ â”‚          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
â”‚       â”‚            â”‚            â”‚            â”‚                     â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                         â”‚                                          â”‚
â”‚                         â–¼                                          â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚              â”‚ Feature Pipelines â”‚                                â”‚
â”‚              â”‚ (Computation)     â”‚                                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                        â”‚                                           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚         â”‚              â”‚              â”‚                            â”‚
â”‚         â–¼              â–¼              â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ Feature   â”‚  â”‚ Offline   â”‚  â”‚ Online    â”‚                     â”‚
â”‚  â”‚ Registry  â”‚  â”‚ Store     â”‚  â”‚ Store     â”‚                     â”‚
â”‚  â”‚           â”‚  â”‚           â”‚  â”‚           â”‚                     â”‚
â”‚  â”‚ Postgres  â”‚  â”‚ Postgres  â”‚  â”‚ Redis/    â”‚                     â”‚
â”‚  â”‚           â”‚  â”‚           â”‚  â”‚ Memory    â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚        â”‚              â”‚              â”‚                             â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                       â”‚                                            â”‚
â”‚                       â–¼                                            â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚              â”‚   Feature API     â”‚                                â”‚
â”‚              â”‚   (Serving)       â”‚                                â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                        â”‚                                           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚         â”‚              â”‚              â”‚                            â”‚
â”‚         â–¼              â–¼              â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ Training  â”‚  â”‚ LangGraph â”‚  â”‚ Drift     â”‚                     â”‚
â”‚  â”‚ Pipeline  â”‚  â”‚ Agents    â”‚  â”‚ Detection â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Estructura de Archivos

```
src/features/ai/feature-store/
â”œâ”€â”€ registry/
â”‚   â”œâ”€â”€ feature-registry.service.ts     # CatÃ¡logo de features
â”‚   â””â”€â”€ feature-definitions.ts          # Definiciones de features
â”œâ”€â”€ computation/
â”‚   â”œâ”€â”€ feature-pipeline.service.ts     # Pipeline de cÃ³mputo
â”‚   â”œâ”€â”€ transformers/                   # Transformaciones
â”‚   â”‚   â”œâ”€â”€ aggregations.ts
â”‚   â”‚   â”œâ”€â”€ embeddings.ts
â”‚   â”‚   â””â”€â”€ temporal.ts
â”‚   â””â”€â”€ jobs/
â”‚       â””â”€â”€ compute-features.cron.ts
â”œâ”€â”€ storage/
â”‚   â”œâ”€â”€ offline-store.service.ts        # Store histÃ³rico
â”‚   â””â”€â”€ online-store.service.ts         # Store de serving
â”œâ”€â”€ serving/
â”‚   â””â”€â”€ feature-serving.service.ts      # API de serving
â”œâ”€â”€ types/
â”‚   â””â”€â”€ feature-store.types.ts
â””â”€â”€ utils/
    â””â”€â”€ point-in-time.ts                # Utilidades temporales
```

---

## ğŸ“¦ Microfases

### 4.1 Schema Design (1 semana)

```
Objetivo: DiseÃ±ar el schema y registry de features

Entregables:
â”œâ”€â”€ Feature definitions (tipos, schemas)
â”œâ”€â”€ Tablas en Supabase
â”œâ”€â”€ Feature versioning strategy
â””â”€â”€ Documentation

Features definidas:
â”œâ”€â”€ Tenant-level features
â”œâ”€â”€ User-level features
â”œâ”€â”€ Conversation-level features
â”œâ”€â”€ Message-level features
â””â”€â”€ Aggregated features
```

### 4.2 Feature Computation (2 semanas)

```
Objetivo: Implementar pipelines de cÃ³mputo de features

Entregables:
â”œâ”€â”€ FeaturePipelineService
â”œâ”€â”€ Aggregation transformers
â”œâ”€â”€ Temporal transformers
â”œâ”€â”€ Cron jobs para batch computation
â””â”€â”€ Streaming computation (opcional)

Pipelines:
â”œâ”€â”€ Hourly aggregations
â”œâ”€â”€ Daily aggregations
â”œâ”€â”€ Weekly aggregations
â””â”€â”€ On-demand computation
```

### 4.3 Feature Versioning (1 semana)

```
Objetivo: Sistema de versionado de features

Entregables:
â”œâ”€â”€ Version tracking
â”œâ”€â”€ Schema evolution
â”œâ”€â”€ Backward compatibility
â”œâ”€â”€ Migration scripts
â””â”€â”€ Rollback capability

Estrategia:
â”œâ”€â”€ Semantic versioning (major.minor.patch)
â”œâ”€â”€ Breaking change detection
â”œâ”€â”€ Deprecation workflow
â””â”€â”€ A/B testing support
```

### 4.4 Feature Serving (1.5 semanas)

```
Objetivo: API de bajo latencia para serving

Entregables:
â”œâ”€â”€ FeatureServingService
â”œâ”€â”€ Online store (Redis/memory cache)
â”œâ”€â”€ Batch retrieval API
â”œâ”€â”€ Point-in-time queries
â””â”€â”€ Integration con LangGraph

Requisitos:
â”œâ”€â”€ <10ms latency para single entity
â”œâ”€â”€ <100ms para batch (100 entities)
â”œâ”€â”€ Cache hit rate >90%
â””â”€â”€ Automatic refresh
```

---

## ğŸ¯ Features para TIS TIS

### Feature Catalog

```typescript
// Feature definitions for TIS TIS AI Learning

const FEATURE_DEFINITIONS = {
  // Tenant-level features
  tenant_features: {
    'tenant:message_volume_24h': {
      type: 'numeric',
      description: 'Total messages in last 24 hours',
      computation: 'count(messages WHERE timestamp > now() - 24h)',
      refresh: 'hourly',
    },
    'tenant:avg_satisfaction_7d': {
      type: 'numeric',
      description: 'Average satisfaction rate in last 7 days',
      computation: 'avg(satisfaction) FROM rlhf_aggregated WHERE period = 7d',
      refresh: 'daily',
    },
    'tenant:intent_distribution_7d': {
      type: 'json',
      description: 'Intent distribution in last 7 days',
      computation: 'json_agg(intent, count) FROM message_classifications',
      refresh: 'daily',
    },
    'tenant:embedding_centroid': {
      type: 'vector',
      description: 'Centroid of message embeddings',
      computation: 'avg(embedding) FROM message_embeddings',
      refresh: 'daily',
    },
  },

  // Conversation-level features
  conversation_features: {
    'conv:message_count': {
      type: 'numeric',
      description: 'Number of messages in conversation',
      computation: 'count(messages) GROUP BY conversation_id',
      refresh: 'real-time',
    },
    'conv:sentiment_trajectory': {
      type: 'array',
      description: 'Sentiment scores over conversation',
      computation: 'array_agg(sentiment ORDER BY timestamp)',
      refresh: 'real-time',
    },
    'conv:intent_sequence': {
      type: 'array',
      description: 'Sequence of detected intents',
      computation: 'array_agg(intent ORDER BY timestamp)',
      refresh: 'real-time',
    },
    'conv:avg_response_time_ms': {
      type: 'numeric',
      description: 'Average AI response time',
      computation: 'avg(response_time_ms)',
      refresh: 'real-time',
    },
  },

  // User-level features
  user_features: {
    'user:total_conversations': {
      type: 'numeric',
      description: 'Total conversations for user',
      computation: 'count(distinct conversation_id)',
      refresh: 'daily',
    },
    'user:preferred_intent': {
      type: 'categorical',
      description: 'Most common intent from user',
      computation: 'mode(intent)',
      refresh: 'daily',
    },
    'user:satisfaction_history': {
      type: 'array',
      description: 'Historical satisfaction scores',
      computation: 'array_agg(satisfaction ORDER BY timestamp DESC LIMIT 10)',
      refresh: 'real-time',
    },
    'user:booking_rate': {
      type: 'numeric',
      description: 'Percentage of conversations that lead to booking',
      computation: 'count(bookings) / count(conversations)',
      refresh: 'daily',
    },
  },

  // Message-level features
  message_features: {
    'msg:embedding': {
      type: 'vector',
      description: 'Message embedding vector',
      computation: 'embed(message_text)',
      refresh: 'real-time',
    },
    'msg:token_count': {
      type: 'numeric',
      description: 'Number of tokens in message',
      computation: 'count_tokens(message_text)',
      refresh: 'real-time',
    },
    'msg:sentiment': {
      type: 'numeric',
      description: 'Sentiment score (-1 to 1)',
      computation: 'analyze_sentiment(message_text)',
      refresh: 'real-time',
    },
    'msg:contains_question': {
      type: 'boolean',
      description: 'Whether message contains a question',
      computation: 'regex_match(message_text, question_pattern)',
      refresh: 'real-time',
    },
  },
};
```

### Feature Vector para ClasificaciÃ³n

```typescript
// Feature vector used by intent classifier
interface ClassificationFeatureVector {
  // Embedding (primary)
  message_embedding: number[];  // 1536 dims

  // Contextual features
  conversation_length: number;
  previous_intent: string | null;
  time_since_last_message_ms: number;

  // User history
  user_preferred_intent: string | null;
  user_booking_rate: number;

  // Tenant context
  tenant_intent_distribution: Record<string, number>;

  // Temporal features
  hour_of_day: number;
  day_of_week: number;
  is_business_hours: boolean;
}
```

---

## ğŸ’» ImplementaciÃ³n de Alto Nivel

### Schema de Base de Datos

```sql
-- Feature registry
CREATE TABLE ai_feature_registry (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL UNIQUE,
  description TEXT,
  feature_type TEXT NOT NULL, -- 'numeric', 'categorical', 'vector', 'json', 'boolean', 'array'
  entity_type TEXT NOT NULL, -- 'tenant', 'user', 'conversation', 'message'

  -- Computation
  computation_sql TEXT,
  refresh_schedule TEXT, -- 'real-time', 'hourly', 'daily', 'weekly'

  -- Schema
  schema_version INT DEFAULT 1,
  value_schema JSONB, -- JSON schema for validation

  -- Metadata
  owner TEXT,
  tags TEXT[],
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Offline store (historical values)
CREATE TABLE ai_feature_values_offline (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feature_id UUID NOT NULL REFERENCES ai_feature_registry(id),
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,

  -- Value (using JSONB for flexibility)
  value JSONB NOT NULL,
  value_type TEXT NOT NULL,

  -- Time dimension (for point-in-time queries)
  valid_from TIMESTAMPTZ NOT NULL,
  valid_to TIMESTAMPTZ,

  -- Metadata
  computed_at TIMESTAMPTZ DEFAULT NOW(),

  -- Composite key for efficient lookups
  UNIQUE (feature_id, entity_type, entity_id, valid_from)
);

-- Online store (current values for serving)
CREATE TABLE ai_feature_values_online (
  feature_id UUID NOT NULL REFERENCES ai_feature_registry(id),
  entity_type TEXT NOT NULL,
  entity_id TEXT NOT NULL,

  -- Current value
  value JSONB NOT NULL,

  -- Cache metadata
  computed_at TIMESTAMPTZ NOT NULL,
  expires_at TIMESTAMPTZ,

  PRIMARY KEY (feature_id, entity_type, entity_id)
);

-- Feature computation logs
CREATE TABLE ai_feature_computation_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  feature_id UUID REFERENCES ai_feature_registry(id),
  computation_type TEXT, -- 'batch', 'streaming', 'on-demand'

  -- Stats
  entities_processed INT,
  duration_ms INT,
  errors_count INT,
  error_details JSONB,

  -- Timestamps
  started_at TIMESTAMPTZ NOT NULL,
  completed_at TIMESTAMPTZ
);

-- Indexes
CREATE INDEX idx_feature_values_offline_lookup
ON ai_feature_values_offline(feature_id, entity_type, entity_id, valid_from DESC);

CREATE INDEX idx_feature_values_offline_time
ON ai_feature_values_offline(valid_from, valid_to);

CREATE INDEX idx_feature_values_online_expires
ON ai_feature_values_online(expires_at);
```

### Feature Serving Service (PseudocÃ³digo)

```typescript
// src/features/ai/feature-store/serving/feature-serving.service.ts

interface FeatureRequest {
  features: string[];
  entity_type: string;
  entity_ids: string[];
  timestamp?: Date;  // For point-in-time queries
}

interface FeatureResponse {
  entity_id: string;
  features: Record<string, unknown>;
  computed_at: Date;
}

class FeatureServingService {
  private onlineStore: OnlineStoreService;
  private offlineStore: OfflineStoreService;
  private cache: Map<string, unknown>;

  /**
   * Get features for real-time serving
   */
  async getOnlineFeatures(request: FeatureRequest): Promise<FeatureResponse[]> {
    const responses: FeatureResponse[] = [];

    for (const entityId of request.entity_ids) {
      // Check memory cache first
      const cacheKey = `${request.entity_type}:${entityId}`;
      const cached = this.cache.get(cacheKey);

      if (cached) {
        responses.push(cached as FeatureResponse);
        continue;
      }

      // Get from online store
      const features = await this.onlineStore.get(
        request.features,
        request.entity_type,
        entityId
      );

      // Compute any missing real-time features
      const missing = request.features.filter(f => !features[f]);
      if (missing.length > 0) {
        const computed = await this.computeOnDemand(missing, request.entity_type, entityId);
        Object.assign(features, computed);
      }

      const response: FeatureResponse = {
        entity_id: entityId,
        features,
        computed_at: new Date(),
      };

      // Update cache
      this.cache.set(cacheKey, response);
      responses.push(response);
    }

    return responses;
  }

  /**
   * Get features for training (point-in-time correct)
   */
  async getTrainingFeatures(
    request: FeatureRequest
  ): Promise<FeatureResponse[]> {
    if (!request.timestamp) {
      throw new Error('Timestamp required for training features');
    }

    return this.offlineStore.getPointInTime(
      request.features,
      request.entity_type,
      request.entity_ids,
      request.timestamp
    );
  }

  /**
   * Compute feature on demand
   */
  private async computeOnDemand(
    features: string[],
    entityType: string,
    entityId: string
  ): Promise<Record<string, unknown>> {
    const computed: Record<string, unknown> = {};

    for (const featureName of features) {
      const definition = await this.registry.get(featureName);
      if (!definition) continue;

      const value = await this.computeFeature(definition, entityType, entityId);
      computed[featureName] = value;

      // Store in online store for next request
      await this.onlineStore.set(featureName, entityType, entityId, value);
    }

    return computed;
  }
}
```

---

## âœ… Checklist General

```
â–¡ FASE 4.1: Schema Design
â”œâ”€â”€ [ ] Feature definitions
â”œâ”€â”€ [ ] Database schema
â”œâ”€â”€ [ ] Registry service
â”œâ”€â”€ [ ] Documentation
â””â”€â”€ [ ] Review with team

â–¡ FASE 4.2: Feature Computation
â”œâ”€â”€ [ ] Pipeline service
â”œâ”€â”€ [ ] Aggregation transformers
â”œâ”€â”€ [ ] Temporal transformers
â”œâ”€â”€ [ ] Batch computation cron
â””â”€â”€ [ ] Unit tests

â–¡ FASE 4.3: Versioning
â”œâ”€â”€ [ ] Version tracking
â”œâ”€â”€ [ ] Schema evolution
â”œâ”€â”€ [ ] Migration scripts
â”œâ”€â”€ [ ] Rollback procedure
â””â”€â”€ [ ] Integration tests

â–¡ FASE 4.4: Serving
â”œâ”€â”€ [ ] Online store service
â”œâ”€â”€ [ ] Offline store service
â”œâ”€â”€ [ ] Serving API
â”œâ”€â”€ [ ] LangGraph integration
â”œâ”€â”€ [ ] Performance tests
â””â”€â”€ [ ] E2E tests
```

---

## ğŸ“š Documentos Detallados

- [4.1-SCHEMA-DESIGN.md](./4.1-SCHEMA-DESIGN.md) ğŸ“ Pendiente
- [4.2-FEATURE-COMPUTATION.md](./4.2-FEATURE-COMPUTATION.md) ğŸ“ Pendiente
- [4.3-VERSIONING.md](./4.3-VERSIONING.md) ğŸ“ Pendiente
- [4.4-SERVING.md](./4.4-SERVING.md) ğŸ“ Pendiente

---

**Siguiente fase:** [FASE-5-FINETUNING/5.0-OVERVIEW.md](../FASE-5-FINETUNING/5.0-OVERVIEW.md)
