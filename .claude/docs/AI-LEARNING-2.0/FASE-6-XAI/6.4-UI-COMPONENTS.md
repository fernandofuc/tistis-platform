# 6.4 UI Components - Explainability (XAI)

## Descripción General

Componentes de React para visualizar explicaciones de decisiones AI, evidencia, y audit trail.

## Decision Explanation Card

```typescript
// components/ai-learning/xai/decision-explanation.tsx

'use client';

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible';
import { ChevronDown, Brain, CheckCircle, AlertTriangle } from 'lucide-react';
import { useState } from 'react';

interface DecisionExplanationProps {
  decisionLogId: string;
  decisionType: string;
  decision: string;
  confidence: number;
  reasoning?: string;
  evidence?: Array<{
    content: string;
    relevance: number;
    explanation: string;
  }>;
  candidates?: Array<{
    option: string;
    score: number;
  }>;
}

export function DecisionExplanation({
  decisionType,
  decision,
  confidence,
  reasoning,
  evidence,
  candidates,
}: DecisionExplanationProps) {
  const [isExpanded, setIsExpanded] = useState(false);

  const getConfidenceColor = (conf: number) => {
    if (conf >= 0.8) return 'text-green-500';
    if (conf >= 0.6) return 'text-yellow-500';
    return 'text-red-500';
  };

  const getConfidenceIcon = (conf: number) => {
    if (conf >= 0.8) return <CheckCircle className="h-4 w-4 text-green-500" />;
    return <AlertTriangle className="h-4 w-4 text-yellow-500" />;
  };

  return (
    <Card className="w-full">
      <CardHeader className="pb-2">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Brain className="h-5 w-5 text-primary" />
            <CardTitle className="text-sm font-medium">AI Decision</CardTitle>
          </div>
          <Badge variant="outline">{decisionType}</Badge>
        </div>
      </CardHeader>

      <CardContent className="space-y-4">
        {/* Decision & Confidence */}
        <div className="flex items-center justify-between p-3 bg-muted rounded-lg">
          <div>
            <p className="text-sm text-muted-foreground">Decision</p>
            <p className="font-medium">{decision}</p>
          </div>
          <div className="text-right">
            <div className="flex items-center gap-1">
              {getConfidenceIcon(confidence)}
              <span className={`text-lg font-bold ${getConfidenceColor(confidence)}`}>
                {(confidence * 100).toFixed(0)}%
              </span>
            </div>
            <p className="text-xs text-muted-foreground">Confidence</p>
          </div>
        </div>

        {/* Reasoning Summary */}
        {reasoning && (
          <div className="p-3 bg-blue-50 dark:bg-blue-950 rounded-lg">
            <p className="text-sm text-blue-800 dark:text-blue-200">{reasoning}</p>
          </div>
        )}

        {/* Expandable Details */}
        <Collapsible open={isExpanded} onOpenChange={setIsExpanded}>
          <CollapsibleTrigger className="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground">
            <ChevronDown className={`h-4 w-4 transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
            {isExpanded ? 'Hide details' : 'Show details'}
          </CollapsibleTrigger>

          <CollapsibleContent className="space-y-4 pt-4">
            {/* Evidence */}
            {evidence && evidence.length > 0 && (
              <div>
                <h4 className="text-sm font-medium mb-2">Supporting Evidence</h4>
                <div className="space-y-2">
                  {evidence.map((item, idx) => (
                    <div key={idx} className="flex items-start gap-3 p-2 border rounded">
                      <div className="flex-1">
                        <p className="text-sm font-medium">"{item.content}"</p>
                        <p className="text-xs text-muted-foreground">{item.explanation}</p>
                      </div>
                      <div className="w-16">
                        <Progress value={item.relevance * 100} className="h-2" />
                        <p className="text-xs text-center text-muted-foreground mt-1">
                          {(item.relevance * 100).toFixed(0)}%
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Candidates */}
            {candidates && candidates.length > 1 && (
              <div>
                <h4 className="text-sm font-medium mb-2">Options Considered</h4>
                <div className="space-y-2">
                  {candidates.slice(0, 5).map((candidate, idx) => (
                    <div
                      key={idx}
                      className={`flex items-center justify-between p-2 rounded ${
                        candidate.option === decision
                          ? 'bg-primary/10 border border-primary'
                          : 'bg-muted'
                      }`}
                    >
                      <span className="text-sm">{candidate.option}</span>
                      <span className="text-sm font-medium">
                        {(candidate.score * 100).toFixed(1)}%
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </CollapsibleContent>
        </Collapsible>
      </CardContent>
    </Card>
  );
}
```

## Audit Trail Viewer

```typescript
// components/ai-learning/xai/audit-trail-viewer.tsx

'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { formatDistanceToNow } from 'date-fns';
import { Download, Filter, ChevronLeft, ChevronRight } from 'lucide-react';

interface AuditEvent {
  id: string;
  eventType: string;
  actorType: string;
  actorName?: string;
  resourceType: string;
  action: string;
  createdAt: Date;
}

interface AuditTrailViewerProps {
  tenantId: string;
}

export function AuditTrailViewer({ tenantId }: AuditTrailViewerProps) {
  const [events, setEvents] = useState<AuditEvent[]>([]);
  const [total, setTotal] = useState(0);
  const [page, setPage] = useState(0);
  const [filters, setFilters] = useState({
    eventType: '',
    resourceType: '',
    search: '',
  });
  const [isLoading, setIsLoading] = useState(true);

  const pageSize = 20;

  useEffect(() => {
    fetchEvents();
  }, [page, filters]);

  const fetchEvents = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams({
        offset: String(page * pageSize),
        limit: String(pageSize),
        ...(filters.eventType && { eventType: filters.eventType }),
        ...(filters.resourceType && { resourceType: filters.resourceType }),
      });

      const res = await fetch(`/api/xai/audit-trail?${params}`);
      const data = await res.json();

      setEvents(data.events);
      setTotal(data.total);
    } catch (error) {
      console.error('Failed to fetch audit events:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const handleExport = async () => {
    const res = await fetch(`/api/xai/audit-trail/export`);
    const csv = await res.text();

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `audit-trail-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
  };

  const getEventTypeBadge = (type: string) => {
    const colors: Record<string, string> = {
      decision: 'bg-blue-100 text-blue-800',
      model_change: 'bg-purple-100 text-purple-800',
      config_change: 'bg-orange-100 text-orange-800',
      feedback: 'bg-green-100 text-green-800',
      escalation: 'bg-red-100 text-red-800',
    };
    return <Badge className={colors[type] || ''}>{type}</Badge>;
  };

  const totalPages = Math.ceil(total / pageSize);

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <CardTitle>Audit Trail</CardTitle>
          <Button variant="outline" size="sm" onClick={handleExport}>
            <Download className="h-4 w-4 mr-2" />
            Export CSV
          </Button>
        </div>
      </CardHeader>

      <CardContent>
        {/* Filters */}
        <div className="flex gap-4 mb-4">
          <Select
            value={filters.eventType}
            onValueChange={(v) => setFilters({ ...filters, eventType: v })}
          >
            <SelectTrigger className="w-40">
              <SelectValue placeholder="Event Type" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="">All Types</SelectItem>
              <SelectItem value="decision">Decision</SelectItem>
              <SelectItem value="model_change">Model Change</SelectItem>
              <SelectItem value="config_change">Config Change</SelectItem>
              <SelectItem value="feedback">Feedback</SelectItem>
              <SelectItem value="escalation">Escalation</SelectItem>
            </SelectContent>
          </Select>

          <Select
            value={filters.resourceType}
            onValueChange={(v) => setFilters({ ...filters, resourceType: v })}
          >
            <SelectTrigger className="w-40">
              <SelectValue placeholder="Resource" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="">All Resources</SelectItem>
              <SelectItem value="conversation">Conversation</SelectItem>
              <SelectItem value="model">Model</SelectItem>
              <SelectItem value="prompt">Prompt</SelectItem>
              <SelectItem value="config">Config</SelectItem>
            </SelectContent>
          </Select>

          <Input
            placeholder="Search..."
            className="max-w-xs"
            value={filters.search}
            onChange={(e) => setFilters({ ...filters, search: e.target.value })}
          />
        </div>

        {/* Table */}
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Time</TableHead>
              <TableHead>Event Type</TableHead>
              <TableHead>Actor</TableHead>
              <TableHead>Resource</TableHead>
              <TableHead>Action</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {isLoading ? (
              <TableRow>
                <TableCell colSpan={5} className="text-center py-8">
                  Loading...
                </TableCell>
              </TableRow>
            ) : events.length === 0 ? (
              <TableRow>
                <TableCell colSpan={5} className="text-center py-8 text-muted-foreground">
                  No audit events found
                </TableCell>
              </TableRow>
            ) : (
              events.map((event) => (
                <TableRow key={event.id}>
                  <TableCell className="text-sm text-muted-foreground">
                    {formatDistanceToNow(new Date(event.createdAt), { addSuffix: true })}
                  </TableCell>
                  <TableCell>{getEventTypeBadge(event.eventType)}</TableCell>
                  <TableCell>
                    <span className="text-sm">
                      {event.actorName || event.actorType}
                    </span>
                  </TableCell>
                  <TableCell className="text-sm">{event.resourceType}</TableCell>
                  <TableCell className="text-sm font-medium">{event.action}</TableCell>
                </TableRow>
              ))
            )}
          </TableBody>
        </Table>

        {/* Pagination */}
        <div className="flex items-center justify-between mt-4">
          <p className="text-sm text-muted-foreground">
            Showing {page * pageSize + 1}-{Math.min((page + 1) * pageSize, total)} of {total}
          </p>
          <div className="flex gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setPage(p => Math.max(0, p - 1))}
              disabled={page === 0}
            >
              <ChevronLeft className="h-4 w-4" />
            </Button>
            <Button
              variant="outline"
              size="sm"
              onClick={() => setPage(p => Math.min(totalPages - 1, p + 1))}
              disabled={page >= totalPages - 1}
            >
              <ChevronRight className="h-4 w-4" />
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

## Conversation Explainer

```typescript
// components/ai-learning/xai/conversation-explainer.tsx

'use client';

import { useEffect, useState } from 'react';
import { DecisionExplanation } from './decision-explanation';
import { Skeleton } from '@/components/ui/skeleton';

interface ConversationExplainerProps {
  conversationId: string;
}

export function ConversationExplainer({ conversationId }: ConversationExplainerProps) {
  const [decisions, setDecisions] = useState<any[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    fetchDecisions();
  }, [conversationId]);

  const fetchDecisions = async () => {
    setIsLoading(true);
    try {
      const res = await fetch(`/api/xai/decisions?conversationId=${conversationId}`);
      const data = await res.json();
      setDecisions(data.decisions || []);
    } catch (error) {
      console.error('Failed to fetch decisions:', error);
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading) {
    return (
      <div className="space-y-4">
        <Skeleton className="h-48 w-full" />
        <Skeleton className="h-48 w-full" />
      </div>
    );
  }

  if (decisions.length === 0) {
    return (
      <div className="text-center py-8 text-muted-foreground">
        No AI decisions recorded for this conversation
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <h3 className="text-lg font-semibold">AI Decision Timeline</h3>
      {decisions.map((decision) => (
        <DecisionExplanation
          key={decision.id}
          decisionLogId={decision.id}
          decisionType={decision.decisionType}
          decision={decision.decision}
          confidence={decision.confidence}
          reasoning={decision.reasoning}
          evidence={decision.evidence?.evidenceItems}
          candidates={decision.candidates}
        />
      ))}
    </div>
  );
}
```

## Fin de FASE-6 y Documentación Completa

Con este documento se completa la documentación de FASE-6 Explainability (XAI) y toda la documentación maestra de AI Learning 2.0.

## Resumen de Documentos Creados

- **FASE-1 RLHF**: 1.1-1.6 (Schema, API, UI, Aggregator, Optimizer, Testing)
- **FASE-2 Embeddings**: 2.1-2.5 (Service, Vector Store, Semantic Search, Migration, Testing)
- **FASE-3 Drift**: 3.1-3.4 (Metrics Collector, Statistical Tests, Alert System, Dashboard)
- **FASE-4 Feature Store**: 4.1-4.4 (Schema, Offline Store, Online Store, Pipeline)
- **FASE-5 Fine-tuning**: 5.1-5.4 (Data Prep, Training Pipeline, Evaluation, Deployment)
- **FASE-6 XAI**: 6.1-6.4 (Decision Logger, Evidence Extractor, Audit Trail, UI)

Consulta [00-INDICE-MAESTRO.md](../00-INDICE-MAESTRO.md) para navegación completa.
