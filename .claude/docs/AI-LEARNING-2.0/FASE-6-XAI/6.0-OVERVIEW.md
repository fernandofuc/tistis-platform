# ğŸ” FASE 6: Explainability (XAI)

## Sistema de Explicabilidad para Decisiones de AI

**Documento:** 6.0-OVERVIEW.md
**Fase:** 6 - Explainable AI (XAI)
**DuraciÃ³n estimada:** 6-8 semanas
**Costo adicional:** ~$0/mes (usa infraestructura existente)

---

## ğŸ“‹ Ãndice

1. [Objetivo](#objetivo)
2. [Â¿Por quÃ© XAI?](#por-quÃ©-xai)
3. [Arquitectura](#arquitectura)
4. [Microfases](#microfases)
5. [Tipos de Explicaciones](#tipos-de-explicaciones)
6. [ImplementaciÃ³n de Alto Nivel](#implementaciÃ³n-de-alto-nivel)
7. [Checklist General](#checklist-general)

---

## ğŸ¯ Objetivo

Implementar un sistema de explicabilidad que permita entender y auditar todas las decisiones tomadas por el AI, mejorando la confianza del usuario y facilitando la depuraciÃ³n.

### Principio Fundamental

> **"Toda decisiÃ³n de AI debe ser explicable en tÃ©rminos que un humano pueda entender."**

---

## ğŸ’¡ Â¿Por quÃ© XAI?

### Beneficios

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    XAI BENEFITS                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. TRUST                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  User: "Â¿Por quÃ© me recomendaste este horario?"          â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  AI: "Te recomendÃ© las 10am porque:                      â”‚   â”‚
â”‚  â”‚       â€¢ Es tu horario habitual de citas (historial)      â”‚   â”‚
â”‚  â”‚       â€¢ El Dr. GarcÃ­a tiene disponibilidad               â”‚   â”‚
â”‚  â”‚       â€¢ Menor tiempo de espera (15 min promedio)"        â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  Result: User trusts the recommendation âœ…               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  2. DEBUGGING                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Problem: AI clasificÃ³ "precio" como "complaint"         â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  XAI Log:                                                â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Intent: complaint (confidence: 0.67)                â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Evidence: "muy caro" matched complaint pattern      â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Embedding similarity: pricing=0.61, complaint=0.67  â”‚   â”‚
â”‚  â”‚  â””â”€â”€ Decision: complaint (margin: 0.06)                  â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  Fix: Add "caro/barato" to pricing patterns              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  3. COMPLIANCE                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Audit requirement: Why was this booking denied?         â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  XAI Audit Trail:                                        â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Timestamp: 2026-01-23T10:30:00Z                    â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Decision: booking_denied                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Reasons:                                            â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ Policy: 24h advance booking required           â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€â”€ Requested: same-day booking                    â”‚   â”‚
â”‚  â”‚  â””â”€â”€ Policy reference: booking_policy_v2.3              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  4. IMPROVEMENT                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Analytics: What patterns lead to negative feedback?     â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  XAI Analysis:                                           â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ 45% of negative feedback on "pricing" intent       â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Common explanation gap: "no price list shown"      â”‚   â”‚
â”‚  â”‚  â””â”€â”€ Recommendation: Include prices in response         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ Arquitectura

### Sistema de Explicabilidad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    XAI ARCHITECTURE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  [AI Decision Point]                                               â”‚
â”‚         â”‚                                                           â”‚
â”‚         â–¼                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚  Decision Logger  â”‚  (Capture all decisions)                    â”‚
â”‚  â”‚                   â”‚                                             â”‚
â”‚  â”‚  â”œâ”€â”€ Input        â”‚                                             â”‚
â”‚  â”‚  â”œâ”€â”€ Output       â”‚                                             â”‚
â”‚  â”‚  â”œâ”€â”€ Confidence   â”‚                                             â”‚
â”‚  â”‚  â”œâ”€â”€ Alternatives â”‚                                             â”‚
â”‚  â”‚  â””â”€â”€ Context      â”‚                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚            â”‚                                                        â”‚
â”‚            â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚ Evidence Extractorâ”‚  (Why this decision?)                       â”‚
â”‚  â”‚                   â”‚                                             â”‚
â”‚  â”‚  â”œâ”€â”€ Feature      â”‚                                             â”‚
â”‚  â”‚  â”‚   importance   â”‚                                             â”‚
â”‚  â”‚  â”œâ”€â”€ Similar      â”‚                                             â”‚
â”‚  â”‚  â”‚   examples     â”‚                                             â”‚
â”‚  â”‚  â”œâ”€â”€ Rule         â”‚                                             â”‚
â”‚  â”‚  â”‚   matches      â”‚                                             â”‚
â”‚  â”‚  â””â”€â”€ Threshold    â”‚                                             â”‚
â”‚  â”‚      analysis     â”‚                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚            â”‚                                                        â”‚
â”‚            â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚ Explanation       â”‚  (Human-readable)                           â”‚
â”‚  â”‚ Generator         â”‚                                             â”‚
â”‚  â”‚                   â”‚                                             â”‚
â”‚  â”‚  â”œâ”€â”€ Technical    â”‚ â†’ For developers                            â”‚
â”‚  â”‚  â”œâ”€â”€ Business     â”‚ â†’ For admins                                â”‚
â”‚  â”‚  â””â”€â”€ User-facing  â”‚ â†’ For end users                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚            â”‚                                                        â”‚
â”‚         â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚         â”‚                     â”‚                                     â”‚
â”‚         â–¼                     â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚ Audit     â”‚         â”‚ User      â”‚                              â”‚
â”‚  â”‚ Trail     â”‚         â”‚ Display   â”‚                              â”‚
â”‚  â”‚ (Storage) â”‚         â”‚ (UI)      â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Estructura de Archivos

```
src/features/ai/xai/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ decision-logger.service.ts      # Logging de decisiones
â”‚   â”œâ”€â”€ evidence-extractor.service.ts   # ExtracciÃ³n de evidencia
â”‚   â”œâ”€â”€ explanation-generator.service.ts# GeneraciÃ³n de explicaciones
â”‚   â””â”€â”€ audit-trail.service.ts          # Trail de auditorÃ­a
â”œâ”€â”€ extractors/
â”‚   â”œâ”€â”€ feature-importance.ts           # Importancia de features
â”‚   â”œâ”€â”€ similar-examples.ts             # Ejemplos similares
â”‚   â”œâ”€â”€ rule-matcher.ts                 # Matching de reglas
â”‚   â””â”€â”€ counterfactual.ts               # AnÃ¡lisis contrafactual
â”œâ”€â”€ generators/
â”‚   â”œâ”€â”€ technical-explanation.ts        # Para devs
â”‚   â”œâ”€â”€ business-explanation.ts         # Para admins
â”‚   â””â”€â”€ user-explanation.ts             # Para usuarios
â”œâ”€â”€ types/
â”‚   â””â”€â”€ xai.types.ts
â””â”€â”€ ui/
    â”œâ”€â”€ ExplanationCard.tsx             # Componente de explicaciÃ³n
    â””â”€â”€ AuditTrailViewer.tsx            # Visor de audit trail
```

---

## ğŸ“¦ Microfases

### 6.1 Decision Logging (1.5 semanas)

```
Objetivo: Capturar todas las decisiones de AI

Entregables:
â”œâ”€â”€ DecisionLoggerService
â”œâ”€â”€ Decision schema (DB)
â”œâ”€â”€ Integration points en LangGraph
â”œâ”€â”€ Async logging (no impact on latency)
â””â”€â”€ Retention policies

Decisiones a loguear:
â”œâ”€â”€ Intent classification
â”œâ”€â”€ Agent routing
â”œâ”€â”€ Response generation
â”œâ”€â”€ Tool selection
â”œâ”€â”€ Escalation decisions
â””â”€â”€ Booking confirmations
```

### 6.2 Evidence Extraction (2 semanas)

```
Objetivo: Extraer evidencia para cada decisiÃ³n

Entregables:
â”œâ”€â”€ EvidenceExtractorService
â”œâ”€â”€ Feature importance calculator
â”œâ”€â”€ Similar examples finder
â”œâ”€â”€ Rule matcher
â”œâ”€â”€ Counterfactual analyzer
â””â”€â”€ Evidence aggregator

Tipos de evidencia:
â”œâ”€â”€ Feature contributions
â”œâ”€â”€ Similarity scores
â”œâ”€â”€ Matched patterns/rules
â”œâ”€â”€ Threshold margins
â”œâ”€â”€ Alternative decisions
â””â”€â”€ Historical precedents
```

### 6.3 UI Explanations (2 semanas)

```
Objetivo: Mostrar explicaciones a usuarios

Entregables:
â”œâ”€â”€ ExplanationGeneratorService
â”œâ”€â”€ ExplanationCard component
â”œâ”€â”€ User-facing explanations
â”œâ”€â”€ Admin explanations
â”œâ”€â”€ Integration con chat UI
â””â”€â”€ Feedback mechanism

Formatos:
â”œâ”€â”€ Inline hints ("basado en tu historial...")
â”œâ”€â”€ Expandable cards
â”œâ”€â”€ Full explanation modal
â””â”€â”€ Debug mode (for admins)
```

### 6.4 Audit Trail (2 semanas)

```
Objetivo: Sistema completo de auditorÃ­a

Entregables:
â”œâ”€â”€ AuditTrailService
â”œâ”€â”€ AuditTrailViewer component
â”œâ”€â”€ Search and filter
â”œâ”€â”€ Export functionality
â”œâ”€â”€ Retention management
â””â”€â”€ Compliance reports

Funcionalidades:
â”œâ”€â”€ Time-based queries
â”œâ”€â”€ Entity-based queries
â”œâ”€â”€ Decision type filters
â”œâ”€â”€ Outcome filters
â”œâ”€â”€ Export to CSV/PDF
â””â”€â”€ Compliance templates
```

---

## ğŸ¯ Tipos de Explicaciones

### 1. ExplicaciÃ³n de ClasificaciÃ³n

```typescript
interface ClassificationExplanation {
  decision: {
    type: 'intent_classification';
    result: 'scheduling';
    confidence: 0.89;
  };

  evidence: {
    // Top contributing features
    feature_importance: [
      { feature: 'keyword:cita', contribution: 0.35 },
      { feature: 'keyword:agendar', contribution: 0.28 },
      { feature: 'embedding_similarity', contribution: 0.26 },
    ];

    // Similar examples from training
    similar_examples: [
      { text: 'Quiero una cita', similarity: 0.94, intent: 'scheduling' },
      { text: 'Necesito agendar', similarity: 0.91, intent: 'scheduling' },
    ];

    // Alternative classifications
    alternatives: [
      { intent: 'inquiry', confidence: 0.08 },
      { intent: 'pricing', confidence: 0.03 },
    ];

    // Decision margin
    margin: {
      first_vs_second: 0.81, // 0.89 - 0.08
      above_threshold: true,
      threshold_used: 0.65,
    };
  };

  // Human-readable
  explanations: {
    technical: "Classified as 'scheduling' based on keyword matches ('cita': 0.35, 'agendar': 0.28) and embedding similarity (0.26). Confidence 0.89 exceeds threshold 0.65.",

    business: "El mensaje fue identificado como solicitud de cita con 89% de confianza. Las palabras clave 'cita' y 'agendar' fueron determinantes.",

    user: "EntendÃ­ que quieres agendar una cita. Â¿Es correcto?",
  };
}
```

### 2. ExplicaciÃ³n de Respuesta

```typescript
interface ResponseExplanation {
  decision: {
    type: 'response_generation';
    response_id: 'resp_123';
  };

  evidence: {
    // Context used
    context_documents: [
      { title: 'Horarios de atenciÃ³n', relevance: 0.92 },
      { title: 'PolÃ­tica de citas', relevance: 0.78 },
    ];

    // Template/prompt used
    prompt_version: 'response.scheduling.v2';
    prompt_experiment: 'exp_456';
    prompt_variant: 'variant_a';

    // Similar historical responses
    similar_responses: [
      { response: 'Â¡Perfecto! Te ayudo...', satisfaction: 4.8 },
    ];

    // Factors considered
    factors: [
      { factor: 'user_history', impact: 'preferred_morning_slots' },
      { factor: 'availability', impact: 'slots_available_today' },
    ];
  };

  explanations: {
    technical: "Generated using prompt 'response.scheduling.v2' (variant_a). Context from 2 documents (Horarios: 0.92, PolÃ­tica: 0.78). Similar responses had 4.8 avg satisfaction.",

    business: "Respuesta generada usando el template de agendamiento v2. Se considerÃ³ el historial del usuario (prefiere maÃ±anas) y disponibilidad actual.",

    user: null, // Not shown to users for responses
  };
}
```

### 3. ExplicaciÃ³n de EscalaciÃ³n

```typescript
interface EscalationExplanation {
  decision: {
    type: 'escalation';
    escalated: true;
    to: 'human_agent';
  };

  evidence: {
    // Trigger conditions
    triggers: [
      { condition: 'complaint_detected', value: true },
      { condition: 'sentiment_negative', value: -0.7 },
      { condition: 'retry_count', value: 2, threshold: 3 },
    ];

    // Policy applied
    policy: {
      name: 'complaint_escalation_policy',
      version: '1.2',
      rule: 'IF complaint AND sentiment < -0.5 THEN escalate',
    };

    // Alternative actions considered
    alternatives: [
      { action: 'retry_response', reason_rejected: 'sentiment_too_negative' },
      { action: 'offer_callback', reason_rejected: 'complaint_severity' },
    ];
  };

  explanations: {
    technical: "Escalated due to complaint detection (true) AND negative sentiment (-0.7 < -0.5). Policy 'complaint_escalation_policy' v1.2 triggered.",

    business: "ConversaciÃ³n escalada a agente humano. Se detectÃ³ una queja con sentimiento negativo (-0.7). SegÃºn la polÃ­tica de escalaciÃ³n, esto requiere atenciÃ³n humana.",

    user: "Entiendo tu frustraciÃ³n. Te voy a conectar con un agente para ayudarte mejor.",
  };
}
```

---

## ğŸ’» ImplementaciÃ³n de Alto Nivel

### Schema de Base de Datos

```sql
-- Decision logs
CREATE TABLE ai_decision_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id),

  -- Decision context
  conversation_id UUID,
  message_id UUID,
  timestamp TIMESTAMPTZ DEFAULT NOW(),

  -- Decision details
  decision_type TEXT NOT NULL, -- 'classification', 'routing', 'response', 'escalation'
  decision_result JSONB NOT NULL,
  confidence FLOAT,

  -- Evidence
  evidence JSONB NOT NULL,

  -- Explanations
  explanation_technical TEXT,
  explanation_business TEXT,
  explanation_user TEXT,

  -- Performance
  processing_time_ms INT,

  -- Indexes for querying
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Audit trail (immutable)
CREATE TABLE ai_audit_trail (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES tenants(id),

  -- Audit entry
  event_type TEXT NOT NULL,
  event_timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  actor_type TEXT NOT NULL, -- 'ai', 'user', 'admin', 'system'
  actor_id TEXT,

  -- Decision reference
  decision_log_id UUID REFERENCES ai_decision_logs(id),

  -- Event details
  action TEXT NOT NULL,
  entity_type TEXT,
  entity_id TEXT,
  old_value JSONB,
  new_value JSONB,

  -- Compliance
  ip_address INET,
  user_agent TEXT,

  -- Immutable
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_decision_logs_tenant ON ai_decision_logs(tenant_id, created_at DESC);
CREATE INDEX idx_decision_logs_conversation ON ai_decision_logs(conversation_id);
CREATE INDEX idx_decision_logs_type ON ai_decision_logs(tenant_id, decision_type);

CREATE INDEX idx_audit_trail_tenant ON ai_audit_trail(tenant_id, event_timestamp DESC);
CREATE INDEX idx_audit_trail_entity ON ai_audit_trail(entity_type, entity_id);
CREATE INDEX idx_audit_trail_decision ON ai_audit_trail(decision_log_id);

-- Prevent modifications to audit trail
CREATE OR REPLACE FUNCTION prevent_audit_modification()
RETURNS TRIGGER AS $$
BEGIN
  RAISE EXCEPTION 'Audit trail is immutable. Cannot modify or delete entries.';
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER audit_trail_immutable
  BEFORE UPDATE OR DELETE ON ai_audit_trail
  FOR EACH ROW EXECUTE FUNCTION prevent_audit_modification();
```

### Decision Logger Service

```typescript
// src/features/ai/xai/services/decision-logger.service.ts

interface DecisionLog {
  tenant_id: string;
  conversation_id?: string;
  message_id?: string;
  decision_type: 'classification' | 'routing' | 'response' | 'escalation' | 'tool_call';
  decision_result: unknown;
  confidence?: number;
  evidence: Evidence;
  processing_time_ms: number;
}

interface Evidence {
  feature_importance?: FeatureContribution[];
  similar_examples?: SimilarExample[];
  alternatives?: Alternative[];
  context_documents?: ContextDocument[];
  policy_applied?: PolicyReference;
  triggers?: Trigger[];
}

class DecisionLoggerService {
  private supabase: SupabaseClient;
  private explanationGenerator: ExplanationGeneratorService;
  private queue: DecisionLog[] = [];
  private flushInterval: NodeJS.Timeout;

  constructor() {
    // Batch insert for performance
    this.flushInterval = setInterval(() => this.flush(), 1000);
  }

  /**
   * Log a decision (non-blocking)
   */
  async log(decision: Omit<DecisionLog, 'evidence'>, evidence: Evidence): Promise<void> {
    const log: DecisionLog = {
      ...decision,
      evidence,
    };

    // Generate explanations
    const explanations = await this.explanationGenerator.generate(log);

    this.queue.push({
      ...log,
      explanation_technical: explanations.technical,
      explanation_business: explanations.business,
      explanation_user: explanations.user,
    });
  }

  /**
   * Flush queue to database
   */
  private async flush(): Promise<void> {
    if (this.queue.length === 0) return;

    const batch = this.queue.splice(0, 100);

    try {
      await this.supabase
        .from('ai_decision_logs')
        .insert(batch);
    } catch (error) {
      console.error('[DecisionLogger] Flush error:', error);
      // Re-add to queue for retry
      this.queue.unshift(...batch);
    }
  }

  /**
   * Get decisions for a conversation
   */
  async getForConversation(conversationId: string): Promise<DecisionLog[]> {
    const { data } = await this.supabase
      .from('ai_decision_logs')
      .select('*')
      .eq('conversation_id', conversationId)
      .order('timestamp', { ascending: true });

    return data ?? [];
  }

  /**
   * Search decisions
   */
  async search(params: {
    tenant_id: string;
    decision_type?: string;
    start_date?: Date;
    end_date?: Date;
    limit?: number;
  }): Promise<DecisionLog[]> {
    let query = this.supabase
      .from('ai_decision_logs')
      .select('*')
      .eq('tenant_id', params.tenant_id);

    if (params.decision_type) {
      query = query.eq('decision_type', params.decision_type);
    }

    if (params.start_date) {
      query = query.gte('created_at', params.start_date.toISOString());
    }

    if (params.end_date) {
      query = query.lte('created_at', params.end_date.toISOString());
    }

    const { data } = await query
      .order('created_at', { ascending: false })
      .limit(params.limit ?? 100);

    return data ?? [];
  }
}
```

### UI Component

```tsx
// src/features/ai/xai/ui/ExplanationCard.tsx

interface ExplanationCardProps {
  decisionLog: DecisionLog;
  mode: 'user' | 'business' | 'technical';
  onFeedback?: (helpful: boolean) => void;
}

export function ExplanationCard({ decisionLog, mode, onFeedback }: ExplanationCardProps) {
  const [expanded, setExpanded] = useState(false);

  const explanation = mode === 'user'
    ? decisionLog.explanation_user
    : mode === 'business'
    ? decisionLog.explanation_business
    : decisionLog.explanation_technical;

  if (!explanation && mode === 'user') {
    return null; // Don't show to users if no user-facing explanation
  }

  return (
    <div className="explanation-card">
      <div className="explanation-header">
        <span className="decision-type">{decisionLog.decision_type}</span>
        {decisionLog.confidence && (
          <span className="confidence">
            {(decisionLog.confidence * 100).toFixed(0)}% confidence
          </span>
        )}
        <button onClick={() => setExpanded(!expanded)}>
          {expanded ? 'Less' : 'More'}
        </button>
      </div>

      <div className="explanation-content">
        <p>{explanation}</p>
      </div>

      {expanded && mode !== 'user' && (
        <div className="evidence-section">
          {decisionLog.evidence.feature_importance && (
            <FeatureImportanceChart
              data={decisionLog.evidence.feature_importance}
            />
          )}

          {decisionLog.evidence.similar_examples && (
            <SimilarExamplesList
              examples={decisionLog.evidence.similar_examples}
            />
          )}

          {decisionLog.evidence.alternatives && (
            <AlternativesList
              alternatives={decisionLog.evidence.alternatives}
            />
          )}
        </div>
      )}

      {onFeedback && (
        <div className="feedback-section">
          <span>Was this explanation helpful?</span>
          <button onClick={() => onFeedback(true)}>ğŸ‘</button>
          <button onClick={() => onFeedback(false)}>ğŸ‘</button>
        </div>
      )}
    </div>
  );
}
```

---

## âœ… Checklist General

```
â–¡ FASE 6.1: Decision Logging
â”œâ”€â”€ [ ] Decision schema design
â”œâ”€â”€ [ ] DecisionLoggerService
â”œâ”€â”€ [ ] Async logging (non-blocking)
â”œâ”€â”€ [ ] Integration with LangGraph
â”œâ”€â”€ [ ] Retention policies
â””â”€â”€ [ ] Unit tests

â–¡ FASE 6.2: Evidence Extraction
â”œâ”€â”€ [ ] EvidenceExtractorService
â”œâ”€â”€ [ ] Feature importance calculator
â”œâ”€â”€ [ ] Similar examples finder
â”œâ”€â”€ [ ] Rule matcher
â”œâ”€â”€ [ ] Counterfactual analyzer
â””â”€â”€ [ ] Integration tests

â–¡ FASE 6.3: UI Explanations
â”œâ”€â”€ [ ] ExplanationGeneratorService
â”œâ”€â”€ [ ] ExplanationCard component
â”œâ”€â”€ [ ] User-facing explanations
â”œâ”€â”€ [ ] Admin explanations
â”œâ”€â”€ [ ] Technical explanations
â”œâ”€â”€ [ ] Feedback mechanism
â””â”€â”€ [ ] E2E tests

â–¡ FASE 6.4: Audit Trail
â”œâ”€â”€ [ ] AuditTrailService
â”œâ”€â”€ [ ] Immutable storage
â”œâ”€â”€ [ ] AuditTrailViewer
â”œâ”€â”€ [ ] Search and filter
â”œâ”€â”€ [ ] Export functionality
â”œâ”€â”€ [ ] Compliance reports
â””â”€â”€ [ ] Performance tests
```

---

## ğŸ“š Documentos Detallados

- [6.1-DECISION-LOGGING.md](./6.1-DECISION-LOGGING.md) ğŸ“ Pendiente
- [6.2-EVIDENCE-EXTRACTION.md](./6.2-EVIDENCE-EXTRACTION.md) ğŸ“ Pendiente
- [6.3-UI-EXPLANATIONS.md](./6.3-UI-EXPLANATIONS.md) ğŸ“ Pendiente
- [6.4-AUDIT-TRAIL.md](./6.4-AUDIT-TRAIL.md) ğŸ“ Pendiente

---

## ğŸ‰ DOCUMENTACIÃ“N AI LEARNING 2.0 COMPLETADA

Esta documentaciÃ³n cubre las 6 fases principales del proyecto de mejora del AI Learning de TIS TIS:

1. **FASE 1: RLHF** âœ… - Sistema de feedback humano
2. **FASE 2: Embeddings** âœ… - BÃºsqueda semÃ¡ntica
3. **FASE 3: Drift Detection** âœ… - DetecciÃ³n de degradaciÃ³n
4. **FASE 4: Feature Store** âœ… - Almacenamiento de features
5. **FASE 5: Fine-tuning** âœ… - Modelo personalizado
6. **FASE 6: XAI** âœ… - Explicabilidad

---

**Regresar a:** [RESUMEN-EJECUTIVO.md](../RESUMEN-EJECUTIVO.md)
