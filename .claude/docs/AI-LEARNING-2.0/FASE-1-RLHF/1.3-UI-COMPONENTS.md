# ğŸ¨ FASE 1.3: UI Components para Feedback

## Documento de ImplementaciÃ³n

**VersiÃ³n:** 1.0.0
**DuraciÃ³n estimada:** 1 semana
**Dependencias:** 1.2-API-FEEDBACK (completado)
**Output:** Componentes React para captura de feedback

---

## 1. OBJETIVO

Crear los componentes de UI que permiten a los usuarios:
1. Ver botones ğŸ‘/ğŸ‘ junto a cada respuesta del AI
2. Dar feedback con un click
3. Opcionalmente agregar comentario detallado
4. Ver confirmaciÃ³n de su feedback

---

## 2. DISEÃ‘O DE UI/UX

### 2.1 Wireframes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ESTADO INICIAL - Sin feedback                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Mensaje del AI                                  â”‚ â”‚
â”‚  â”‚  "Hola! Tenemos citas disponibles maÃ±ana a las 10am o 3pm.        â”‚ â”‚
â”‚  â”‚   Â¿CuÃ¡l te funciona mejor?"                                       â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”                                               â”‚ â”‚
â”‚  â”‚  â”‚  ğŸ‘  â”‚  â”‚  ğŸ‘  â”‚    â† Botones de feedback (siempre visibles)   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ESTADO - Feedback positivo dado                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Mensaje del AI                                  â”‚ â”‚
â”‚  â”‚  "Hola! Tenemos citas disponibles maÃ±ana a las 10am o 3pm..."     â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”                                               â”‚ â”‚
â”‚  â”‚  â”‚  ğŸ‘  â”‚  â”‚  ğŸ‘  â”‚    â† ğŸ‘ con fondo verde, ğŸ‘ deshabilitado     â”‚ â”‚
â”‚  â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆ â”‚  â”‚      â”‚                                               â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜                                               â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚  âœ“ Â¡Gracias por tu feedback!                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MODAL - Feedback negativo (opcional)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                          [X]      â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚  Â¿QuÃ© estuvo mal con esta respuesta?                              â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚  â—‹ InformaciÃ³n incorrecta                                         â”‚ â”‚
â”‚  â”‚  â—‹ Respuesta incompleta                                           â”‚ â”‚
â”‚  â”‚  â—‹ Tono inapropiado                                               â”‚ â”‚
â”‚  â”‚  â—‹ Otro                                                           â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ CuÃ©ntanos mÃ¡s (opcional)                                    â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                                                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚ â”‚
â”‚  â”‚  â”‚    Cancelar     â”‚  â”‚     Enviar      â”‚                         â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Estados del Componente

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ESTADOS DEL FEEDBACK BUTTONS                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Estado: IDLE (inicial)                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  â€¢ Ambos botones habilitados                                           â”‚
â”‚  â€¢ Sin highlight                                                        â”‚
â”‚  â€¢ Sin mensaje de confirmaciÃ³n                                         â”‚
â”‚                                                                         â”‚
â”‚  Estado: LOADING                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  â€¢ Ambos botones deshabilitados                                        â”‚
â”‚  â€¢ Spinner en el botÃ³n clickeado                                       â”‚
â”‚                                                                         â”‚
â”‚  Estado: POSITIVE_GIVEN                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  â€¢ ğŸ‘ con fondo verde, seleccionado                                    â”‚
â”‚  â€¢ ğŸ‘ clickeable (para cambiar opiniÃ³n)                                â”‚
â”‚  â€¢ Mensaje: "Â¡Gracias por tu feedback!"                                â”‚
â”‚                                                                         â”‚
â”‚  Estado: NEGATIVE_GIVEN                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  â€¢ ğŸ‘ con fondo rojo, seleccionado                                     â”‚
â”‚  â€¢ ğŸ‘ clickeable (para cambiar opiniÃ³n)                                â”‚
â”‚  â€¢ Mensaje: "Gracias, trabajaremos en mejorar"                         â”‚
â”‚                                                                         â”‚
â”‚  Estado: ERROR                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  â€¢ Ambos botones habilitados                                           â”‚
â”‚  â€¢ Mensaje de error temporal                                           â”‚
â”‚  â€¢ Auto-dismiss despuÃ©s de 3 segundos                                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. IMPLEMENTACIÃ“N

### 3.1 Archivo: `src/components/feedback/FeedbackButtons.tsx`

```tsx
// =====================================================
// TIS TIS PLATFORM - Feedback Buttons Component
// Botones ğŸ‘/ğŸ‘ para calificar respuestas del AI
// =====================================================

'use client';

import { useState, useCallback } from 'react';
import { ThumbsUp, ThumbsDown, Loader2 } from 'lucide-react';
import { cn } from '@/src/shared/lib/utils';
import { useAuth } from '@/src/features/auth';
import { FeedbackModal } from './FeedbackModal';
import type { FeedbackRating, FeedbackCategory } from '@/src/features/ai/types/rlhf.types';

// ======================
// TYPES
// ======================

interface FeedbackButtonsProps {
  /** ID del mensaje del AI */
  messageId: string;
  /** Feedback existente (si ya se dio) */
  existingFeedback?: {
    rating: FeedbackRating;
    feedback_text?: string;
  } | null;
  /** TamaÃ±o de los botones */
  size?: 'sm' | 'md' | 'lg';
  /** Mostrar labels junto a iconos */
  showLabels?: boolean;
  /** Callback cuando se da feedback */
  onFeedbackGiven?: (rating: FeedbackRating) => void;
  /** Clase CSS adicional */
  className?: string;
}

type FeedbackState = 'idle' | 'loading' | 'positive' | 'negative' | 'error';

// ======================
// CONSTANTS
// ======================

const SIZE_CLASSES = {
  sm: 'h-6 w-6 text-xs',
  md: 'h-8 w-8 text-sm',
  lg: 'h-10 w-10 text-base',
};

const ICON_SIZE = {
  sm: 14,
  md: 18,
  lg: 22,
};

// ======================
// COMPONENT
// ======================

export function FeedbackButtons({
  messageId,
  existingFeedback,
  size = 'md',
  showLabels = false,
  onFeedbackGiven,
  className,
}: FeedbackButtonsProps) {
  const { session } = useAuth();

  // State
  const [state, setState] = useState<FeedbackState>(
    existingFeedback?.rating === 'up'
      ? 'positive'
      : existingFeedback?.rating === 'down'
      ? 'negative'
      : 'idle'
  );
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [errorMessage, setErrorMessage] = useState<string | null>(null);
  const [pendingRating, setPendingRating] = useState<FeedbackRating | null>(null);

  // ======================
  // HANDLERS
  // ======================

  const submitFeedback = useCallback(
    async (
      rating: FeedbackRating,
      feedbackText?: string,
      feedbackCategory?: FeedbackCategory
    ) => {
      if (!session?.access_token) {
        setErrorMessage('Debes iniciar sesiÃ³n para dar feedback');
        setState('error');
        return false;
      }

      setState('loading');
      setErrorMessage(null);

      try {
        const response = await fetch('/api/rlhf/feedback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${session.access_token}`,
          },
          body: JSON.stringify({
            message_id: messageId,
            rating,
            feedback_text: feedbackText,
            feedback_category: feedbackCategory,
          }),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Error al enviar feedback');
        }

        // Success
        setState(rating === 'up' ? 'positive' : 'negative');
        onFeedbackGiven?.(rating);
        return true;
      } catch (error) {
        const message = error instanceof Error ? error.message : 'Error desconocido';
        setErrorMessage(message);
        setState('error');

        // Auto-clear error after 3 seconds
        setTimeout(() => {
          if (state === 'error') {
            setState('idle');
            setErrorMessage(null);
          }
        }, 3000);

        return false;
      }
    },
    [messageId, session?.access_token, onFeedbackGiven, state]
  );

  const handleThumbsUp = useCallback(async () => {
    if (state === 'loading') return;

    // Si ya era positivo, no hacer nada
    if (state === 'positive') return;

    // Enviar feedback positivo directamente (sin modal)
    await submitFeedback('up');
  }, [state, submitFeedback]);

  const handleThumbsDown = useCallback(() => {
    if (state === 'loading') return;

    // Si ya era negativo, no hacer nada
    if (state === 'negative') return;

    // Abrir modal para feedback negativo
    setPendingRating('down');
    setIsModalOpen(true);
  }, [state]);

  const handleModalSubmit = useCallback(
    async (feedbackText?: string, feedbackCategory?: FeedbackCategory) => {
      if (pendingRating) {
        const success = await submitFeedback(pendingRating, feedbackText, feedbackCategory);
        if (success) {
          setIsModalOpen(false);
          setPendingRating(null);
        }
      }
    },
    [pendingRating, submitFeedback]
  );

  const handleModalCancel = useCallback(() => {
    setIsModalOpen(false);
    setPendingRating(null);
    setState('idle');
  }, []);

  // ======================
  // RENDER
  // ======================

  const isLoading = state === 'loading';
  const isPositive = state === 'positive';
  const isNegative = state === 'negative';

  return (
    <>
      <div className={cn('flex items-center gap-2', className)}>
        {/* Thumbs Up Button */}
        <button
          onClick={handleThumbsUp}
          disabled={isLoading}
          className={cn(
            'flex items-center justify-center rounded-lg border transition-all duration-200',
            SIZE_CLASSES[size],
            isPositive
              ? 'bg-green-100 border-green-300 text-green-600'
              : 'bg-white border-slate-200 text-slate-400 hover:bg-slate-50 hover:text-slate-600 hover:border-slate-300',
            isLoading && 'opacity-50 cursor-not-allowed'
          )}
          title="Esta respuesta fue Ãºtil"
          aria-label="Marcar como Ãºtil"
        >
          {isLoading && pendingRating === 'up' ? (
            <Loader2 className="animate-spin" size={ICON_SIZE[size]} />
          ) : (
            <ThumbsUp
              size={ICON_SIZE[size]}
              className={cn(isPositive && 'fill-current')}
            />
          )}
        </button>

        {showLabels && (
          <span className={cn('text-slate-500', size === 'sm' && 'text-xs')}>
            Ãštil
          </span>
        )}

        {/* Thumbs Down Button */}
        <button
          onClick={handleThumbsDown}
          disabled={isLoading}
          className={cn(
            'flex items-center justify-center rounded-lg border transition-all duration-200',
            SIZE_CLASSES[size],
            isNegative
              ? 'bg-red-100 border-red-300 text-red-600'
              : 'bg-white border-slate-200 text-slate-400 hover:bg-slate-50 hover:text-slate-600 hover:border-slate-300',
            isLoading && 'opacity-50 cursor-not-allowed'
          )}
          title="Esta respuesta no fue Ãºtil"
          aria-label="Marcar como no Ãºtil"
        >
          {isLoading && pendingRating === 'down' ? (
            <Loader2 className="animate-spin" size={ICON_SIZE[size]} />
          ) : (
            <ThumbsDown
              size={ICON_SIZE[size]}
              className={cn(isNegative && 'fill-current')}
            />
          )}
        </button>

        {showLabels && (
          <span className={cn('text-slate-500', size === 'sm' && 'text-xs')}>
            No Ãºtil
          </span>
        )}

        {/* Confirmation Message */}
        {(isPositive || isNegative) && (
          <span
            className={cn(
              'text-xs ml-2 animate-fade-in',
              isPositive ? 'text-green-600' : 'text-slate-500'
            )}
          >
            {isPositive ? 'Â¡Gracias!' : 'Gracias por tu feedback'}
          </span>
        )}

        {/* Error Message */}
        {errorMessage && (
          <span className="text-xs text-red-500 ml-2 animate-fade-in">
            {errorMessage}
          </span>
        )}
      </div>

      {/* Feedback Modal (for negative feedback) */}
      <FeedbackModal
        isOpen={isModalOpen}
        onClose={handleModalCancel}
        onSubmit={handleModalSubmit}
        isLoading={isLoading}
      />
    </>
  );
}

// CSS for animation (add to globals.css if not exists)
// .animate-fade-in {
//   animation: fadeIn 0.3s ease-in-out;
// }
// @keyframes fadeIn {
//   from { opacity: 0; }
//   to { opacity: 1; }
// }
```

### 3.2 Archivo: `src/components/feedback/FeedbackModal.tsx`

```tsx
// =====================================================
// TIS TIS PLATFORM - Feedback Modal Component
// Modal para capturar feedback detallado (negativo)
// =====================================================

'use client';

import { useState, useCallback } from 'react';
import { X, Loader2 } from 'lucide-react';
import { cn } from '@/src/shared/lib/utils';
import type { FeedbackCategory } from '@/src/features/ai/types/rlhf.types';

// ======================
// TYPES
// ======================

interface FeedbackModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (feedbackText?: string, feedbackCategory?: FeedbackCategory) => void;
  isLoading?: boolean;
}

// ======================
// CONSTANTS
// ======================

const FEEDBACK_CATEGORIES: Array<{
  value: FeedbackCategory;
  label: string;
  description: string;
}> = [
  {
    value: 'wrong_info',
    label: 'InformaciÃ³n incorrecta',
    description: 'La respuesta contenÃ­a datos errÃ³neos',
  },
  {
    value: 'incomplete',
    label: 'Respuesta incompleta',
    description: 'FaltÃ³ informaciÃ³n importante',
  },
  {
    value: 'rude',
    label: 'Tono inapropiado',
    description: 'La respuesta fue poco amigable',
  },
  {
    value: 'other',
    label: 'Otro',
    description: 'Otro tipo de problema',
  },
];

const MAX_TEXT_LENGTH = 500;

// ======================
// COMPONENT
// ======================

export function FeedbackModal({
  isOpen,
  onClose,
  onSubmit,
  isLoading = false,
}: FeedbackModalProps) {
  const [selectedCategory, setSelectedCategory] = useState<FeedbackCategory | null>(null);
  const [feedbackText, setFeedbackText] = useState('');

  // ======================
  // HANDLERS
  // ======================

  const handleSubmit = useCallback(() => {
    onSubmit(
      feedbackText.trim() || undefined,
      selectedCategory || undefined
    );
  }, [feedbackText, selectedCategory, onSubmit]);

  const handleClose = useCallback(() => {
    // Reset state when closing
    setSelectedCategory(null);
    setFeedbackText('');
    onClose();
  }, [onClose]);

  const handleTextChange = useCallback((e: React.ChangeEvent<HTMLTextAreaElement>) => {
    const value = e.target.value;
    if (value.length <= MAX_TEXT_LENGTH) {
      setFeedbackText(value);
    }
  }, []);

  // ======================
  // RENDER
  // ======================

  if (!isOpen) return null;

  return (
    <>
      {/* Backdrop */}
      <div
        className="fixed inset-0 bg-black/50 z-50 animate-fade-in"
        onClick={handleClose}
        aria-hidden="true"
      />

      {/* Modal */}
      <div
        className={cn(
          'fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2',
          'w-full max-w-md bg-white rounded-xl shadow-xl z-50',
          'animate-scale-in'
        )}
        role="dialog"
        aria-modal="true"
        aria-labelledby="feedback-modal-title"
      >
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b border-slate-100">
          <h2 id="feedback-modal-title" className="text-lg font-semibold text-slate-900">
            Â¿QuÃ© estuvo mal?
          </h2>
          <button
            onClick={handleClose}
            className="p-1 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors"
            aria-label="Cerrar"
          >
            <X size={20} />
          </button>
        </div>

        {/* Content */}
        <div className="p-4 space-y-4">
          {/* Category Selection */}
          <div className="space-y-2">
            <label className="text-sm font-medium text-slate-700">
              Selecciona una categorÃ­a (opcional)
            </label>
            <div className="space-y-2">
              {FEEDBACK_CATEGORIES.map((category) => (
                <label
                  key={category.value}
                  className={cn(
                    'flex items-start gap-3 p-3 rounded-lg border cursor-pointer transition-all',
                    selectedCategory === category.value
                      ? 'border-tis-coral bg-tis-coral/5'
                      : 'border-slate-200 hover:border-slate-300 hover:bg-slate-50'
                  )}
                >
                  <input
                    type="radio"
                    name="feedback-category"
                    value={category.value}
                    checked={selectedCategory === category.value}
                    onChange={() => setSelectedCategory(category.value)}
                    className="mt-0.5 text-tis-coral focus:ring-tis-coral"
                  />
                  <div>
                    <div className="font-medium text-slate-900">{category.label}</div>
                    <div className="text-sm text-slate-500">{category.description}</div>
                  </div>
                </label>
              ))}
            </div>
          </div>

          {/* Text Feedback */}
          <div className="space-y-2">
            <label htmlFor="feedback-text" className="text-sm font-medium text-slate-700">
              CuÃ©ntanos mÃ¡s (opcional)
            </label>
            <textarea
              id="feedback-text"
              value={feedbackText}
              onChange={handleTextChange}
              placeholder="Â¿QuÃ© podrÃ­amos mejorar?"
              rows={3}
              className={cn(
                'w-full px-3 py-2 rounded-lg border border-slate-200',
                'placeholder:text-slate-400 text-slate-900',
                'focus:outline-none focus:ring-2 focus:ring-tis-coral/30 focus:border-tis-coral',
                'resize-none transition-all'
              )}
            />
            <div className="text-xs text-slate-400 text-right">
              {feedbackText.length}/{MAX_TEXT_LENGTH}
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="flex items-center justify-end gap-3 p-4 border-t border-slate-100">
          <button
            onClick={handleClose}
            disabled={isLoading}
            className={cn(
              'px-4 py-2 rounded-lg text-sm font-medium',
              'text-slate-600 hover:text-slate-800 hover:bg-slate-100',
              'transition-colors',
              isLoading && 'opacity-50 cursor-not-allowed'
            )}
          >
            Cancelar
          </button>
          <button
            onClick={handleSubmit}
            disabled={isLoading}
            className={cn(
              'px-4 py-2 rounded-lg text-sm font-medium',
              'bg-tis-coral text-white hover:bg-tis-coral/90',
              'transition-colors',
              'disabled:opacity-50 disabled:cursor-not-allowed',
              'flex items-center gap-2'
            )}
          >
            {isLoading && <Loader2 className="w-4 h-4 animate-spin" />}
            Enviar feedback
          </button>
        </div>
      </div>
    </>
  );
}

// Add to globals.css:
// .animate-scale-in {
//   animation: scaleIn 0.2s ease-out;
// }
// @keyframes scaleIn {
//   from {
//     opacity: 0;
//     transform: translate(-50%, -50%) scale(0.95);
//   }
//   to {
//     opacity: 1;
//     transform: translate(-50%, -50%) scale(1);
//   }
// }
```

### 3.3 Archivo: `src/components/feedback/index.ts`

```typescript
// =====================================================
// TIS TIS PLATFORM - Feedback Components Index
// =====================================================

export { FeedbackButtons } from './FeedbackButtons';
export { FeedbackModal } from './FeedbackModal';
```

### 3.4 IntegraciÃ³n en MessageBubble

```tsx
// Ejemplo de integraciÃ³n en el componente de mensaje existente
// Archivo: src/components/inbox/MessageBubble.tsx (o similar)

import { FeedbackButtons } from '@/src/components/feedback';

interface MessageBubbleProps {
  message: {
    id: string;
    content: string;
    sender_type: 'contact' | 'agent' | 'ai';
    // ... otros campos
  };
  // ... otras props
}

export function MessageBubble({ message, ...props }: MessageBubbleProps) {
  const isAIMessage = message.sender_type === 'agent' || message.sender_type === 'ai';

  return (
    <div className="message-bubble">
      {/* Contenido del mensaje */}
      <div className="message-content">
        {message.content}
      </div>

      {/* Feedback buttons - solo para mensajes del AI */}
      {isAIMessage && (
        <div className="mt-2 pt-2 border-t border-slate-100">
          <FeedbackButtons
            messageId={message.id}
            size="sm"
            onFeedbackGiven={(rating) => {
              console.log(`Feedback given: ${rating} for message ${message.id}`);
            }}
          />
        </div>
      )}
    </div>
  );
}
```

---

## 4. ESTILOS ADICIONALES

### 4.1 Agregar a `globals.css`

```css
/* =====================================================
   TIS TIS PLATFORM - Feedback Animations
   ===================================================== */

/* Fade in animation */
.animate-fade-in {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Scale in animation (for modal) */
.animate-scale-in {
  animation: scaleIn 0.2s ease-out;
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
}

/* Pulse animation (for button press feedback) */
.animate-pulse-once {
  animation: pulseOnce 0.3s ease-in-out;
}

@keyframes pulseOnce {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(0.95);
  }
}
```

---

## 5. TESTING

### 5.1 Component Tests

```tsx
// __tests__/components/feedback/FeedbackButtons.test.tsx

import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { FeedbackButtons } from '@/src/components/feedback';

// Mock useAuth
vi.mock('@/src/features/auth', () => ({
  useAuth: () => ({
    session: { access_token: 'test-token' },
  }),
}));

// Mock fetch
global.fetch = vi.fn();

describe('FeedbackButtons', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('renders both buttons in idle state', () => {
    render(<FeedbackButtons messageId="test-id" />);

    expect(screen.getByTitle('Esta respuesta fue Ãºtil')).toBeInTheDocument();
    expect(screen.getByTitle('Esta respuesta no fue Ãºtil')).toBeInTheDocument();
  });

  it('shows positive state after thumbs up click', async () => {
    (global.fetch as vi.Mock).mockResolvedValueOnce({
      ok: true,
      json: () => Promise.resolve({ success: true, feedback_id: '123' }),
    });

    render(<FeedbackButtons messageId="test-id" />);

    const thumbsUp = screen.getByTitle('Esta respuesta fue Ãºtil');
    fireEvent.click(thumbsUp);

    await waitFor(() => {
      expect(screen.getByText('Â¡Gracias!')).toBeInTheDocument();
    });
  });

  it('opens modal on thumbs down click', async () => {
    render(<FeedbackButtons messageId="test-id" />);

    const thumbsDown = screen.getByTitle('Esta respuesta no fue Ãºtil');
    fireEvent.click(thumbsDown);

    await waitFor(() => {
      expect(screen.getByText('Â¿QuÃ© estuvo mal?')).toBeInTheDocument();
    });
  });

  it('shows existing feedback state', () => {
    render(
      <FeedbackButtons
        messageId="test-id"
        existingFeedback={{ rating: 'up' }}
      />
    );

    // Check that thumbs up is highlighted
    const thumbsUp = screen.getByTitle('Esta respuesta fue Ãºtil');
    expect(thumbsUp).toHaveClass('bg-green-100');
  });

  it('calls onFeedbackGiven callback', async () => {
    const onFeedbackGiven = vi.fn();
    (global.fetch as vi.Mock).mockResolvedValueOnce({
      ok: true,
      json: () => Promise.resolve({ success: true }),
    });

    render(
      <FeedbackButtons
        messageId="test-id"
        onFeedbackGiven={onFeedbackGiven}
      />
    );

    const thumbsUp = screen.getByTitle('Esta respuesta fue Ãºtil');
    fireEvent.click(thumbsUp);

    await waitFor(() => {
      expect(onFeedbackGiven).toHaveBeenCalledWith('up');
    });
  });
});
```

---

## 6. CHECKLIST DE IMPLEMENTACIÃ“N

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CHECKLIST 1.3 - UI COMPONENTS                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â–¡ Componentes creados                                                 â”‚
â”‚    â”œâ”€â”€ [ ] FeedbackButtons.tsx                                         â”‚
â”‚    â”œâ”€â”€ [ ] FeedbackModal.tsx                                           â”‚
â”‚    â””â”€â”€ [ ] index.ts (exports)                                          â”‚
â”‚                                                                         â”‚
â”‚  â–¡ Estilos                                                             â”‚
â”‚    â”œâ”€â”€ [ ] Animaciones en globals.css                                  â”‚
â”‚    â””â”€â”€ [ ] Colores consistentes con design system                      â”‚
â”‚                                                                         â”‚
â”‚  â–¡ IntegraciÃ³n                                                         â”‚
â”‚    â”œâ”€â”€ [ ] FeedbackButtons en MessageBubble                            â”‚
â”‚    â””â”€â”€ [ ] Solo visible en mensajes del AI                             â”‚
â”‚                                                                         â”‚
â”‚  â–¡ Estados                                                             â”‚
â”‚    â”œâ”€â”€ [ ] Estado idle funciona                                        â”‚
â”‚    â”œâ”€â”€ [ ] Estado loading con spinner                                  â”‚
â”‚    â”œâ”€â”€ [ ] Estado positive con highlight                               â”‚
â”‚    â”œâ”€â”€ [ ] Estado negative con highlight                               â”‚
â”‚    â””â”€â”€ [ ] Estado error con mensaje                                    â”‚
â”‚                                                                         â”‚
â”‚  â–¡ Modal                                                               â”‚
â”‚    â”œâ”€â”€ [ ] Se abre en feedback negativo                                â”‚
â”‚    â”œâ”€â”€ [ ] CategorÃ­as seleccionables                                   â”‚
â”‚    â”œâ”€â”€ [ ] Textarea con lÃ­mite de caracteres                           â”‚
â”‚    â””â”€â”€ [ ] Botones de acciÃ³n funcionan                                 â”‚
â”‚                                                                         â”‚
â”‚  â–¡ Accesibilidad                                                       â”‚
â”‚    â”œâ”€â”€ [ ] aria-labels en botones                                      â”‚
â”‚    â”œâ”€â”€ [ ] role="dialog" en modal                                      â”‚
â”‚    â””â”€â”€ [ ] Focus management                                            â”‚
â”‚                                                                         â”‚
â”‚  â–¡ Testing                                                             â”‚
â”‚    â”œâ”€â”€ [ ] Tests de rendering                                          â”‚
â”‚    â”œâ”€â”€ [ ] Tests de interacciÃ³n                                        â”‚
â”‚    â””â”€â”€ [ ] Tests de estados                                            â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. PRÃ“XIMOS PASOS

1. âœ… Componentes implementados y testeados
2. â¡ï¸ Continuar con [1.4-AGGREGATOR.md](./1.4-AGGREGATOR.md)

---

**Documentos relacionados:**
- [1.2-API-FEEDBACK.md](./1.2-API-FEEDBACK.md) - API de captura
- [1.4-AGGREGATOR.md](./1.4-AGGREGATOR.md) - Siguiente: Agregador de feedback
