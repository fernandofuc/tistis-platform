# ðŸ—„ï¸ FASE 1.1: Schema de Base de Datos para RLHF

## Documento de ImplementaciÃ³n

**VersiÃ³n:** 1.0.0
**DuraciÃ³n estimada:** 1 semana
**Dependencias:** Ninguna
**Output:** MigraciÃ³n SQL ejecutada en Supabase

---

## 1. OBJETIVO

Crear las tablas necesarias para almacenar:
1. **Feedback individual** de cada respuesta del AI
2. **MÃ©tricas agregadas** por perÃ­odo
3. **Experimentos de prompts** para A/B testing

---

## 2. DIAGRAMA ENTIDAD-RELACIÃ“N

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DIAGRAMA ER - RLHF                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚     tenants     â”‚         â”‚    messages     â”‚                       â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
â”‚  â”‚ id (PK)         â”‚         â”‚ id (PK)         â”‚                       â”‚
â”‚  â”‚ name            â”‚         â”‚ conversation_id â”‚                       â”‚
â”‚  â”‚ vertical        â”‚         â”‚ content         â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚           â”‚                           â”‚                                 â”‚
â”‚           â”‚ 1:N                       â”‚ 1:1                             â”‚
â”‚           â”‚                           â”‚                                 â”‚
â”‚           â–¼                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    ai_rlhf_feedback                               â”‚  â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚ id (PK)                                                          â”‚  â”‚
â”‚  â”‚ tenant_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚ message_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚ conversation_id (FK)                                             â”‚  â”‚
â”‚  â”‚ lead_id (FK)                                                     â”‚  â”‚
â”‚  â”‚ rating ('up' | 'down')                                           â”‚  â”‚
â”‚  â”‚ feedback_text                                                    â”‚  â”‚
â”‚  â”‚ feedback_category                                                â”‚  â”‚
â”‚  â”‚ intent_detected                                                  â”‚  â”‚
â”‚  â”‚ agent_used                                                       â”‚  â”‚
â”‚  â”‚ response_text                                                    â”‚  â”‚
â”‚  â”‚ confidence_score                                                 â”‚  â”‚
â”‚  â”‚ created_at                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                                             â”‚
â”‚           â”‚ N:1 (agregado)                                             â”‚
â”‚           â”‚                                                             â”‚
â”‚           â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    ai_rlhf_aggregated                             â”‚  â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚ id (PK)                                                          â”‚  â”‚
â”‚  â”‚ tenant_id (FK)                                                   â”‚  â”‚
â”‚  â”‚ period_start                                                     â”‚  â”‚
â”‚  â”‚ period_end                                                       â”‚  â”‚
â”‚  â”‚ intent                                                           â”‚  â”‚
â”‚  â”‚ agent                                                            â”‚  â”‚
â”‚  â”‚ total_responses                                                  â”‚  â”‚
â”‚  â”‚ positive_count                                                   â”‚  â”‚
â”‚  â”‚ negative_count                                                   â”‚  â”‚
â”‚  â”‚ satisfaction_rate                                                â”‚  â”‚
â”‚  â”‚ negative_patterns (JSONB)                                        â”‚  â”‚
â”‚  â”‚ improvement_suggestions (JSONB)                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                                             â”‚
â”‚           â”‚ triggers                                                    â”‚
â”‚           â”‚                                                             â”‚
â”‚           â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    ai_prompt_experiments                          â”‚  â”‚
â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚ id (PK)                                                          â”‚  â”‚
â”‚  â”‚ tenant_id (FK)                                                   â”‚  â”‚
â”‚  â”‚ experiment_name                                                  â”‚  â”‚
â”‚  â”‚ intent_target                                                    â”‚  â”‚
â”‚  â”‚ agent_target                                                     â”‚  â”‚
â”‚  â”‚ control_prompt                                                   â”‚  â”‚
â”‚  â”‚ variant_prompt                                                   â”‚  â”‚
â”‚  â”‚ status ('draft' | 'running' | 'completed' | 'aborted')          â”‚  â”‚
â”‚  â”‚ traffic_split                                                    â”‚  â”‚
â”‚  â”‚ control_responses / control_positive                             â”‚  â”‚
â”‚  â”‚ variant_responses / variant_positive                             â”‚  â”‚
â”‚  â”‚ statistical_significance                                         â”‚  â”‚
â”‚  â”‚ started_at / completed_at                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. SCRIPT DE MIGRACIÃ“N

### 3.1 Archivo: `supabase/migrations/200_AI_LEARNING_RLHF.sql`

```sql
-- =====================================================
-- TIS TIS PLATFORM - AI Learning 2.0: RLHF Schema
-- MigraciÃ³n: 200_AI_LEARNING_RLHF.sql
-- Fecha: Enero 2026
-- DescripciÃ³n: Tablas para Reinforcement Learning from Human Feedback
-- =====================================================

-- =====================================================
-- TABLA 1: ai_rlhf_feedback
-- Almacena feedback individual de cada respuesta del AI
-- =====================================================

CREATE TABLE IF NOT EXISTS ai_rlhf_feedback (
    -- Primary Key
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Foreign Keys
    tenant_id UUID NOT NULL,
    message_id UUID NOT NULL,
    conversation_id UUID NOT NULL,
    lead_id UUID,

    -- Feedback Data
    rating VARCHAR(10) NOT NULL,
    feedback_text TEXT,
    feedback_category VARCHAR(50),

    -- Context at time of feedback (snapshot)
    intent_detected VARCHAR(50),
    agent_used VARCHAR(50),
    response_text TEXT,
    confidence_score DECIMAL(5,4),

    -- Metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    user_agent TEXT,
    ip_hash VARCHAR(64), -- Hashed for privacy

    -- Constraints
    CONSTRAINT fk_rlhf_tenant FOREIGN KEY (tenant_id)
        REFERENCES tenants(id) ON DELETE CASCADE,
    CONSTRAINT fk_rlhf_message FOREIGN KEY (message_id)
        REFERENCES messages(id) ON DELETE CASCADE,
    CONSTRAINT fk_rlhf_conversation FOREIGN KEY (conversation_id)
        REFERENCES conversations(id) ON DELETE CASCADE,
    CONSTRAINT fk_rlhf_lead FOREIGN KEY (lead_id)
        REFERENCES leads(id) ON DELETE SET NULL,
    CONSTRAINT chk_rating CHECK (rating IN ('up', 'down')),
    CONSTRAINT chk_feedback_category CHECK (
        feedback_category IS NULL OR
        feedback_category IN (
            'wrong_info',      -- InformaciÃ³n incorrecta
            'incomplete',      -- Respuesta incompleta
            'rude',            -- Tono inapropiado
            'slow',            -- Respuesta lenta
            'helpful',         -- Muy Ãºtil
            'accurate',        -- InformaciÃ³n precisa
            'friendly',        -- Tono amigable
            'other'            -- Otro
        )
    )
);

-- Ãndices para consultas frecuentes
CREATE INDEX idx_rlhf_feedback_tenant ON ai_rlhf_feedback(tenant_id);
CREATE INDEX idx_rlhf_feedback_message ON ai_rlhf_feedback(message_id);
CREATE INDEX idx_rlhf_feedback_rating ON ai_rlhf_feedback(tenant_id, rating);
CREATE INDEX idx_rlhf_feedback_intent ON ai_rlhf_feedback(tenant_id, intent_detected);
CREATE INDEX idx_rlhf_feedback_created ON ai_rlhf_feedback(tenant_id, created_at DESC);

-- Ãndice compuesto para agregaciÃ³n
CREATE INDEX idx_rlhf_feedback_aggregate ON ai_rlhf_feedback(
    tenant_id,
    intent_detected,
    agent_used,
    rating,
    created_at
);

-- RLS: Solo el tenant puede ver su propio feedback
ALTER TABLE ai_rlhf_feedback ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Tenant can view own feedback" ON ai_rlhf_feedback
    FOR SELECT USING (
        tenant_id IN (
            SELECT tenant_id FROM user_roles
            WHERE user_id = auth.uid()
        )
    );

CREATE POLICY "Tenant can insert own feedback" ON ai_rlhf_feedback
    FOR INSERT WITH CHECK (
        tenant_id IN (
            SELECT tenant_id FROM user_roles
            WHERE user_id = auth.uid()
        )
    );

-- =====================================================
-- TABLA 2: ai_rlhf_aggregated
-- MÃ©tricas agregadas por perÃ­odo (semanal)
-- =====================================================

CREATE TABLE IF NOT EXISTS ai_rlhf_aggregated (
    -- Primary Key
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Foreign Key
    tenant_id UUID NOT NULL,

    -- PerÃ­odo de agregaciÃ³n
    period_start TIMESTAMP WITH TIME ZONE NOT NULL,
    period_end TIMESTAMP WITH TIME ZONE NOT NULL,

    -- Dimensiones de agregaciÃ³n
    intent VARCHAR(50),
    agent VARCHAR(50),

    -- MÃ©tricas principales
    total_responses INTEGER NOT NULL DEFAULT 0,
    positive_count INTEGER NOT NULL DEFAULT 0,
    negative_count INTEGER NOT NULL DEFAULT 0,
    satisfaction_rate DECIMAL(5,4), -- 0.0000 to 1.0000

    -- AnÃ¡lisis de patrones negativos
    negative_patterns JSONB DEFAULT '[]'::jsonb,
    -- Estructura: [{pattern: "informaciÃ³n incorrecta", count: 5, examples: [...]}]

    -- Sugerencias de mejora generadas por AI
    improvement_suggestions JSONB DEFAULT '[]'::jsonb,
    -- Estructura: [{suggestion: "...", priority: "high", affected_count: 10}]

    -- Metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- Constraints
    CONSTRAINT fk_rlhf_agg_tenant FOREIGN KEY (tenant_id)
        REFERENCES tenants(id) ON DELETE CASCADE,
    CONSTRAINT chk_satisfaction_rate CHECK (
        satisfaction_rate IS NULL OR
        (satisfaction_rate >= 0 AND satisfaction_rate <= 1)
    ),
    CONSTRAINT unique_period_dimension UNIQUE (
        tenant_id,
        period_start,
        period_end,
        intent,
        agent
    )
);

-- Ãndices
CREATE INDEX idx_rlhf_agg_tenant ON ai_rlhf_aggregated(tenant_id);
CREATE INDEX idx_rlhf_agg_period ON ai_rlhf_aggregated(tenant_id, period_start DESC);
CREATE INDEX idx_rlhf_agg_satisfaction ON ai_rlhf_aggregated(tenant_id, satisfaction_rate);

-- RLS
ALTER TABLE ai_rlhf_aggregated ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Tenant can view own aggregated" ON ai_rlhf_aggregated
    FOR SELECT USING (
        tenant_id IN (
            SELECT tenant_id FROM user_roles
            WHERE user_id = auth.uid()
        )
    );

-- =====================================================
-- TABLA 3: ai_prompt_experiments
-- Experimentos A/B de prompts
-- =====================================================

CREATE TABLE IF NOT EXISTS ai_prompt_experiments (
    -- Primary Key
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- Foreign Key
    tenant_id UUID NOT NULL,

    -- ConfiguraciÃ³n del experimento
    experiment_name VARCHAR(100) NOT NULL,
    experiment_description TEXT,
    intent_target VARCHAR(50), -- NULL = todos los intents
    agent_target VARCHAR(50),  -- NULL = todos los agentes

    -- Prompts
    control_prompt TEXT NOT NULL,
    variant_prompt TEXT NOT NULL,
    prompt_section VARCHAR(50) DEFAULT 'system', -- system, instruction, etc.

    -- Estado y configuraciÃ³n
    status VARCHAR(20) NOT NULL DEFAULT 'draft',
    traffic_split DECIMAL(3,2) DEFAULT 0.50, -- % que va a variant
    min_sample_size INTEGER DEFAULT 100,      -- MÃ­nimo para significancia

    -- Resultados - Control
    control_responses INTEGER DEFAULT 0,
    control_positive INTEGER DEFAULT 0,
    control_negative INTEGER DEFAULT 0,

    -- Resultados - Variant
    variant_responses INTEGER DEFAULT 0,
    variant_positive INTEGER DEFAULT 0,
    variant_negative INTEGER DEFAULT 0,

    -- AnÃ¡lisis estadÃ­stico
    statistical_significance DECIMAL(5,4), -- p-value
    lift_percentage DECIMAL(5,2),          -- % mejora del variant
    confidence_interval_lower DECIMAL(5,4),
    confidence_interval_upper DECIMAL(5,4),

    -- DecisiÃ³n final
    winner VARCHAR(20), -- 'control', 'variant', 'inconclusive'
    decision_notes TEXT,

    -- Fechas
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- Constraints
    CONSTRAINT fk_experiment_tenant FOREIGN KEY (tenant_id)
        REFERENCES tenants(id) ON DELETE CASCADE,
    CONSTRAINT chk_experiment_status CHECK (
        status IN ('draft', 'running', 'paused', 'completed', 'aborted')
    ),
    CONSTRAINT chk_traffic_split CHECK (
        traffic_split >= 0.10 AND traffic_split <= 0.90
    ),
    CONSTRAINT chk_winner CHECK (
        winner IS NULL OR
        winner IN ('control', 'variant', 'inconclusive')
    )
);

-- Ãndices
CREATE INDEX idx_experiment_tenant ON ai_prompt_experiments(tenant_id);
CREATE INDEX idx_experiment_status ON ai_prompt_experiments(tenant_id, status);
CREATE INDEX idx_experiment_running ON ai_prompt_experiments(status)
    WHERE status = 'running';

-- RLS
ALTER TABLE ai_prompt_experiments ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Tenant can manage own experiments" ON ai_prompt_experiments
    FOR ALL USING (
        tenant_id IN (
            SELECT tenant_id FROM user_roles
            WHERE user_id = auth.uid()
        )
    );

-- =====================================================
-- FUNCIONES AUXILIARES
-- =====================================================

-- FunciÃ³n para calcular satisfaction rate
CREATE OR REPLACE FUNCTION calculate_satisfaction_rate(
    positive INTEGER,
    total INTEGER
) RETURNS DECIMAL(5,4) AS $$
BEGIN
    IF total = 0 THEN
        RETURN NULL;
    END IF;
    RETURN ROUND(positive::DECIMAL / total::DECIMAL, 4);
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- FunciÃ³n para obtener experimento activo para un tenant/intent
CREATE OR REPLACE FUNCTION get_active_experiment(
    p_tenant_id UUID,
    p_intent VARCHAR DEFAULT NULL,
    p_agent VARCHAR DEFAULT NULL
) RETURNS TABLE (
    experiment_id UUID,
    traffic_split DECIMAL,
    control_prompt TEXT,
    variant_prompt TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        e.id,
        e.traffic_split,
        e.control_prompt,
        e.variant_prompt
    FROM ai_prompt_experiments e
    WHERE e.tenant_id = p_tenant_id
      AND e.status = 'running'
      AND (e.intent_target IS NULL OR e.intent_target = p_intent)
      AND (e.agent_target IS NULL OR e.agent_target = p_agent)
    ORDER BY e.started_at DESC
    LIMIT 1;
END;
$$ LANGUAGE plpgsql STABLE;

-- FunciÃ³n para registrar resultado de experimento
CREATE OR REPLACE FUNCTION record_experiment_result(
    p_experiment_id UUID,
    p_is_variant BOOLEAN,
    p_is_positive BOOLEAN
) RETURNS VOID AS $$
BEGIN
    IF p_is_variant THEN
        UPDATE ai_prompt_experiments
        SET
            variant_responses = variant_responses + 1,
            variant_positive = variant_positive + CASE WHEN p_is_positive THEN 1 ELSE 0 END,
            variant_negative = variant_negative + CASE WHEN NOT p_is_positive THEN 1 ELSE 0 END,
            updated_at = NOW()
        WHERE id = p_experiment_id;
    ELSE
        UPDATE ai_prompt_experiments
        SET
            control_responses = control_responses + 1,
            control_positive = control_positive + CASE WHEN p_is_positive THEN 1 ELSE 0 END,
            control_negative = control_negative + CASE WHEN NOT p_is_positive THEN 1 ELSE 0 END,
            updated_at = NOW()
        WHERE id = p_experiment_id;
    END IF;
END;
$$ LANGUAGE plpgsql;

-- =====================================================
-- TRIGGERS
-- =====================================================

-- Trigger para actualizar updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_rlhf_agg_updated
    BEFORE UPDATE ON ai_rlhf_aggregated
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER trg_experiment_updated
    BEFORE UPDATE ON ai_prompt_experiments
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- =====================================================
-- DATOS INICIALES / SEEDS
-- =====================================================

-- No se requieren datos iniciales para estas tablas.
-- Se poblarÃ¡n con el uso del sistema.

-- =====================================================
-- COMENTARIOS DE DOCUMENTACIÃ“N
-- =====================================================

COMMENT ON TABLE ai_rlhf_feedback IS
    'Almacena feedback individual (ðŸ‘/ðŸ‘Ž) de cada respuesta del AI';

COMMENT ON TABLE ai_rlhf_aggregated IS
    'MÃ©tricas agregadas de feedback por perÃ­odo semanal';

COMMENT ON TABLE ai_prompt_experiments IS
    'Experimentos A/B de prompts para optimizaciÃ³n';

COMMENT ON COLUMN ai_rlhf_feedback.rating IS
    'up = positivo (ðŸ‘), down = negativo (ðŸ‘Ž)';

COMMENT ON COLUMN ai_rlhf_feedback.feedback_category IS
    'CategorÃ­a opcional del feedback: wrong_info, incomplete, rude, slow, helpful, accurate, friendly, other';

COMMENT ON COLUMN ai_rlhf_aggregated.negative_patterns IS
    'JSON array de patrones detectados en feedback negativo: [{pattern, count, examples}]';

COMMENT ON COLUMN ai_prompt_experiments.traffic_split IS
    'Porcentaje de trÃ¡fico que va al variant (0.50 = 50%)';

-- =====================================================
-- FIN DE MIGRACIÃ“N
-- =====================================================
```

---

## 4. VALIDACIÃ“N POST-MIGRACIÃ“N

### 4.1 Script de ValidaciÃ³n

```sql
-- =====================================================
-- SCRIPT DE VALIDACIÃ“N POST-MIGRACIÃ“N
-- Ejecutar despuÃ©s de aplicar la migraciÃ³n
-- =====================================================

-- 1. Verificar que las tablas existen
SELECT
    table_name,
    CASE
        WHEN table_name IS NOT NULL THEN 'âœ… EXISTS'
        ELSE 'âŒ MISSING'
    END as status
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN (
    'ai_rlhf_feedback',
    'ai_rlhf_aggregated',
    'ai_prompt_experiments'
);

-- 2. Verificar columnas de ai_rlhf_feedback
SELECT
    column_name,
    data_type,
    is_nullable
FROM information_schema.columns
WHERE table_name = 'ai_rlhf_feedback'
ORDER BY ordinal_position;

-- 3. Verificar Ã­ndices
SELECT
    indexname,
    indexdef
FROM pg_indexes
WHERE tablename LIKE 'ai_rlhf%'
OR tablename = 'ai_prompt_experiments';

-- 4. Verificar RLS estÃ¡ habilitado
SELECT
    tablename,
    rowsecurity
FROM pg_tables
WHERE tablename IN (
    'ai_rlhf_feedback',
    'ai_rlhf_aggregated',
    'ai_prompt_experiments'
);

-- 5. Verificar polÃ­ticas RLS
SELECT
    tablename,
    policyname,
    permissive,
    cmd
FROM pg_policies
WHERE tablename LIKE 'ai_rlhf%'
OR tablename = 'ai_prompt_experiments';

-- 6. Verificar funciones
SELECT
    routine_name,
    routine_type
FROM information_schema.routines
WHERE routine_schema = 'public'
AND routine_name IN (
    'calculate_satisfaction_rate',
    'get_active_experiment',
    'record_experiment_result'
);

-- 7. Test de inserciÃ³n (dry run)
BEGIN;

-- Test insert feedback
INSERT INTO ai_rlhf_feedback (
    tenant_id,
    message_id,
    conversation_id,
    rating,
    intent_detected
) VALUES (
    '00000000-0000-0000-0000-000000000000'::uuid, -- dummy
    '00000000-0000-0000-0000-000000000000'::uuid,
    '00000000-0000-0000-0000-000000000000'::uuid,
    'up',
    'GREETING'
);

-- Rollback para no dejar datos de prueba
ROLLBACK;

-- Si llegamos aquÃ­ sin error, la migraciÃ³n es vÃ¡lida
SELECT 'âœ… MIGRACIÃ“N VÃLIDA' as resultado;
```

### 4.2 Checklist de ValidaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CHECKLIST DE VALIDACIÃ“N                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â–¡ Tablas creadas correctamente                                        â”‚
â”‚    â”œâ”€â”€ [ ] ai_rlhf_feedback                                            â”‚
â”‚    â”œâ”€â”€ [ ] ai_rlhf_aggregated                                          â”‚
â”‚    â””â”€â”€ [ ] ai_prompt_experiments                                       â”‚
â”‚                                                                         â”‚
â”‚  â–¡ Ãndices creados                                                     â”‚
â”‚    â”œâ”€â”€ [ ] idx_rlhf_feedback_tenant                                    â”‚
â”‚    â”œâ”€â”€ [ ] idx_rlhf_feedback_aggregate                                 â”‚
â”‚    â””â”€â”€ [ ] (todos los demÃ¡s)                                           â”‚
â”‚                                                                         â”‚
â”‚  â–¡ RLS configurado                                                     â”‚
â”‚    â”œâ”€â”€ [ ] PolÃ­ticas de SELECT funcionan                               â”‚
â”‚    â””â”€â”€ [ ] PolÃ­ticas de INSERT funcionan                               â”‚
â”‚                                                                         â”‚
â”‚  â–¡ Funciones disponibles                                               â”‚
â”‚    â”œâ”€â”€ [ ] calculate_satisfaction_rate                                 â”‚
â”‚    â”œâ”€â”€ [ ] get_active_experiment                                       â”‚
â”‚    â””â”€â”€ [ ] record_experiment_result                                    â”‚
â”‚                                                                         â”‚
â”‚  â–¡ Constraints vÃ¡lidos                                                 â”‚
â”‚    â”œâ”€â”€ [ ] CHECK rating IN ('up', 'down')                              â”‚
â”‚    â””â”€â”€ [ ] CHECK traffic_split BETWEEN 0.10 AND 0.90                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ROLLBACK

### 5.1 Script de Rollback

```sql
-- =====================================================
-- SCRIPT DE ROLLBACK
-- Usar SOLO si es necesario revertir la migraciÃ³n
-- âš ï¸ ADVERTENCIA: Esto eliminarÃ¡ todos los datos de RLHF
-- =====================================================

-- Eliminar triggers primero
DROP TRIGGER IF EXISTS trg_rlhf_agg_updated ON ai_rlhf_aggregated;
DROP TRIGGER IF EXISTS trg_experiment_updated ON ai_prompt_experiments;

-- Eliminar funciones
DROP FUNCTION IF EXISTS calculate_satisfaction_rate(INTEGER, INTEGER);
DROP FUNCTION IF EXISTS get_active_experiment(UUID, VARCHAR, VARCHAR);
DROP FUNCTION IF EXISTS record_experiment_result(UUID, BOOLEAN, BOOLEAN);
DROP FUNCTION IF EXISTS update_updated_at_column() CASCADE;

-- Eliminar tablas (CASCADE elimina Ã­ndices y polÃ­ticas)
DROP TABLE IF EXISTS ai_prompt_experiments CASCADE;
DROP TABLE IF EXISTS ai_rlhf_aggregated CASCADE;
DROP TABLE IF EXISTS ai_rlhf_feedback CASCADE;

-- Verificar que se eliminaron
SELECT
    'Tables remaining:',
    COUNT(*)
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name LIKE 'ai_rlhf%';
```

---

## 6. PRÃ“XIMOS PASOS

### 6.1 DespuÃ©s de esta Microfase

1. âœ… MigraciÃ³n aplicada y validada
2. âž¡ï¸ Continuar con [1.2-API-FEEDBACK.md](./1.2-API-FEEDBACK.md)

### 6.2 Tareas de Seguimiento

- [ ] Aplicar migraciÃ³n en staging
- [ ] Validar con script de validaciÃ³n
- [ ] Aplicar migraciÃ³n en producciÃ³n
- [ ] Documentar en changelog
- [ ] Notificar al equipo

---

**Documentos relacionados:**
- [1.0-OVERVIEW.md](./1.0-OVERVIEW.md) - VisiÃ³n general
- [1.2-API-FEEDBACK.md](./1.2-API-FEEDBACK.md) - Siguiente: API de captura
