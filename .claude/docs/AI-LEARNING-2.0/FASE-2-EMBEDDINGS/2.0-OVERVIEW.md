# ğŸ”¢ FASE 2: SEMANTIC EMBEDDINGS

## Documento 2.0: VisiÃ³n General de Embeddings

**VersiÃ³n:** 1.0.0
**Prioridad:** ğŸ”´ ALTA
**DuraciÃ³n estimada:** 7-8 semanas
**Dependencias:** FASE 1 completada (opcional pero recomendado)

---

## 1. RESUMEN EJECUTIVO

### 1.1 Objetivo

Reemplazar el sistema actual de detecciÃ³n de patrones basado en **regex** por un sistema de **embeddings semÃ¡nticos** que entienda el significado de los mensajes, no solo palabras clave.

### 1.2 Problema Actual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PROBLEMA CON REGEX ACTUAL                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Mensaje del cliente: "me estÃ¡ matando esta muela"                      â”‚
â”‚                                                                         â”‚
â”‚  SISTEMA ACTUAL (Regex):                                                â”‚
â”‚  â”œâ”€â”€ Busca: /dolor|duele|molestia/i                                    â”‚
â”‚  â”œâ”€â”€ NO encuentra match                                                â”‚
â”‚  â””â”€â”€ âŒ No detecta que es un PAIN_POINT                                â”‚
â”‚                                                                         â”‚
â”‚  SISTEMA PROPUESTO (Embeddings):                                        â”‚
â”‚  â”œâ”€â”€ Embedding de "me estÃ¡ matando esta muela"                         â”‚
â”‚  â”œâ”€â”€ Compara con embeddings de patrones conocidos                      â”‚
â”‚  â”œâ”€â”€ Similitud con "me duele mucho la muela" = 0.94                    â”‚
â”‚  â””â”€â”€ âœ… Detecta PAIN_POINT con confianza 94%                           â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 Beneficios Esperados

| Beneficio | DescripciÃ³n | MÃ©trica Target |
|-----------|-------------|----------------|
| **Mayor precisiÃ³n** | Detecta patrones por significado | PrecisiÃ³n >90% |
| **Menos mantenimiento** | No requiere agregar regex manualmente | -80% tiempo mant. |
| **Multi-idioma ready** | Embeddings funcionan cross-language | Soporte ES/EN |
| **Nuevos patrones** | Detecta patrones nunca vistos | Recall +40% |

---

## 2. ARQUITECTURA

### 2.1 Diagrama de Alto Nivel

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARQUITECTURA DE EMBEDDINGS                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    1. EMBEDDING SERVICE                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  [Mensaje]  â”€â”€â–º  OpenAI API  â”€â”€â–º  [Vector 1536-dim]      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  "me duele"     text-embedding     [0.12, -0.34, ...]    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                  -3-small                                 â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                            â”‚
â”‚                            â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    2. VECTOR STORE (pgvector)                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ai_message_embeddings                                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ id: uuid                                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ tenant_id: uuid                                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ content_text: "me duele la muela"                   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ embedding: vector(1536)                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ pattern_type: "pain_point"                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€ metadata: {...}                                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Ãndice: IVFFlat (vector_cosine_ops)                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                            â”‚
â”‚                            â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    3. SEMANTIC SEARCH                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Query: "me estÃ¡ matando esta muela"                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                    â”‚                                      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                    â–¼                                      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  SELECT * FROM ai_message_embeddings                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  WHERE tenant_id = $1                                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ORDER BY embedding <=> $query_embedding                 â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  LIMIT 5;                                                â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                    â”‚                                      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                    â–¼                                      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Resultados:                                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ "me duele mucho la muela" â†’ 0.94 (pain_point)      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ "tengo dolor de muelas" â†’ 0.91 (pain_point)        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€ "muela del juicio duele" â†’ 0.88 (pain_point)       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                            â”‚
â”‚                            â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    4. PATTERN CLASSIFIER                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Input: Top-K similar messages + their pattern_types     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  ClasificaciÃ³n por voting:                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ pain_point: 3 votos (60%)                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ urgency: 1 voto (20%)                              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€ other: 1 voto (20%)                                â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Output: {                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    pattern: "pain_point",                                â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    confidence: 0.92,                                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚    evidence: ["me duele mucho...", ...]                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  }                                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Flujo de Datos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUJO DE DATOS - EMBEDDINGS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  A. INDEXACIÃ“N (background job)                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                      â”‚
â”‚                                                                         â”‚
â”‚  [Mensaje nuevo] â”€â”€â–º [Queue] â”€â”€â–º [Embedding Service]                   â”‚
â”‚         â”‚                              â”‚                                â”‚
â”‚         â”‚                              â–¼                                â”‚
â”‚         â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â”‚                    â”‚ OpenAI API      â”‚                        â”‚
â”‚         â”‚                    â”‚ Rate: 3000/min  â”‚                        â”‚
â”‚         â”‚                    â”‚ Cost: $0.02/1M  â”‚                        â”‚
â”‚         â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚         â”‚                             â”‚                                 â”‚
â”‚         â”‚                             â–¼                                 â”‚
â”‚         â”‚                    [Vector 1536-dim]                          â”‚
â”‚         â”‚                             â”‚                                 â”‚
â”‚         â”‚                             â–¼                                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º [pgvector INSERT]                          â”‚
â”‚                                                                         â”‚
â”‚  B. BÃšSQUEDA (tiempo real)                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚                                                                         â”‚
â”‚  [Query message] â”€â”€â–º [Embedding Service] â”€â”€â–º [Query Vector]            â”‚
â”‚                                                     â”‚                   â”‚
â”‚                                                     â–¼                   â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚                                    â”‚ pgvector KNN Search       â”‚        â”‚
â”‚                                    â”‚ ORDER BY embedding <=> $1 â”‚        â”‚
â”‚                                    â”‚ LIMIT 10                  â”‚        â”‚
â”‚                                    â”‚                           â”‚        â”‚
â”‚                                    â”‚ Latencia: ~50ms           â”‚        â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                  â”‚                      â”‚
â”‚                                                  â–¼                      â”‚
â”‚                                    [Top-K Similar Messages]             â”‚
â”‚                                                  â”‚                      â”‚
â”‚                                                  â–¼                      â”‚
â”‚                                    [Pattern Classification]             â”‚
â”‚                                                  â”‚                      â”‚
â”‚                                                  â–¼                      â”‚
â”‚                                    {pattern, confidence, evidence}      â”‚
â”‚                                                                         â”‚
â”‚  C. CACHÃ‰ (optimizaciÃ³n)                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚                                                                         â”‚
â”‚  [Query] â”€â”€â–º [Hash] â”€â”€â–º [Check Cache] â”€â”€â–º HIT: return cached           â”‚
â”‚                              â”‚                                          â”‚
â”‚                              â””â”€â”€â–º MISS: compute + cache (5min TTL)     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. COMPONENTES TÃ‰CNICOS

### 3.1 OpenAI Embeddings API

```yaml
Modelo: text-embedding-3-small
Dimensiones: 1536
Costo: $0.00002 / 1K tokens (~$0.02 / 1M tokens)
Rate limit: 3,000 RPM (requests per minute)
Latencia: ~50ms promedio

Ventajas:
  - Alta calidad semÃ¡ntica
  - Muy bajo costo
  - Soporte multi-idioma nativo
  - Estable y bien documentado

Alternativas consideradas:
  - text-embedding-3-large (3072 dim): Mejor pero mÃ¡s costoso
  - Cohere: Similar calidad, diferente pricing
  - sentence-transformers local: Sin costo API pero requiere GPU
```

### 3.2 pgvector Extension

```yaml
Extension: pgvector (PostgreSQL)
VersiÃ³n: 0.5.0+
Disponible en: Supabase (habilitado por defecto en Pro)

Tipos de Ã­ndice:
  - IVFFlat: BÃºsqueda aproximada, rÃ¡pida, usa menos RAM
  - HNSW: MÃ¡s preciso pero usa mÃ¡s RAM

RecomendaciÃ³n: IVFFlat para inicio
  - lists = 100 (para <100K vectores)
  - Escalar a lists = sqrt(n) cuando crezca

Operadores:
  - <=>: Distancia coseno (recomendado para NLP)
  - <->: Distancia L2 (euclidiana)
  - <#>: Producto interno
```

### 3.3 Estrategia de BÃºsqueda HÃ­brida

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BÃšSQUEDA HÃBRIDA (EMBEDDINGS + REGEX)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ESTRATEGIA: Usar embeddings como primario, regex como fallback        â”‚
â”‚                                                                         â”‚
â”‚  [Mensaje] â”€â”€â–º [Embedding Search]                                       â”‚
â”‚                      â”‚                                                  â”‚
â”‚                      â”œâ”€â”€ Si confidence > 0.85: âœ… Usar resultado       â”‚
â”‚                      â”‚                                                  â”‚
â”‚                      â”œâ”€â”€ Si 0.70 < confidence < 0.85: ğŸ”„ Verificar     â”‚
â”‚                      â”‚   â””â”€â”€ Ejecutar regex como validaciÃ³n            â”‚
â”‚                      â”‚   â””â”€â”€ Si regex confirma: âœ… Usar resultado      â”‚
â”‚                      â”‚   â””â”€â”€ Si regex contradice: âš ï¸ Revisar           â”‚
â”‚                      â”‚                                                  â”‚
â”‚                      â””â”€â”€ Si confidence < 0.70: ğŸ“¤ Fallback a regex     â”‚
â”‚                                                                         â”‚
â”‚  BENEFICIOS:                                                            â”‚
â”‚  â€¢ Mantiene compatibilidad con sistema actual                          â”‚
â”‚  â€¢ Rollback instantÃ¡neo si embeddings fallan                           â”‚
â”‚  â€¢ Mejora gradual de calidad                                           â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. MICROFASES DE IMPLEMENTACIÃ“N

### 4.1 Resumen de Microfases

| # | Microfase | DescripciÃ³n | DuraciÃ³n | Dependencia |
|---|-----------|-------------|----------|-------------|
| 2.1 | Embedding Service | Servicio de generaciÃ³n | 1 semana | - |
| 2.2 | Vector Store | Schema pgvector + Ã­ndices | 1 semana | 2.1 |
| 2.3 | Semantic Search | BÃºsqueda por similitud | 1.5 semanas | 2.2 |
| 2.4 | Pattern Migration | Migrar patrones existentes | 2 semanas | 2.3 |
| 2.5 | Testing | Tests E2E y benchmarks | 1.5 semanas | 2.4 |

### 4.2 Diagrama de Gantt

```
Semana:    1    2    3    4    5    6    7    8
           â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
2.1 Serviceâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                  â”‚
2.2 Vector       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                  â”‚    â”‚
2.3 Search       â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                  â”‚              â”‚
2.4 Migration    â”‚              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                  â”‚                        â”‚
2.5 Testing      â”‚                        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
                  â”‚                                  â”‚
           â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â–º Release
```

---

## 5. COSTOS ESTIMADOS

### 5.1 Costo de API

```yaml
OpenAI Embeddings:
  Precio: $0.00002 / 1K tokens
  Tokens promedio por mensaje: ~50 tokens
  Costo por mensaje: $0.000001

Escenarios:
  - 10,000 mensajes/dÃ­a: $0.01/dÃ­a = $0.30/mes
  - 100,000 mensajes/dÃ­a: $0.10/dÃ­a = $3.00/mes
  - 1,000,000 mensajes/dÃ­a: $1.00/dÃ­a = $30.00/mes

ConclusiÃ³n: Costo marginal, prÃ¡cticamente gratis
```

### 5.2 Costo de Storage

```yaml
pgvector Storage:
  Vector dimension: 1536
  Bytes per vector: 1536 * 4 = 6,144 bytes â‰ˆ 6KB
  Metadata overhead: ~500 bytes
  Total per row: ~7KB

Escenarios:
  - 100,000 embeddings: 700MB
  - 1,000,000 embeddings: 7GB
  - 10,000,000 embeddings: 70GB

Supabase Pro incluye: 8GB (suficiente para ~1M embeddings)
ConclusiÃ³n: Sin costo adicional en plan actual
```

---

## 6. RIESGOS Y MITIGACIONES

### 6.1 Matriz de Riesgos

| Riesgo | Prob. | Impacto | MitigaciÃ³n |
|--------|-------|---------|------------|
| OpenAI API down | Baja | Alto | Fallback a regex |
| Latencia alta | Media | Medio | CachÃ© de embeddings |
| Costo inesperado | Baja | Bajo | Rate limiting |
| Calidad embeddings | Baja | Medio | Testing exhaustivo |
| pgvector performance | Media | Medio | Ãndices optimizados |

### 6.2 Plan de Contingencia

```yaml
Si OpenAI no disponible:
  - Activar flag EMBEDDING_FALLBACK_TO_REGEX=true
  - Sistema continÃºa funcionando con regex
  - Alerta a equipo para investigar

Si latencia > 200ms:
  - Verificar Ã­ndices pgvector
  - Aumentar cachÃ© TTL
  - Considerar pre-computar embeddings en batch

Si costos exceden budget:
  - Implementar rate limiting mÃ¡s estricto
  - Reducir frecuencia de re-embedding
  - Considerar modelo mÃ¡s pequeÃ±o
```

---

## 7. CRITERIOS DE Ã‰XITO

### 7.1 KPIs de la Fase

| KPI | Baseline | Target | MÃ©todo |
|-----|----------|--------|--------|
| PrecisiÃ³n detecciÃ³n patrones | ~70% (regex) | >90% | Test set manual |
| Recall de patrones | ~60% (regex) | >85% | Test set manual |
| Latencia bÃºsqueda | N/A | <100ms p99 | Monitoring |
| Costo mensual API | N/A | <$50 | OpenAI dashboard |

### 7.2 Criterios de AceptaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CRITERIOS DE ACEPTACIÃ“N - FASE 2                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  âœ… FUNCIONALES:                                                        â”‚
â”‚  â”œâ”€â”€ [ ] Embeddings se generan para mensajes nuevos                    â”‚
â”‚  â”œâ”€â”€ [ ] BÃºsqueda semÃ¡ntica retorna resultados relevantes              â”‚
â”‚  â”œâ”€â”€ [ ] ClasificaciÃ³n de patrones funciona correctamente              â”‚
â”‚  â”œâ”€â”€ [ ] Fallback a regex cuando embeddings no disponibles             â”‚
â”‚  â””â”€â”€ [ ] Patrones existentes migrados a embeddings                     â”‚
â”‚                                                                         â”‚
â”‚  âœ… NO FUNCIONALES:                                                     â”‚
â”‚  â”œâ”€â”€ [ ] Latencia de embedding <100ms                                  â”‚
â”‚  â”œâ”€â”€ [ ] Latencia de bÃºsqueda <100ms                                   â”‚
â”‚  â”œâ”€â”€ [ ] pgvector Ã­ndice funcionando                                   â”‚
â”‚  â””â”€â”€ [ ] CachÃ© implementado y funcionando                              â”‚
â”‚                                                                         â”‚
â”‚  âœ… CALIDAD:                                                            â”‚
â”‚  â”œâ”€â”€ [ ] PrecisiÃ³n >90% en test set                                    â”‚
â”‚  â”œâ”€â”€ [ ] Recall >85% en test set                                       â”‚
â”‚  â””â”€â”€ [ ] Sin regresiones en sistema actual                             â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. ARCHIVOS A CREAR

```
src/features/ai/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ embeddings/
â”‚       â”œâ”€â”€ embedding.service.ts         # GeneraciÃ³n de embeddings
â”‚       â”œâ”€â”€ vector-store.service.ts      # Operaciones pgvector
â”‚       â”œâ”€â”€ semantic-search.service.ts   # BÃºsqueda semÃ¡ntica
â”‚       â”œâ”€â”€ pattern-classifier.service.ts # ClasificaciÃ³n
â”‚       â””â”€â”€ embedding-cache.service.ts   # CachÃ©
â”œâ”€â”€ types/
â”‚   â””â”€â”€ embeddings.types.ts              # Tipos TypeScript

supabase/migrations/
â””â”€â”€ 201_AI_LEARNING_EMBEDDINGS.sql       # Schema pgvector

scripts/
â””â”€â”€ migrate-patterns-to-embeddings.ts    # Script de migraciÃ³n
```

---

## 9. PRÃ“XIMOS PASOS

1. Revisar y aprobar este documento
2. Comenzar con [2.1-EMBEDDING-SERVICE.md](./2.1-EMBEDDING-SERVICE.md)

---

**Documentos de esta fase:**
- [2.1-EMBEDDING-SERVICE.md](./2.1-EMBEDDING-SERVICE.md) - Servicio de embeddings
- [2.2-VECTOR-STORE.md](./2.2-VECTOR-STORE.md) - Almacenamiento vectorial
- [2.3-SEMANTIC-SEARCH.md](./2.3-SEMANTIC-SEARCH.md) - BÃºsqueda semÃ¡ntica
- [2.4-PATTERN-MIGRATION.md](./2.4-PATTERN-MIGRATION.md) - MigraciÃ³n de patrones
- [2.5-TESTING.md](./2.5-TESTING.md) - Plan de testing
