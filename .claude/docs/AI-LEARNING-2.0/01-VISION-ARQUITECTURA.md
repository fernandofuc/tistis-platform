# ğŸ¯ TIS TIS AI LEARNING 2.0 - VISIÃ“N Y ARQUITECTURA

## Documento 01: VisiÃ³n General y Arquitectura Target

**VersiÃ³n:** 1.0.0
**Ãšltima actualizaciÃ³n:** Enero 2026
**Estado:** Aprobado para implementaciÃ³n

---

## 1. VISIÃ“N EJECUTIVA

### 1.1 DeclaraciÃ³n de VisiÃ³n

> **Transformar el sistema de "Pattern Analytics" actual en una plataforma de AI Learning real que aprenda continuamente de las interacciones, mejore automÃ¡ticamente sus respuestas basÃ¡ndose en feedback humano, y proporcione insights explicables y accionables a los usuarios de TIS TIS.**

### 1.2 Objetivos EstratÃ©gicos

| Objetivo | DescripciÃ³n | MÃ©trica de Ã‰xito |
|----------|-------------|------------------|
| **Aprendizaje Continuo** | El sistema mejora automÃ¡ticamente sin intervenciÃ³n manual | Mejora de satisfacciÃ³n >10% trimestral |
| **Feedback Loop** | Los usuarios contribuyen activamente a mejorar el AI | >30% de respuestas con feedback |
| **DetecciÃ³n SemÃ¡ntica** | DetecciÃ³n de patrones por significado, no solo regex | PrecisiÃ³n >90% |
| **Observabilidad** | Entender por quÃ© el AI toma cada decisiÃ³n | 100% decisiones explicables |
| **Proactividad** | Alertas automÃ¡ticas cuando el sistema degrada | DetecciÃ³n drift <24hrs |

### 1.3 Propuesta de Valor

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PROPUESTA DE VALOR AI LEARNING 2.0                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  PARA: DueÃ±os de negocios (dental, restaurantes, etc.)                 â”‚
â”‚                                                                         â”‚
â”‚  QUE: Necesitan un asistente AI que realmente aprenda de su negocio    â”‚
â”‚                                                                         â”‚
â”‚  NUESTRO PRODUCTO: AI Learning 2.0                                      â”‚
â”‚                                                                         â”‚
â”‚  PROPORCIONA:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. Respuestas que mejoran con el tiempo                         â”‚   â”‚
â”‚  â”‚ 2. Feedback simple (ğŸ‘/ğŸ‘) que entrena al AI                    â”‚   â”‚
â”‚  â”‚ 3. Insights que explican POR QUÃ‰ el AI tomÃ³ cada decisiÃ³n       â”‚   â”‚
â”‚  â”‚ 4. Alertas proactivas cuando algo cambia en el comportamiento   â”‚   â”‚
â”‚  â”‚ 5. DetecciÃ³n inteligente de patrones (no solo palabras clave)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  A DIFERENCIA DE: Sistemas que solo cuentan palabras clave              â”‚
â”‚                                                                         â”‚
â”‚  NUESTRO PRODUCTO: Aprende semÃ¡nticamente y mejora continuamente       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ARQUITECTURA ACTUAL (AS-IS)

### 2.1 Diagrama de Arquitectura Actual

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARQUITECTURA ACTUAL TIS TIS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  WhatsApp   â”‚    â”‚  Instagram  â”‚    â”‚   Voice     â”‚                 â”‚
â”‚  â”‚   Webhook   â”‚    â”‚   Webhook   â”‚    â”‚   Webhook   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                  â”‚                  â”‚                         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                            â”‚                                            â”‚
â”‚                            â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    MESSAGE PROCESSOR                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚ PII Sanitizer â”‚  â”‚ Rate Limiter  â”‚  â”‚ Queue Manager â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â”‚                  â”‚                  â”‚                         â”‚
â”‚         â–¼                  â–¼                  â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   REGEX     â”‚    â”‚   VOCAB     â”‚    â”‚  LANGGRAPH  â”‚                 â”‚
â”‚  â”‚  PATTERNS   â”‚    â”‚ EXTRACTION  â”‚    â”‚   AGENTS    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                  â”‚                  â”‚                         â”‚
â”‚         â–¼                  â–¼                  â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ ai_message  â”‚    â”‚ ai_learned  â”‚    â”‚  GPT-5 /    â”‚                 â”‚
â”‚  â”‚  _patterns  â”‚    â”‚ _vocabulary â”‚    â”‚   Gemini    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                  â”‚                  â”‚                         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                            â”‚                                            â”‚
â”‚                            â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                BUSINESS INSIGHTS (CRON cada 3 dÃ­as)              â”‚   â”‚
â”‚  â”‚                    Gemini 3.0 Analysis                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  ğŸ”´ PROBLEMAS:                                                          â”‚
â”‚  â€¢ Sin feedback loop (unidireccional)                                  â”‚
â”‚  â€¢ Regex limitado (no semÃ¡ntico)                                       â”‚
â”‚  â€¢ Sin drift detection                                                  â”‚
â”‚  â€¢ Sin explicabilidad                                                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Componentes Actuales

| Componente | Archivo | FunciÃ³n | LimitaciÃ³n |
|------------|---------|---------|------------|
| Pattern Extractor | `message-learning.service.ts` | Extrae patrones con regex | No semÃ¡ntico |
| Vocabulary Extractor | `message-learning.service.ts` | Extrae vocabulario por vertical | Sin contexto |
| Business Insights | `business-insights.service.ts` | Genera insights con Gemini | Sin feedback |
| LangGraph Agents | `tistis-graph.ts` | Orquesta agentes | Sin explicabilidad |
| Prompt Generator | `prompt-generator.service.ts` | Genera prompts | Sin optimizaciÃ³n automÃ¡tica |

---

## 3. ARQUITECTURA TARGET (TO-BE)

### 3.1 Diagrama de Arquitectura Target

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARQUITECTURA TARGET TIS TIS 2.0                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  WhatsApp   â”‚    â”‚  Instagram  â”‚    â”‚   Voice     â”‚                 â”‚
â”‚  â”‚   Webhook   â”‚    â”‚   Webhook   â”‚    â”‚   Webhook   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚                  â”‚                  â”‚                         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                            â”‚                                            â”‚
â”‚                            â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    MESSAGE PROCESSOR                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚  â”‚  â”‚ PII Sanitizer â”‚  â”‚ Rate Limiter  â”‚  â”‚ Queue Manager â”‚        â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â”‚                  â”‚                  â”‚                         â”‚
â”‚         â–¼                  â–¼                  â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚             ğŸ†• EMBEDDING SERVICE (FASE 2)                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  OpenAI text-embedding-3-small â†’ pgvector storage       â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â”‚                  â”‚                  â”‚                         â”‚
â”‚         â–¼                  â–¼                  â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  SEMANTIC   â”‚    â”‚  ğŸ†• FEATURE     â”‚    â”‚  LANGGRAPH  â”‚             â”‚
â”‚  â”‚   SEARCH    â”‚    â”‚     STORE       â”‚    â”‚   AGENTS    â”‚             â”‚
â”‚  â”‚  (FASE 2)   â”‚    â”‚    (FASE 4)     â”‚    â”‚  + ğŸ†• XAI   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                   â”‚                     â”‚                     â”‚
â”‚         â–¼                   â–¼                     â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ai_pattern  â”‚    â”‚ ai_feature      â”‚    â”‚  GPT-5 /    â”‚             â”‚
â”‚  â”‚ _embeddings â”‚    â”‚ _store          â”‚    â”‚   Gemini    â”‚             â”‚
â”‚  â”‚ (pgvector)  â”‚    â”‚ (versioned)     â”‚    â”‚             â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                   â”‚                     â”‚
â”‚                                                   â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚               ğŸ†• RESPONSE + FEEDBACK (FASE 1)                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚  â”‚  Response   â”‚ â†’  â”‚  ğŸ‘ / ğŸ‘    â”‚ â†’  â”‚  ai_rlhf    â”‚          â”‚   â”‚
â”‚  â”‚  â”‚  to User    â”‚    â”‚  Feedback   â”‚    â”‚  _feedback  â”‚          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                  â”‚                      â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                            â”‚                                            â”‚
â”‚                            â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚               ğŸ†• RLHF AGGREGATOR (FASE 1)                        â”‚   â”‚
â”‚  â”‚  â€¢ Agrupa feedback por intent/agente                            â”‚   â”‚
â”‚  â”‚  â€¢ Calcula mÃ©tricas de satisfacciÃ³n                             â”‚   â”‚
â”‚  â”‚  â€¢ Detecta patterns problemÃ¡ticos                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                            â”‚
â”‚                            â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚               ğŸ†• PROMPT OPTIMIZER (FASE 1)                       â”‚   â”‚
â”‚  â”‚  â€¢ Ajusta prompts basado en feedback                            â”‚   â”‚
â”‚  â”‚  â€¢ A/B testing automÃ¡tico                                        â”‚   â”‚
â”‚  â”‚  â€¢ Rollback automÃ¡tico si degrada                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â”‚                  â”‚                  â”‚                         â”‚
â”‚         â–¼                  â–¼                  â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ ğŸ†• DRIFT    â”‚    â”‚  BUSINESS   â”‚    â”‚ ğŸ†• FINE-    â”‚                 â”‚
â”‚  â”‚  DETECTOR   â”‚    â”‚  INSIGHTS   â”‚    â”‚   TUNING    â”‚                 â”‚
â”‚  â”‚  (FASE 3)   â”‚    â”‚  (enhanced) â”‚    â”‚  (FASE 5)   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                         â”‚
â”‚  ğŸŸ¢ MEJORAS:                                                            â”‚
â”‚  â€¢ Feedback loop completo (bidireccional)                              â”‚
â”‚  â€¢ Embeddings semÃ¡nticos                                               â”‚
â”‚  â€¢ Drift detection proactivo                                           â”‚
â”‚  â€¢ Explicabilidad (XAI)                                                â”‚
â”‚  â€¢ Auto-optimizaciÃ³n de prompts                                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Nuevos Componentes

| Componente | Fase | FunciÃ³n | TecnologÃ­a |
|------------|------|---------|------------|
| **RLHF Feedback Capture** | 1 | Captura thumbs up/down | API + UI |
| **RLHF Aggregator** | 1 | Agrega y analiza feedback | Batch job |
| **Prompt Optimizer** | 1 | Ajusta prompts automÃ¡ticamente | LLM-based |
| **Embedding Service** | 2 | Genera embeddings de mensajes | OpenAI API |
| **Vector Store** | 2 | Almacena embeddings | pgvector |
| **Semantic Search** | 2 | Busca por similitud | Cosine similarity |
| **Drift Detector** | 3 | Detecta cambios en distribuciÃ³n | Statistics |
| **Feature Store** | 4 | Almacena features versionadas | PostgreSQL |
| **Fine-tuning Pipeline** | 5 | Entrena modelo propio | HuggingFace |
| **XAI Logger** | 6 | Registra decisiones con explicaciÃ³n | PostgreSQL |

---

## 4. FLUJOS DE DATOS TARGET

### 4.1 Flujo de Feedback (RLHF)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUJO DE FEEDBACK (FASE 1)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. CAPTURA DE FEEDBACK                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚                                                                         â”‚
â”‚  [Respuesta AI] â”€â”€â–º [UI: ğŸ‘ / ğŸ‘] â”€â”€â–º [POST /api/rlhf/feedback]        â”‚
â”‚                          â”‚                      â”‚                       â”‚
â”‚                          â”‚                      â–¼                       â”‚
â”‚                          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                          â”‚         â”‚ {                       â”‚          â”‚
â”‚                          â”‚         â”‚   message_id: uuid,     â”‚          â”‚
â”‚                          â”‚         â”‚   rating: 'up' | 'down',â”‚          â”‚
â”‚                          â”‚         â”‚   feedback_text?: str,  â”‚          â”‚
â”‚                          â”‚         â”‚   context: {...}        â”‚          â”‚
â”‚                          â”‚         â”‚ }                       â”‚          â”‚
â”‚                          â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                          â”‚                      â”‚                       â”‚
â”‚                          â”‚                      â–¼                       â”‚
â”‚                          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                          â”‚         â”‚   ai_rlhf_feedback      â”‚          â”‚
â”‚                          â”‚         â”‚   (tabla PostgreSQL)    â”‚          â”‚
â”‚                          â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                         â”‚
â”‚  2. AGREGACIÃ“N (CRON semanal)                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”‚
â”‚                                                                         â”‚
â”‚  [ai_rlhf_feedback] â”€â”€â–º [Aggregator Service]                           â”‚
â”‚                                â”‚                                        â”‚
â”‚                                â–¼                                        â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                    â”‚ Por cada (tenant, intent):    â”‚                    â”‚
â”‚                    â”‚ â€¢ total_responses             â”‚                    â”‚
â”‚                    â”‚ â€¢ positive_count              â”‚                    â”‚
â”‚                    â”‚ â€¢ negative_count              â”‚                    â”‚
â”‚                    â”‚ â€¢ satisfaction_rate           â”‚                    â”‚
â”‚                    â”‚ â€¢ common_negative_patterns    â”‚                    â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                â”‚                                        â”‚
â”‚                                â–¼                                        â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                    â”‚   ai_rlhf_aggregated         â”‚                    â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                         â”‚
â”‚  3. OPTIMIZACIÃ“N DE PROMPTS                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚                                                                         â”‚
â”‚  [ai_rlhf_aggregated] â”€â”€â–º [Prompt Optimizer]                           â”‚
â”‚                                â”‚                                        â”‚
â”‚                                â–¼                                        â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                    â”‚ Si satisfaction_rate < 80%:   â”‚                    â”‚
â”‚                    â”‚ â€¢ Analiza negative_patterns   â”‚                    â”‚
â”‚                    â”‚ â€¢ Genera prompt modificado    â”‚                    â”‚
â”‚                    â”‚ â€¢ Activa A/B test             â”‚                    â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                â”‚                                        â”‚
â”‚                                â–¼                                        â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                    â”‚   ai_prompt_experiments      â”‚                    â”‚
â”‚                    â”‚   (A/B testing)              â”‚                    â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Flujo de Embeddings

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUJO DE EMBEDDINGS (FASE 2)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. GENERACIÃ“N DE EMBEDDING                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚                                                                         â”‚
â”‚  [Mensaje] â”€â”€â–º [Embedding Service]                                      â”‚
â”‚                      â”‚                                                  â”‚
â”‚                      â–¼                                                  â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚            â”‚ OpenAI text-embedding-3-small       â”‚                      â”‚
â”‚            â”‚ â€¢ DimensiÃ³n: 1536                   â”‚                      â”‚
â”‚            â”‚ â€¢ Latencia: ~50ms                   â”‚                      â”‚
â”‚            â”‚ â€¢ Costo: $0.00002/1K tokens         â”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                      â”‚                                                  â”‚
â”‚                      â–¼                                                  â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚            â”‚ Vector [1536 dimensions]            â”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                      â”‚                                                  â”‚
â”‚                      â–¼                                                  â”‚
â”‚  2. ALMACENAMIENTO EN PGVECTOR                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚                                                                         â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚            â”‚ ai_message_embeddings               â”‚                      â”‚
â”‚            â”‚ â”œâ”€â”€ id: uuid                        â”‚                      â”‚
â”‚            â”‚ â”œâ”€â”€ tenant_id: uuid                 â”‚                      â”‚
â”‚            â”‚ â”œâ”€â”€ message_content: text           â”‚                      â”‚
â”‚            â”‚ â”œâ”€â”€ embedding: vector(1536)         â”‚                      â”‚
â”‚            â”‚ â”œâ”€â”€ metadata: jsonb                 â”‚                      â”‚
â”‚            â”‚ â””â”€â”€ created_at: timestamp           â”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                         â”‚
â”‚  3. BÃšSQUEDA SEMÃNTICA                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚                                                                         â”‚
â”‚  [Query: "me duele la muela"] â”€â”€â–º [Embedding] â”€â”€â–º [pgvector search]    â”‚
â”‚                                                          â”‚              â”‚
â”‚                                                          â–¼              â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                    â”‚ SELECT * FROM ai_message_embeds â”‚  â”‚
â”‚                                    â”‚ ORDER BY embedding <=> $1       â”‚  â”‚
â”‚                                    â”‚ LIMIT 10;                       â”‚  â”‚
â”‚                                    â”‚                                 â”‚  â”‚
â”‚                                    â”‚ Resultados similares:           â”‚  â”‚
â”‚                                    â”‚ â€¢ "tengo dolor de muelas" 0.92  â”‚  â”‚
â”‚                                    â”‚ â€¢ "muela del juicio duele" 0.89 â”‚  â”‚
â”‚                                    â”‚ â€¢ "dolor dental fuerte" 0.87    â”‚  â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  4. CLASIFICACIÃ“N DE PATRONES                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚                                                                         â”‚
â”‚  [Similar Messages] â”€â”€â–º [Cluster Analysis] â”€â”€â–º [Pattern Classification]â”‚
â”‚                                                          â”‚              â”‚
â”‚                                                          â–¼              â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                                    â”‚ Pattern: "pain_point"           â”‚  â”‚
â”‚                                    â”‚ Confidence: 0.94                â”‚  â”‚
â”‚                                    â”‚ Evidence: ["me duele", "dolor"] â”‚  â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Flujo de Drift Detection

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUJO DE DRIFT DETECTION (FASE 3)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. RECOLECCIÃ“N DE MÃ‰TRICAS (Continuo)                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚                                                                         â”‚
â”‚  [Messages/Patterns] â”€â”€â–º [Metrics Collector]                            â”‚
â”‚                                â”‚                                        â”‚
â”‚                                â–¼                                        â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚            â”‚ MÃ©tricas recolectadas:              â”‚                      â”‚
â”‚            â”‚ â€¢ distribution_by_intent            â”‚                      â”‚
â”‚            â”‚ â€¢ distribution_by_pattern_type      â”‚                      â”‚
â”‚            â”‚ â€¢ avg_confidence_scores             â”‚                      â”‚
â”‚            â”‚ â€¢ response_times                    â”‚                      â”‚
â”‚            â”‚ â€¢ feedback_rates                    â”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                â”‚                                        â”‚
â”‚                                â–¼                                        â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚            â”‚   ai_drift_metrics                  â”‚                      â”‚
â”‚            â”‚   (time-series data)                â”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                         â”‚
â”‚  2. ANÃLISIS ESTADÃSTICO (CRON diario)                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚                                                                         â”‚
â”‚  [ai_drift_metrics] â”€â”€â–º [Statistical Analysis]                          â”‚
â”‚                                â”‚                                        â”‚
â”‚                                â–¼                                        â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚            â”‚ Tests aplicados:                    â”‚                      â”‚
â”‚            â”‚ â€¢ Kolmogorov-Smirnov (distribuciÃ³n) â”‚                      â”‚
â”‚            â”‚ â€¢ Chi-square (categorical)          â”‚                      â”‚
â”‚            â”‚ â€¢ Moving average comparison         â”‚                      â”‚
â”‚            â”‚ â€¢ Z-score para outliers             â”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                â”‚                                        â”‚
â”‚                                â–¼                                        â”‚
â”‚  3. DETECCIÃ“N Y ALERTAS                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                â”‚
â”‚                                                                         â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚            â”‚ IF drift_score > threshold:         â”‚                      â”‚
â”‚            â”‚ â”œâ”€â”€ Create alert                    â”‚                      â”‚
â”‚            â”‚ â”œâ”€â”€ Notify admin                    â”‚                      â”‚
â”‚            â”‚ â”œâ”€â”€ Log to ai_drift_events          â”‚                      â”‚
â”‚            â”‚ â””â”€â”€ Trigger investigation           â”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                â”‚                                        â”‚
â”‚                                â–¼                                        â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚            â”‚ Alert Types:                        â”‚                      â”‚
â”‚            â”‚ â€¢ DATA_DRIFT: Input distribution    â”‚                      â”‚
â”‚            â”‚ â€¢ CONCEPT_DRIFT: Pattern meaning    â”‚                      â”‚
â”‚            â”‚ â€¢ PERFORMANCE_DRIFT: Accuracy drop  â”‚                      â”‚
â”‚            â”‚ â€¢ FEEDBACK_DRIFT: Satisfaction drop â”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. MODELO DE DATOS TARGET

### 5.1 Nuevas Tablas

```sql
-- =====================================================
-- FASE 1: RLHF
-- =====================================================

-- Feedback individual de cada respuesta
CREATE TABLE ai_rlhf_feedback (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    message_id UUID NOT NULL REFERENCES messages(id),
    conversation_id UUID NOT NULL REFERENCES conversations(id),
    lead_id UUID REFERENCES leads(id),

    -- Feedback data
    rating VARCHAR(10) NOT NULL CHECK (rating IN ('up', 'down')),
    feedback_text TEXT,
    feedback_category VARCHAR(50), -- 'wrong_info', 'rude', 'helpful', etc.

    -- Context at time of feedback
    intent_detected VARCHAR(50),
    agent_used VARCHAR(50),
    response_text TEXT,
    confidence_score DECIMAL(3,2),

    -- Metadata
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    user_agent TEXT,

    -- Indexes
    CONSTRAINT fk_tenant FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);

-- MÃ©tricas agregadas por perÃ­odo
CREATE TABLE ai_rlhf_aggregated (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),

    -- PerÃ­odo de agregaciÃ³n
    period_start TIMESTAMP WITH TIME ZONE NOT NULL,
    period_end TIMESTAMP WITH TIME ZONE NOT NULL,

    -- Dimensiones
    intent VARCHAR(50),
    agent VARCHAR(50),

    -- MÃ©tricas
    total_responses INTEGER NOT NULL DEFAULT 0,
    positive_count INTEGER NOT NULL DEFAULT 0,
    negative_count INTEGER NOT NULL DEFAULT 0,
    satisfaction_rate DECIMAL(5,4),

    -- AnÃ¡lisis de patrones negativos
    negative_patterns JSONB, -- [{pattern: "...", count: N}]
    improvement_suggestions JSONB,

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Experimentos de prompts (A/B testing)
CREATE TABLE ai_prompt_experiments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),

    -- ConfiguraciÃ³n del experimento
    experiment_name VARCHAR(100) NOT NULL,
    intent_target VARCHAR(50),
    agent_target VARCHAR(50),

    -- Variantes
    control_prompt TEXT NOT NULL,
    variant_prompt TEXT NOT NULL,

    -- Estado
    status VARCHAR(20) DEFAULT 'draft', -- draft, running, completed, aborted
    traffic_split DECIMAL(3,2) DEFAULT 0.50, -- % que va a variant

    -- Resultados
    control_responses INTEGER DEFAULT 0,
    control_positive INTEGER DEFAULT 0,
    variant_responses INTEGER DEFAULT 0,
    variant_positive INTEGER DEFAULT 0,
    statistical_significance DECIMAL(5,4),

    -- Fechas
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =====================================================
-- FASE 2: EMBEDDINGS
-- =====================================================

-- Habilitar pgvector
CREATE EXTENSION IF NOT EXISTS vector;

-- Embeddings de mensajes
CREATE TABLE ai_message_embeddings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    message_id UUID REFERENCES messages(id),

    -- Contenido
    content_text TEXT NOT NULL,
    content_hash VARCHAR(64) NOT NULL, -- SHA-256 para dedup

    -- Embedding
    embedding vector(1536) NOT NULL, -- OpenAI dimension

    -- Metadata
    model_version VARCHAR(50) DEFAULT 'text-embedding-3-small',
    vertical VARCHAR(50),
    detected_patterns JSONB,

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- Ãndice para bÃºsqueda vectorial
    CONSTRAINT unique_content_per_tenant UNIQUE (tenant_id, content_hash)
);

-- Ãndice IVFFlat para bÃºsqueda aproximada eficiente
CREATE INDEX ON ai_message_embeddings
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- =====================================================
-- FASE 3: DRIFT DETECTION
-- =====================================================

-- MÃ©tricas de drift (time-series)
CREATE TABLE ai_drift_metrics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),

    -- Timestamp del snapshot
    snapshot_at TIMESTAMP WITH TIME ZONE NOT NULL,

    -- Distribuciones
    intent_distribution JSONB NOT NULL, -- {GREETING: 0.15, BOOKING: 0.30, ...}
    pattern_distribution JSONB NOT NULL,
    confidence_distribution JSONB NOT NULL,

    -- MÃ©tricas de performance
    avg_response_time_ms INTEGER,
    avg_confidence DECIMAL(5,4),
    escalation_rate DECIMAL(5,4),

    -- Feedback metrics (si disponible)
    feedback_rate DECIMAL(5,4),
    satisfaction_rate DECIMAL(5,4),

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Eventos de drift detectados
CREATE TABLE ai_drift_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),

    -- Tipo de drift
    drift_type VARCHAR(30) NOT NULL, -- DATA_DRIFT, CONCEPT_DRIFT, PERFORMANCE_DRIFT
    severity VARCHAR(20) NOT NULL, -- low, medium, high, critical

    -- Detalles
    metric_name VARCHAR(50) NOT NULL,
    baseline_value DECIMAL(10,4),
    current_value DECIMAL(10,4),
    drift_score DECIMAL(5,4),

    -- Contexto
    detection_method VARCHAR(50), -- KS_TEST, CHI_SQUARE, Z_SCORE
    evidence JSONB,

    -- ResoluciÃ³n
    status VARCHAR(20) DEFAULT 'open', -- open, acknowledged, resolved, false_positive
    resolved_at TIMESTAMP WITH TIME ZONE,
    resolution_notes TEXT,

    detected_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =====================================================
-- FASE 4: FEATURE STORE
-- =====================================================

-- Features computadas
CREATE TABLE ai_feature_store (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),

    -- IdentificaciÃ³n de feature
    feature_name VARCHAR(100) NOT NULL,
    feature_version INTEGER NOT NULL DEFAULT 1,
    entity_type VARCHAR(50) NOT NULL, -- 'lead', 'conversation', 'tenant'
    entity_id UUID,

    -- Valor de la feature
    feature_value JSONB NOT NULL,

    -- Metadata
    computed_at TIMESTAMP WITH TIME ZONE NOT NULL,
    valid_from TIMESTAMP WITH TIME ZONE NOT NULL,
    valid_to TIMESTAMP WITH TIME ZONE,

    -- Linaje
    source_tables JSONB, -- ['messages', 'patterns']
    computation_hash VARCHAR(64),

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    CONSTRAINT unique_feature_version UNIQUE (tenant_id, feature_name, feature_version, entity_id)
);

-- =====================================================
-- FASE 6: XAI (Explicabilidad)
-- =====================================================

-- Log de decisiones con explicaciones
CREATE TABLE ai_decision_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id),
    message_id UUID REFERENCES messages(id),
    conversation_id UUID REFERENCES conversations(id),

    -- DecisiÃ³n tomada
    decision_type VARCHAR(50) NOT NULL, -- 'routing', 'intent', 'response', 'escalation'
    decision_value VARCHAR(100) NOT NULL,

    -- ExplicaciÃ³n
    confidence DECIMAL(5,4),
    explanation TEXT NOT NULL,
    evidence JSONB NOT NULL, -- [{type: 'keyword', value: '...', weight: 0.3}]

    -- Alternativas consideradas
    alternatives JSONB, -- [{value: '...', confidence: 0.2, reason: '...'}]

    -- Contexto
    input_summary TEXT,
    model_version VARCHAR(50),

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## 6. PRINCIPIOS DE DISEÃ‘O

### 6.1 Principios Fundamentales

| # | Principio | DescripciÃ³n | ImplicaciÃ³n |
|---|-----------|-------------|-------------|
| 1 | **Privacy First** | Los datos del usuario siempre sanitizados | PII nunca en embeddings |
| 2 | **Tenant Isolation** | Cada tenant completamente aislado | No cross-tenant learning |
| 3 | **Graceful Degradation** | Si falla nuevo sistema, usa fallback | Regex como backup |
| 4 | **Explainability** | Toda decisiÃ³n debe ser explicable | Log de evidencia |
| 5 | **Reversibility** | Cualquier cambio debe ser reversible | Feature flags + rollback |
| 6 | **Cost Awareness** | Monitorear costos de APIs | Rate limits + caching |

### 6.2 Patrones de DiseÃ±o a Usar

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PATRONES DE DISEÃ‘O                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  1. CIRCUIT BREAKER                                                     â”‚
â”‚     â””â”€â”€ Para llamadas a OpenAI/Gemini                                  â”‚
â”‚     â””â”€â”€ Fallback a regex si API falla                                  â”‚
â”‚                                                                         â”‚
â”‚  2. CQRS (Command Query Responsibility Segregation)                     â”‚
â”‚     â””â”€â”€ Write: Captura feedback inmediato                              â”‚
â”‚     â””â”€â”€ Read: Queries de mÃ©tricas agregadas                            â”‚
â”‚                                                                         â”‚
â”‚  3. EVENT SOURCING (para RLHF)                                          â”‚
â”‚     â””â”€â”€ Guardar cada feedback como evento                              â”‚
â”‚     â””â”€â”€ Reconstruir estado agregando eventos                           â”‚
â”‚                                                                         â”‚
â”‚  4. STRATEGY PATTERN (para bÃºsqueda)                                    â”‚
â”‚     â””â”€â”€ RegexStrategy (actual)                                         â”‚
â”‚     â””â”€â”€ EmbeddingStrategy (nuevo)                                      â”‚
â”‚     â””â”€â”€ HybridStrategy (combina ambos)                                 â”‚
â”‚                                                                         â”‚
â”‚  5. FEATURE FLAGS                                                       â”‚
â”‚     â””â”€â”€ Habilitar/deshabilitar por tenant                              â”‚
â”‚     â””â”€â”€ Rollout gradual                                                â”‚
â”‚                                                                         â”‚
â”‚  6. OBSERVER PATTERN (para drift)                                       â”‚
â”‚     â””â”€â”€ MÃ©tricas observan cambios                                      â”‚
â”‚     â””â”€â”€ Alertas se disparan automÃ¡ticamente                            â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. CONSIDERACIONES DE SEGURIDAD

### 7.1 Seguridad de Datos

| Ãrea | Riesgo | MitigaciÃ³n |
|------|--------|------------|
| Embeddings | PII en vectores | Sanitizar ANTES de embedding |
| Feedback | ManipulaciÃ³n | Rate limit + validaciÃ³n |
| Prompts | Injection | SanitizaciÃ³n existente |
| Cross-tenant | Data leak | Isolation por tenant_id |

### 7.2 Seguridad de APIs

```yaml
Rate Limits:
  embedding_api:
    per_tenant: 1000/hora
    burst: 50/minuto

  feedback_api:
    per_lead: 10/hora
    per_conversation: 5/hora

  drift_api:
    per_tenant: 100/dÃ­a

Authentication:
  - Bearer token (existente)
  - Tenant validation (existente)

Audit:
  - Log todas las decisiones
  - RetenciÃ³n: 90 dÃ­as
```

---

## 8. PLAN DE ROLLBACK

### 8.1 Estrategia de Rollback por Fase

| Fase | Rollback Strategy | Tiempo Estimado |
|------|-------------------|-----------------|
| RLHF | Deshabilitar UI, ignorar feedback | < 5 min |
| Embeddings | Fallback a regex patterns | < 1 min |
| Drift | Deshabilitar alertas | < 1 min |
| Feature Store | Usar queries directos | < 5 min |
| Fine-tuning | Revertir a GPT-5 | < 1 min |
| XAI | Deshabilitar logging | < 1 min |

### 8.2 Feature Flags

```typescript
// ConfiguraciÃ³n de feature flags
interface AILearning2Config {
  rlhf_enabled: boolean;
  rlhf_ui_variant: 'simple' | 'detailed' | 'off';

  embeddings_enabled: boolean;
  embeddings_fallback_to_regex: boolean;

  drift_detection_enabled: boolean;
  drift_alert_threshold: number;

  feature_store_enabled: boolean;

  finetuned_model_enabled: boolean;
  finetuned_model_traffic_pct: number;

  xai_logging_enabled: boolean;
}
```

---

**Siguiente documento:** [02-ESTADO-ACTUAL-VS-TARGET.md](./02-ESTADO-ACTUAL-VS-TARGET.md)
